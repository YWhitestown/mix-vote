<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mix Vote - Next Gen Voting</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <style id="theme-style">
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&family=Noto+Sans+JP:wght@400;700&display=swap');
        
        :root {
            --accent: #06b6d4;
            --accent-glow: rgba(6, 182, 212, 0.4);
            --bg-dark: #020617;
            --text-main: #f1f5f9;
        }

        body { 
            font-family: 'Plus Jakarta Sans', 'Noto Sans JP', sans-serif; 
            background-color: var(--bg-dark); 
            color: var(--text-main);
            overflow-x: hidden;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .text-white { color: var(--text-main) !important; }
        .bg-cyan-500 { background-color: var(--accent) !important; }
        .text-cyan-400, .text-cyan-500 { color: var(--accent) !important; }
        .border-cyan-500, .border-cyan-500\/20 { border-color: var(--accent) !important; }

        .glass { 
            background: rgba(15, 23, 42, 0.7); 
            backdrop-filter: blur(24px); 
            border: 1px solid rgba(255, 255, 255, 0.08); 
        }

        .glass-panel {
            background: linear-gradient(145deg, rgba(30, 41, 59, 0.4), rgba(15, 23, 42, 0.6));
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .poll-card {
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .poll-card:hover {
            transform: translateY(-4px);
            border-color: var(--accent) !important;
            box-shadow: 0 20px 40px -20px var(--accent-glow);
        }

        .btn-glow {
            position: relative;
            overflow: hidden;
            transition: all 0.3s;
        }
        .btn-glow::after {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255,255,255,0.2), transparent);
            transform: rotate(45deg);
            transition: 0.6s;
        }
        .btn-glow:hover::after { left: 120%; }

        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: rgba(255,255,255,0.02); }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
        
        .nav-link.active {
            background: var(--accent) !important;
            color: var(--bg-dark) !important;
            box-shadow: 0 10px 20px -5px var(--accent-glow);
            border: none;
        }

        input[type="checkbox"] {
            accent-color: var(--accent);
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade { animation: fadeIn 0.5s ease forwards; }
    </style>
</head>
<body class="min-h-screen selection:bg-cyan-500 selection:text-slate-900">

    <!-- 認証ガードレイヤー -->
    <div id="loadingLayer" class="fixed inset-0 z-[300] bg-slate-950 flex flex-col items-center justify-center gap-4">
        <div class="w-12 h-12 border-4 border-cyan-500 border-t-transparent rounded-full animate-spin"></div>
        <p id="loadingText" class="text-[10px] font-black uppercase tracking-[0.3em] text-cyan-500">Initializing Core</p>
        <button id="initRetryBtn" class="hidden px-4 py-2 mt-4 text-[10px] bg-white/10 text-white rounded-lg hover:bg-white/20">再試行</button>
    </div>

    <!-- 利用規約モーダル -->
    <div id="tosModal" class="fixed inset-0 z-[250] hidden flex items-center justify-center bg-black/95 backdrop-blur-xl p-4">
        <div class="glass max-w-xl w-full rounded-3xl p-8 shadow-2xl border border-cyan-500/20">
            <div class="flex items-center gap-4 mb-8">
                <div class="w-12 h-12 bg-gradient-to-br from-cyan-400 to-blue-600 rounded-xl flex items-center justify-center shadow-lg text-slate-950">
                    <i class="fas fa-shield-halved text-xl"></i>
                </div>
                <div>
                    <h2 class="text-2xl font-black text-white uppercase italic" data-t="tos_title">Community Rules</h2>
                    <p class="text-[10px] text-slate-400 font-bold uppercase tracking-widest">Growth Edition v2.5</p>
                </div>
            </div>
            <div class="space-y-4 max-h-[40vh] overflow-y-auto pr-2 custom-scrollbar text-sm text-slate-300 leading-relaxed">
                <div class="bg-white/5 p-4 rounded-2xl border border-white/5">
                    <h4 class="font-bold text-cyan-400 mb-2 flex items-center gap-2 text-xs uppercase tracking-wider" data-t="tos_rule1_title"><i class="fas fa-handshake"></i> Respectful Discourse</h4>
                    <p class="text-xs" data-t="tos_rule1_body">意見の相違を楽しみましょう。誹謗中傷、差別、攻撃的な内容は厳格に禁止されます。</p>
                </div>
                <div class="bg-white/5 p-4 rounded-2xl border border-white/5">
                    <h4 class="font-bold text-cyan-400 mb-2 flex items-center gap-2 text-xs uppercase tracking-wider" data-t="tos_rule2_title"><i class="fas fa-fingerprint"></i> Fairness First</h4>
                    <p class="text-xs" data-t="tos_rule2_body">一人一票の原則を守りましょう。不正な操作やスパム投票はシステムにより自動検知されます。</p>
                </div>
            </div>
            <button id="agreeTosBtn" class="btn-glow w-full mt-8 bg-gradient-to-r from-cyan-500 to-blue-600 text-slate-950 font-black py-4 rounded-xl transition-all shadow-lg active:scale-95 uppercase tracking-widest text-xs" data-t="tos_accept">
                同意する
            </button>
        </div>
    </div>

    <!-- UIフィードバックモーダル -->
    <div id="msgModal" class="fixed inset-0 z-[400] hidden flex items-center justify-center bg-black/80 backdrop-blur-sm p-4">
        <div class="glass max-w-sm w-full rounded-3xl p-8 text-center border border-white/10 shadow-2xl relative overflow-hidden">
            <h3 id="msgTitle" class="text-lg font-black mb-2 uppercase tracking-widest italic text-white">Message</h3>
            <p id="msgBody" class="text-slate-400 text-xs mb-8 leading-relaxed"></p>
            <div id="msgActions" class="flex flex-col gap-3">
                <div class="flex gap-3">
                    <button id="msgCloseBtn" class="flex-1 bg-white/5 text-white font-bold py-3 rounded-xl uppercase text-[10px] tracking-widest hover:bg-white/10 transition-colors" data-t="btn_close">Close</button>
                    <button id="msgConfirmBtn" class="flex-1 bg-cyan-500 text-slate-950 font-black py-3 rounded-xl uppercase text-[10px] tracking-widest hidden hover:bg-cyan-400 transition-colors" data-t="btn_confirm">Confirm</button>
                </div>
                <div id="extraActions" class="hidden flex flex-col gap-3 pt-3 border-t border-white/5">
                    <button id="msgArchiveBtn" class="w-full bg-indigo-500/20 text-indigo-400 font-bold py-3 rounded-xl uppercase text-[10px] tracking-widest hover:bg-indigo-500/30 transition-colors" data-t="btn_archive_only">Move to Archive</button>
                    <button id="msgDeletePermanentBtn" class="w-full bg-red-500 text-white font-black py-3 rounded-xl uppercase text-[10px] tracking-widest hover:bg-red-600 transition-colors" data-t="btn_delete_permanent">Permanent Delete</button>
                </div>
            </div>
        </div>
    </div>

    <!-- テーマカスタマイズモーダル -->
    <div id="themeModal" class="fixed inset-0 z-[400] hidden flex items-center justify-center bg-black/80 backdrop-blur-md p-4">
        <div class="glass max-w-sm w-full rounded-3xl p-8 border border-white/10 shadow-2xl">
            <h3 class="text-lg font-black mb-6 uppercase tracking-widest italic text-white" data-t="theme_title">Customize Appearance</h3>
            <div class="space-y-6">
                <div class="flex items-center justify-between">
                    <label class="text-[10px] font-black uppercase tracking-widest text-slate-400" data-t="theme_accent">Accent Color</label>
                    <input type="color" id="themeAccentInput" class="w-10 h-10 rounded-lg bg-transparent border-none cursor-pointer">
                </div>
                <div class="flex items-center justify-between">
                    <label class="text-[10px] font-black uppercase tracking-widest text-slate-400" data-t="theme_bg">Background Color</label>
                    <input type="color" id="themeBgInput" class="w-10 h-10 rounded-lg bg-transparent border-none cursor-pointer">
                </div>
                <div class="flex items-center justify-between">
                    <label class="text-[10px] font-black uppercase tracking-widest text-slate-400" data-t="theme_text">Text Color</label>
                    <input type="color" id="themeTextInput" class="w-10 h-10 rounded-lg bg-transparent border-none cursor-pointer">
                </div>
            </div>
            <div class="flex flex-col gap-3 mt-10">
                <button id="resetThemeBtn" class="w-full bg-white/5 text-white font-bold py-3 rounded-xl uppercase text-[10px] tracking-widest hover:bg-white/10 transition-colors border border-white/10" data-t="btn_reset_theme">Reset to Default</button>
                <button onclick="document.getElementById('themeModal').classList.add('hidden')" class="w-full bg-cyan-500 text-slate-950 font-black py-3 rounded-xl uppercase text-[10px] tracking-widest transition-all" data-t="btn_close">Save & Close</button>
            </div>
        </div>
    </div>

    <!-- メインコンテンツ -->
    <div id="appUI" class="hidden flex flex-col min-h-screen">
        <header class="sticky top-0 z-50 glass border-b border-white/5 px-6 py-4">
            <div class="max-w-7xl mx-auto flex items-center justify-between gap-6">
                <div class="flex items-center gap-3 cursor-pointer group shrink-0" onclick="goHome()">
                    <div class="w-10 h-10 bg-gradient-to-br from-cyan-400 to-blue-600 rounded-xl flex items-center justify-center shadow-lg group-hover:rotate-12 transition-transform text-slate-950">
                        <i class="fas fa-bolt-lightning"></i>
                    </div>
                    <div class="hidden md:block">
                        <h1 class="text-xl font-black tracking-tighter text-white uppercase italic">Mix <span class="text-cyan-400">Vote</span></h1>
                        <p class="text-[8px] text-slate-500 font-bold uppercase tracking-[0.3em] leading-none">Growth v2.5</p>
                    </div>
                </div>

                <div class="flex-1 max-w-xl relative">
                    <input type="text" id="globalSearch" class="w-full bg-slate-950/50 border border-white/10 rounded-2xl py-2.5 pl-10 pr-4 text-xs text-white outline-none focus:border-cyan-500 focus:bg-slate-950 transition-all placeholder:text-slate-600" data-t-placeholder="search_placeholder">
                    <i class="fas fa-search absolute left-3.5 top-1/2 -translate-y-1/2 text-slate-600 text-xs"></i>
                </div>

                <div id="authArea" class="flex items-center gap-4">
                    <div class="flex items-center gap-2">
                        <button onclick="document.getElementById('themeModal').classList.remove('hidden')" class="w-9 h-9 rounded-xl bg-white/5 border border-white/10 flex items-center justify-center text-slate-400 hover:text-white transition-colors" title="Customize Theme">
                            <i class="fas fa-palette text-sm"></i>
                        </button>
                        <div class="flex bg-slate-950/50 border border-white/10 rounded-xl p-1 shrink-0">
                            <button onclick="switchLang('ja')" id="lang-ja" class="px-3 py-1.5 rounded-lg text-[9px] font-black uppercase transition-all">JP</button>
                            <button onclick="switchLang('en')" id="lang-en" class="px-3 py-1.5 rounded-lg text-[9px] font-black uppercase transition-all">EN</button>
                        </div>
                    </div>

                    <button id="loginBtn" class="glass hover:bg-white/10 text-white px-5 py-2.5 rounded-xl font-bold flex items-center gap-2 border border-white/10 text-[10px] uppercase tracking-widest">
                        <i class="fab fa-google text-cyan-400"></i> <span class="hidden sm:inline" data-t="btn_signin">Sign In</span>
                    </button>
                    <div id="userInfo" class="hidden flex items-center gap-4">
                        <div class="text-right hidden sm:block">
                            <p class="text-[8px] text-slate-500 font-black uppercase" data-t="active_user">Active User</p>
                            <p id="userName" class="text-xs font-black text-white"></p>
                        </div>
                        <div class="w-9 h-9 rounded-xl bg-gradient-to-tr from-cyan-500 to-indigo-500 flex items-center justify-center text-slate-950 font-bold text-sm shadow-lg shadow-cyan-500/20 cursor-pointer" onclick="goMyPage()">
                            <i class="fas fa-user-ninja"></i>
                        </div>
                        <button id="logoutBtn" class="text-slate-500 hover:text-white transition-colors"><i class="fas fa-power-off text-sm"></i></button>
                    </div>
                </div>
            </div>
        </header>

        <div class="max-w-7xl mx-auto w-full px-6 grid grid-cols-1 lg:grid-cols-12 gap-8 mt-8 flex-grow">
            <aside class="lg:col-span-3 space-y-6">
                <nav class="space-y-1">
                    <button onclick="goHome()" class="w-full text-left px-4 py-3 rounded-xl hover:bg-white/5 text-slate-400 hover:text-white transition-all flex items-center gap-3 text-sm font-bold group">
                        <i class="fas fa-compass w-5 text-center group-hover:text-cyan-400"></i> <span data-t="nav_explore">Explore</span>
                    </button>
                    <button id="navMyPageBtn" onclick="goMyPage()" class="hidden w-full text-left px-4 py-3 rounded-xl hover:bg-white/5 text-slate-400 hover:text-white transition-all flex items-center gap-3 text-sm font-bold group">
                        <i class="fas fa-layer-group w-5 text-center group-hover:text-cyan-400"></i> <span data-t="nav_mypage">My Polls</span>
                    </button>
                </nav>

                <button id="openCreateBtn" class="btn-glow hidden w-full bg-gradient-to-r from-cyan-500 to-blue-600 text-slate-950 font-black py-4 rounded-2xl flex items-center justify-center gap-3 shadow-xl active:scale-95 transition-all uppercase tracking-widest text-[10px]">
                    <i class="fas fa-plus-circle text-sm"></i> <span data-t="btn_launch_poll">Launch New Poll</span>
                </button>

                <div class="glass rounded-3xl p-5">
                    <h3 class="text-[9px] font-black uppercase tracking-[0.25em] text-slate-500 mb-4 px-2" data-t="discovery_label">Discovery</h3>
                    <div id="categoryNav" class="flex lg:flex-col gap-1 overflow-x-auto lg:overflow-visible pb-2 lg:pb-0 custom-scrollbar"></div>
                </div>
            </aside>

            <main class="lg:col-span-9 pb-24">
                <div id="view-home" class="animate-fade space-y-12">
                    <div class="flex items-center justify-between border-b border-white/5 pb-4">
                        <div class="flex items-center gap-4">
                            <h2 class="text-2xl font-black text-white italic uppercase tracking-tighter" id="latest_header">Latest Polls</h2>
                            <div class="flex bg-slate-950/50 p-1 rounded-xl border border-white/5">
                                <button onclick="switchSort('latest')" id="sort-latest" class="px-3 py-1 rounded-lg text-[8px] font-black uppercase transition-all">Latest</button>
                                <button onclick="switchSort('trending')" id="sort-trending" class="px-3 py-1 rounded-lg text-[8px] font-black uppercase transition-all">Trending</button>
                            </div>
                        </div>
                        <div class="flex items-center gap-2 text-[10px] font-black text-cyan-500 animate-pulse uppercase tracking-widest"><i class="fas fa-wifi text-[8px]"></i> <span data-t="sync_status">Synchronized</span></div>
                    </div>
                    <div id="topPolls" class="grid grid-cols-1 md:grid-cols-2 gap-8"></div>
                    <div class="pt-8 border-t border-white/5">
                        <h3 class="text-[10px] font-black uppercase tracking-[0.3em] text-slate-600 mb-6 px-1" data-t="sub_header">More Active Topics</h3>
                        <div id="subPolls" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>
                    </div>
                </div>

                <div id="view-detail" class="hidden animate-fade space-y-8">
                    <button onclick="goHome()" class="group flex items-center gap-3 text-slate-500 hover:text-white font-bold uppercase text-[10px] tracking-widest transition-all">
                        <div class="w-8 h-8 rounded-full glass flex items-center justify-center group-hover:bg-white group-hover:text-slate-900 transition-colors"><i class="fas fa-arrow-left"></i></div>
                        <span data-t="btn_return">Back</span>
                    </button>
                    <div id="pollDetailContent" class="glass rounded-[40px] p-10 shadow-2xl relative overflow-hidden"></div>
                    <div class="glass rounded-[40px] p-10">
                        <div class="flex items-center justify-between mb-8">
                            <h3 class="text-lg font-black text-white uppercase tracking-widest flex items-center gap-3"><span class="w-2 h-8 bg-cyan-500 rounded-full"></span> <span data-t="discourse_label">Discourse</span></h3>
                            <span id="commentCount" class="text-[10px] font-black bg-white/5 px-3 py-1 rounded-full text-slate-500 uppercase tracking-widest">0 Comments</span>
                        </div>
                        <div id="commentInputArea" class="hidden mb-10 relative">
                            <textarea id="commentText" maxlength="150" class="w-full bg-slate-950/50 border border-white/10 rounded-3xl p-6 text-sm text-white outline-none focus:ring-1 focus:ring-cyan-500/50 placeholder:text-slate-600 transition-all min-h-[120px]" data-t-placeholder="comment_placeholder"></textarea>
                            <button id="postCommentBtn" class="absolute bottom-6 right-6 bg-cyan-500 hover:bg-cyan-400 text-slate-950 px-8 py-2.5 rounded-2xl font-black text-[10px] uppercase tracking-widest shadow-lg active:scale-95" data-t="btn_send">Send</button>
                        </div>
                        <div id="commentsList" class="space-y-4"></div>
                    </div>
                </div>

                <div id="view-mypage" class="hidden animate-fade space-y-10">
                    <div class="flex items-center gap-6 mb-12">
                        <div class="w-16 h-16 rounded-3xl bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center text-white shadow-xl"><i class="fas fa-user-astronaut text-3xl"></i></div>
                        <div><h2 class="text-4xl font-black text-white italic uppercase tracking-tighter" data-t="mypage_title">Creator Dashboard</h2></div>
                    </div>
                    <div id="myPollsList" class="grid grid-cols-1 gap-6"></div>
                </div>
            </main>
        </div>
    </div>

    <!-- 投稿モーダル -->
    <div id="createModal" class="fixed inset-0 z-[200] hidden flex items-center justify-center bg-black/95 backdrop-blur-2xl p-4">
        <div class="glass max-w-2xl w-full rounded-[40px] p-10 shadow-2xl border border-white/10 max-h-[90vh] overflow-y-auto custom-scrollbar">
            <h2 id="modalTitle" class="text-3xl font-black mb-8 text-white italic uppercase tracking-tighter" data-t="btn_launch_poll">Launch Poll</h2>
            <div class="space-y-6">
                <div>
                    <label class="text-[10px] font-black text-slate-500 uppercase tracking-widest block mb-2 px-1" data-t="label_topic">Core Topic</label>
                    <input type="text" id="pollTitleInput" class="w-full bg-slate-950 border border-white/10 rounded-2xl p-5 text-white text-sm focus:border-cyan-500 outline-none transition-colors" data-t-placeholder="placeholder_topic">
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="text-[10px] font-black text-slate-500 uppercase tracking-widest block mb-2 px-1" data-t="label_segment">Segment</label>
                        <select id="pollCategoryInput" class="w-full bg-slate-950 border border-white/10 rounded-2xl p-5 text-white text-sm focus:border-cyan-500 outline-none appearance-none"></select>
                    </div>
                    <div class="flex items-end pb-5">
                        <label class="flex items-center gap-3 cursor-pointer">
                            <input type="checkbox" id="pollMultipleChoiceInput" class="w-5 h-5 rounded border-white/10 bg-slate-950">
                            <span class="text-[10px] font-black uppercase text-slate-400 tracking-widest" data-t="label_multiple">Allow Multiple Selection</span>
                        </label>
                    </div>
                </div>
                <div>
                    <label class="text-[10px] font-black text-slate-500 uppercase tracking-widest block mb-2 px-1" data-t="label_deadline">Termination Date</label>
                    <div id="deadlinePickerContainer" class="bg-slate-950 border border-white/10 rounded-2xl p-5 flex justify-between items-center cursor-pointer hover:border-cyan-500 relative min-h-[60px]">
                        <input type="datetime-local" id="pollDeadlineInput" class="absolute inset-0 opacity-0 cursor-pointer z-20 w-full h-full">
                        <span id="deadlineDisplay" class="text-xs font-bold text-slate-400 z-10" data-t="placeholder_deadline">Set Deadline (Optional)</span>
                        <i class="far fa-clock text-cyan-500 z-10"></i>
                    </div>
                </div>
                <div>
                    <label id="optionsLabel" class="text-[10px] font-black text-slate-500 uppercase tracking-widest block mb-2 px-1" data-t="label_options">Voting Options</label>
                    <textarea id="pollOptionsInput" class="w-full bg-slate-950 border border-white/10 rounded-2xl p-5 text-white text-sm focus:border-cyan-500 outline-none transition-colors font-mono" rows="4" data-t-placeholder="placeholder_options"></textarea>
                </div>
            </div>
            <div class="flex gap-4 mt-12">
                <button id="cancelCreateBtn" class="flex-1 bg-white/5 text-white font-bold py-4 rounded-2xl text-[10px] uppercase tracking-widest hover:bg-white/10" data-t="btn_abort">Abort</button>
                <button id="savePollBtn" class="flex-1 bg-gradient-to-r from-cyan-500 to-blue-600 text-slate-950 font-black py-4 rounded-2xl text-[10px] uppercase tracking-widest shadow-xl active:scale-95" data-t="btn_finalize">Finalize & Deploy</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js';
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken, GoogleAuthProvider, signInWithPopup } from 'https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js';
        import { getFirestore, collection, doc, getDoc, getDocs, addDoc, updateDoc, deleteDoc, onSnapshot, query, orderBy, serverTimestamp, arrayUnion, runTransaction, where, Timestamp } from 'https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js';

        // --- GLOBAL VARIABLES (TOP LEVEL) ---
        let app, auth, db, POLLS_COLL;
        const appIdStr = (typeof __app_id !== 'undefined' ? __app_id : 'mixvotesurvey');

        // --- App State (Memory only to bypass Storage Block) ---
        let appState = {
            lang: 'ja',
            tosAccepted: false,
            theme: { accent: '#06b6d4', bg: '#020617', text: '#f1f5f9' }
        };

        let user = null;
        let currentPollId = null;
        let currentPollData = null;
        let selectedCategory = "全て";
        let searchTerm = "";
        let chartInstance = null;
        let chartType = 'doughnut';
        let sortMode = 'latest'; 
        let multiSelections = [];
        let editMode = false;
        let editId = null;

        const CATEGORIES_JA = ["ニュース", "エンタメ", "テクノロジー", "生活", "スポーツ", "旅行", "グルメ", "教育", "政治", "趣味", "クイズ", "あるある"];

        // --- Multi-language Dictionary ---
        const translations = {
            ja: {
                theme_title: "外観のカスタマイズ", theme_accent: "アクセントカラー", theme_bg: "背景色", theme_text: "文字色", btn_reset_theme: "デフォルトに戻す",
                tos_title: "コミュニティルール", tos_rule1_title: "尊重し合う対話", tos_rule1_body: "誹謗中傷、差別、攻撃的な内容は厳格に禁止されます。",
                tos_rule2_title: "公平性の維持", tos_rule2_body: "一人一票の原則を守りましょう。", tos_accept: "同意する",
                btn_close: "閉じる", btn_signin: "ログイン", btn_launch_poll: "新規作成", btn_send: "送信", btn_abort: "中断", btn_finalize: "完了",
                btn_return: "戻る", btn_modify: "編集", btn_archive: "アーカイブ", btn_delete_permanent: "完全に削除",
                search_placeholder: "トピック、投票を検索...", active_user: "ユーザー", nav_explore: "探索", nav_mypage: "マイページ",
                discovery_label: "カテゴリー", sync_status: "同期済み", discourse_label: "議論", comment_placeholder: "コメント...",
                auth_req_label: "権限が必要です", mypage_title: "ダッシュボード", all_category: "全て", voted_unlock_label: "投票でアンロック",
                label_topic: "トピック名", label_multiple: "複数回答を許可する", label_segment: "カテゴリー", label_deadline: "期限", label_options: "選択肢",
                placeholder_topic: "中央の質問...", placeholder_options: "選択肢 A\n選択肢 B", participation_label: "参加数",
                placeholder_deadline: "期限を設定 (任意)",
                error_input: "エラー", error_options_limit: "最大50個までです。", btn_doughnut: "ドーナツ", btn_bar: "棒グラフ",
                btn_download: "保存", share_label: "シェアする", share_text_prefix: "【Mix Vote】投票中: ",
                sort_latest: "最新順", sort_trending: "トレンド順", sub_header: "その他のトピック", btn_vote_multi: "一括投票する",
                loading: "初期化中...", btn_confirm: "確認"
            },
            en: {
                theme_title: "Customize Theme", theme_accent: "Accent Color", theme_bg: "Background Color", theme_text: "Text Color", btn_reset_theme: "Restore Default",
                tos_title: "Community Rules", tos_rule1_title: "Respectful", tos_rule1_body: "Discrimination and offensive content are prohibited.",
                tos_rule2_title: "Fairness First", tos_rule2_body: "One-person, one-vote principle.", tos_accept: "Agree",
                btn_close: "Close", btn_signin: "Sign In", btn_launch_poll: "Launch New Poll", btn_send: "Send", btn_abort: "Abort", btn_finalize: "Finalize",
                btn_return: "Back", btn_modify: "Modify", btn_archive: "Archive", btn_delete_permanent: "Permanent Delete",
                search_placeholder: "Explore...", active_user: "Active User", nav_explore: "Explore", nav_mypage: "My Polls",
                discovery_label: "Discovery", sync_status: "Synchronized", discourse_label: "Discourse", comment_placeholder: "Join...",
                auth_req_label: "Auth Required", mypage_title: "Dashboard", all_category: "All", voted_unlock_label: "Seal Intact",
                label_topic: "Topic", label_multiple: "Allow Multiple Selections", label_segment: "Segment", label_deadline: "Deadline", label_options: "Options",
                placeholder_topic: "Central question?", placeholder_options: "Option A\nOption B", participation_label: "Total Participation",
                placeholder_deadline: "Set Deadline (Optional)",
                error_input: "Error", error_options_limit: "Max 50 options.", btn_doughnut: "Doughnut", btn_bar: "Bar Chart",
                btn_download: "Save", share_label: "Share", share_text_prefix: "[Mix Vote] Poll: ",
                sort_latest: "Latest", sort_trending: "Trending", sub_header: "Sub Topics", btn_vote_multi: "Submit Selections",
                loading: "Initializing...", btn_confirm: "Confirm"
            }
        };

        // --- Core Helper Functions ---
        function t(key) { return translations[appState.lang][key] || key; }

        function applyTheme() {
            const root = document.documentElement;
            root.style.setProperty('--accent', appState.theme.accent);
            root.style.setProperty('--bg-dark', appState.theme.bg);
            root.style.setProperty('--text-main', appState.theme.text);
            const r = parseInt(appState.theme.accent.slice(1, 3), 16), g = parseInt(appState.theme.accent.slice(3, 5), 16), b = parseInt(appState.theme.accent.slice(5, 7), 16);
            root.style.setProperty('--accent-glow', `rgba(${r}, ${g}, ${b}, 0.4)`);
            
            const accIn = document.getElementById('themeAccentInput'); if(accIn) accIn.value = appState.theme.accent;
            const bgIn = document.getElementById('themeBgInput'); if(bgIn) bgIn.value = appState.theme.bg;
            const txIn = document.getElementById('themeTextInput'); if(txIn) txIn.value = appState.theme.text;
        }

        function updateAuthUI() {
            const isRegistered = user && !user.isAnonymous;
            const loginBtn = document.getElementById('loginBtn');
            const userInfo = document.getElementById('userInfo');
            const openCreateBtn = document.getElementById('openCreateBtn');
            const navMyPageBtn = document.getElementById('navMyPageBtn');
            const commentInputArea = document.getElementById('commentInputArea');
            if (loginBtn) loginBtn.classList.toggle('hidden', isRegistered);
            if (userInfo) userInfo.classList.toggle('hidden', !isRegistered);
            if (openCreateBtn) openCreateBtn.classList.toggle('hidden', !isRegistered);
            if (navMyPageBtn) navMyPageBtn.classList.toggle('hidden', !isRegistered);
            if (commentInputArea) commentInputArea.classList.toggle('hidden', !isRegistered);
            if (isRegistered && document.getElementById('userName')) {
                document.getElementById('userName').textContent = user.displayName || 'Creator';
            }
        }

        function updateUILanguage() {
            document.querySelectorAll('[data-t]').forEach(el => el.textContent = t(el.dataset.t));
            document.querySelectorAll('[data-t-placeholder]').forEach(el => el.placeholder = t(el.dataset.tPlaceholder));
            const lText = document.getElementById('loadingText'); if(lText) lText.textContent = t('loading');
            
            const btnLatest = document.getElementById('sort-latest'), btnTrend = document.getElementById('sort-trending');
            if (btnLatest) btnLatest.textContent = t('sort_latest');
            if (btnTrend) btnTrend.textContent = t('sort_trending');
            
            const active = 'bg-cyan-500 text-slate-950', inactive = 'text-slate-500 hover:text-white';
            if (btnLatest) btnLatest.className = `px-3 py-1 rounded-lg text-[8px] font-black uppercase transition-all ${sortMode === 'latest' ? active : inactive}`;
            if (btnTrend) btnTrend.className = `px-3 py-1 rounded-lg text-[8px] font-black uppercase transition-all ${sortMode === 'trending' ? active : inactive}`;
        }

        function handleRoute() {
            const hash = window.location.hash;
            document.getElementById('view-home').classList.add('hidden');
            document.getElementById('view-detail').classList.add('hidden');
            document.getElementById('view-mypage').classList.add('hidden');
            if (hash.startsWith('#poll/')) {
                const id = hash.replace('#poll/', '');
                document.getElementById('view-detail').classList.remove('hidden');
                loadPollDetail(id);
            } else if (hash === '#mypage') {
                document.getElementById('view-mypage').classList.remove('hidden');
                loadMyPolls();
            } else {
                document.getElementById('view-home').classList.remove('hidden');
                loadAllPolls();
            }
            window.scrollTo(0,0);
        }

        function setupCategoryNav() {
            const nav = document.getElementById('categoryNav'), select = document.getElementById('pollCategoryInput');
            if (!nav || !select) return;
            nav.innerHTML = ''; select.innerHTML = '';
            ["全て", ...CATEGORIES_JA].forEach(cat => {
                const btn = document.createElement('button');
                btn.className = `nav-link px-4 py-3 rounded-xl text-[10px] font-black uppercase transition-all text-left whitespace-nowrap ${selectedCategory === cat ? 'active' : 'text-slate-500 hover:text-white'}`;
                btn.textContent = (appState.lang === 'en' && cat === "全て") ? "All" : cat;
                btn.onclick = () => { selectedCategory = cat; setupCategoryNav(); loadAllPolls(); };
                nav.appendChild(btn);
                if (cat !== "全て") { const opt = document.createElement('option'); opt.value = cat; opt.textContent = cat; select.appendChild(opt); }
            });
        }

        function loadAllPolls() {
            if (!user || !POLLS_COLL) return;
            onSnapshot(query(POLLS_COLL), (snap) => {
                const now = new Date();
                const polls = snap.docs.map(d => {
                    const data = d.data();
                    const deadline = data.deadline ? data.deadline.toDate() : null;
                    if (deadline && (now - deadline > 30 * 24 * 60 * 60 * 1000)) {
                        if (user && user.uid === data.authorID) deleteDoc(doc(db, 'artifacts', appIdStr, 'public', 'data', 'polls', d.id));
                        return null;
                    }
                    return { id: d.id, ...data };
                }).filter(p => p !== null && !p.deleted);
                
                if (sortMode === 'trending') {
                    polls.sort((a,b) => ((b.votes?.reduce((s,v)=>s+v,0)||0) + (b.likes?.length||0)) - ((a.votes?.reduce((s,v)=>s+v,0)||0) + (a.likes?.length||0)));
                } else {
                    polls.sort((a,b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
                }
                renderPolls(polls);
            }, (err) => console.error("Poll Load Error", err));
        }

        function renderPolls(polls) {
            let filtered = polls;
            if (selectedCategory !== "全て") filtered = filtered.filter(p => p.category === selectedCategory);
            if (searchTerm) filtered = filtered.filter(p => p.title.toLowerCase().includes(searchTerm.toLowerCase()));
            
            const topContainer = document.getElementById('topPolls'), subContainer = document.getElementById('subPolls');
            if (!topContainer || !subContainer) return;
            topContainer.innerHTML = ''; subContainer.innerHTML = '';

            filtered.slice(0, 5).forEach(p => {
                const total = p.votes?.reduce((s,v) => s+v, 0) || 0;
                const div = document.createElement('div');
                div.className = "poll-card glass rounded-[40px] p-10 cursor-pointer border border-white/5 animate-fade group relative overflow-hidden";
                div.onclick = () => goDetail(p.id);
                div.innerHTML = `
                    <div class="absolute top-0 right-0 w-32 h-32 bg-cyan-500/5 rounded-bl-full group-hover:bg-cyan-500/10 transition-all"></div>
                    <div class="relative z-10 space-y-6">
                        <div class="flex justify-between items-center">
                            <span class="text-[10px] font-black uppercase px-4 py-1.5 rounded-full bg-cyan-500/10 border border-cyan-500/20 text-cyan-400 tracking-[0.2em]">${p.category}</span>
                            <div class="flex items-center gap-4 text-[10px] font-black text-slate-600">
                                <span><i class="fas fa-check-to-slot mr-1"></i> ${total}</span>
                            </div>
                        </div>
                        <h3 class="text-3xl font-black leading-tight text-white italic group-hover:text-cyan-400 transition-colors">${p.title}</h3>
                        <span class="text-[10px] font-black text-slate-500 uppercase">By ${p.author || 'User'}</span>
                    </div>`;
                topContainer.appendChild(div);
            });

            filtered.slice(5, 55).forEach(p => {
                const div = document.createElement('div');
                div.className = "poll-card glass rounded-2xl p-5 cursor-pointer border border-white/5 animate-fade flex items-center justify-between";
                div.onclick = () => goDetail(p.id);
                div.innerHTML = `
                    <div class="flex flex-col gap-1 overflow-hidden">
                        <span class="text-[8px] font-black uppercase text-cyan-500/50">${p.category}</span>
                        <h4 class="text-sm font-bold text-slate-300 truncate pr-4">${p.title}</h4>
                    </div>
                    <i class="fas fa-chevron-right text-slate-800 text-[10px]"></i>`;
                subContainer.appendChild(div);
            });
        }

        async function loadPollDetail(id) {
            currentPollId = id; multiSelections = [];
            const ref = doc(db, 'artifacts', appIdStr, 'public', 'data', 'polls', id);
            onSnapshot(ref, (snap) => {
                if (!snap.exists()) return goHome();
                currentPollData = snap.data();
                renderDetail(id, currentPollData);
            });
        }

        function renderDetail(id, p) {
            const total = p.votes?.reduce((s,v) => s+v, 0) || 0;
            const resultsVisible = p.votedUsers?.includes(user?.uid) || (p.deadline && new Date() > p.deadline.toDate());
            const shareUrl = window.location.href;
            let html = `
                <div class="flex flex-col md:flex-row justify-between items-start gap-6 mb-10 pb-10 border-b border-white/5">
                    <div class="space-y-4 max-w-2xl">
                        <span class="bg-cyan-500 text-slate-950 font-black text-[9px] px-3 py-1 rounded-md uppercase">${p.category}</span>
                        <h2 class="text-3xl md:text-5xl font-black text-white italic tracking-tighter leading-none">${p.title}</h2>
                        <p class="text-slate-400 text-sm leading-relaxed">${p.desc || ''}</p>
                    </div>
                    <button onclick="handleAction('like', '${id}')" class="w-12 h-12 rounded-2xl glass flex items-center justify-center transition-all ${p.likes?.includes(user?.uid) ? 'text-pink-500 bg-pink-500/5' : 'text-slate-500 hover:text-white'}"><i class="fas fa-heart text-xl"></i></button>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-12">
                    <div class="space-y-3">
                        ${p.options.map((opt, i) => {
                            if (resultsVisible) {
                                const perc = total > 0 ? Math.round(((p.votes[i]||0) / total) * 100) : 0;
                                return `<div class="relative overflow-hidden bg-slate-950 border border-white/5 rounded-2xl p-5 flex justify-between items-center"><div class="absolute inset-y-0 left-0 bg-cyan-500/10 transition-all duration-1000" style="width: ${perc}%"></div><div class="z-10"><span class="text-sm font-bold text-white">${opt}</span></div><span class="z-10 text-xl font-black text-cyan-400 italic">${perc}%</span></div>`;
                            }
                            if (p.is_multiple) return `<label class="w-full bg-white/5 border border-white/10 rounded-2xl p-6 flex items-center gap-4 cursor-pointer group"><input type="checkbox" onchange="toggleSelection(${i})" class="w-5 h-5"><span class="font-bold text-white text-sm flex-1">${opt}</span></label>`;
                            return `<button onclick="castVote(${i})" class="w-full bg-white/5 border border-white/10 rounded-2xl p-6 text-left hover:border-cyan-500/50 hover:bg-white/10 transition-all group flex items-center gap-4"><span class="w-10 h-10 rounded-xl bg-slate-950 flex items-center justify-center font-black text-slate-600 italic text-sm">${i+1}</span><span class="font-bold text-white text-sm flex-1">${opt}</span></button>`;
                        }).join('')}
                        ${(p.is_multiple && !resultsVisible) ? `<button onclick="submitMultiVote()" class="w-full mt-6 bg-cyan-500 text-slate-950 font-black py-5 rounded-2xl shadow-xl active:scale-95 uppercase tracking-widest text-xs">${t('btn_vote_multi')}</button>` : ''}
                        <div class="mt-10 p-6 glass rounded-3xl border border-white/5 flex gap-4">
                            <a href="https://twitter.com/intent/tweet?text=${encodeURIComponent(t('share_text_prefix') + p.title)}&url=${encodeURIComponent(shareUrl)}" target="_blank" class="w-12 h-12 rounded-xl bg-slate-950 border border-white/10 flex items-center justify-center text-white hover:text-cyan-400"><i class="fab fa-x-twitter text-xl"></i></a>
                            <button onclick="copyShareLink('${shareUrl}')" class="w-12 h-12 rounded-xl bg-gradient-to-tr from-[#f9ce34] via-[#ee2a7b] to-[#6228d7] flex items-center justify-center text-white hover:scale-105"><i class="fab fa-instagram text-xl"></i></button>
                        </div>
                    </div>
                    <div class="flex flex-col items-center justify-center gap-6">
                        ${resultsVisible ? `<div class="flex bg-slate-950/50 p-1.5 rounded-xl border border-white/5 mb-2"><button onclick="updateChartType('doughnut')" class="px-4 py-1.5 rounded-lg text-[9px] font-black uppercase ${chartType === 'doughnut' ? 'bg-cyan-500 text-slate-950' : 'text-slate-500'}">${t('btn_doughnut')}</button><button onclick="updateChartType('bar')" class="px-4 py-1.5 rounded-lg text-[9px] font-black uppercase ${chartType === 'bar' ? 'bg-cyan-500 text-slate-950' : 'text-slate-500'}">${t('btn_bar')}</button></div><div class="w-full max-w-[320px] relative"><canvas id="pollChart"></canvas><button onclick="downloadChart()" class="mt-4 w-full text-[10px] font-black uppercase tracking-widest text-slate-500 hover:text-cyan-400"><i class="fas fa-download mr-1"></i> ${t('btn_download')}</button></div>` : `<p class="text-slate-400 text-xs font-black uppercase tracking-widest">${t('voted_unlock_label')}</p>`}
                    </div>
                </div>`;
            document.getElementById('pollDetailContent').innerHTML = html;
            if (resultsVisible) renderChart(p.options, p.votes);
            loadComments(id);
        }

        function renderChart(labels, data) {
            const ctx = document.getElementById('pollChart')?.getContext('2d');
            if (!ctx) return;
            if (chartInstance) chartInstance.destroy();
            chartInstance = new Chart(ctx, {
                type: chartType,
                data: { labels, datasets: [{ data, backgroundColor: [appState.theme.accent, '#3b82f6', '#8b5cf6', '#ec4899', '#f59e0b', '#10b981', '#ef4444'], borderWidth: 0 }] },
                options: { cutout: chartType === 'doughnut' ? '80%' : 0, plugins: { legend: { display: false } } }
            });
        }

        function loadComments(pid) {
            const coll = collection(db, 'artifacts', appIdStr, 'public', 'data', 'polls', pid, 'comments');
            onSnapshot(query(coll, orderBy('createdAt', 'desc')), (snap) => {
                const list = document.getElementById('commentsList');
                if (!list) return;
                document.getElementById('commentCount').textContent = `${snap.size} ${t('discourse_label')}`;
                list.innerHTML = snap.empty ? `<p class="text-center text-[10px] font-black text-slate-700 uppercase">No Discourse</p>` : '';
                snap.docs.forEach(d => {
                    const c = d.data();
                    const div = document.createElement('div');
                    div.className = "p-6 rounded-3xl bg-white/5 border border-white/5 flex gap-5 animate-fade";
                    div.innerHTML = `<div class="w-10 h-10 rounded-2xl bg-slate-900 border border-white/5 flex items-center justify-center text-xs text-slate-500 shrink-0 font-black">${maskName(c.author)[0]}</div><div class="flex-1"><span class="text-[10px] font-black text-cyan-500 uppercase">${maskName(c.author)}</span><p class="text-sm text-slate-300 leading-relaxed">${c.text}</p></div>`;
                    list.appendChild(div);
                });
            });
        }

        async function loadMyPolls() {
            const list = document.getElementById('myPollsList');
            if (!list) return;
            list.innerHTML = '<div class="flex justify-center p-20"><div class="w-10 h-10 border-4 border-cyan-500 border-t-transparent rounded-full animate-spin"></div></div>';
            try {
                const snap = await getDocs(POLLS_COLL);
                const myPolls = snap.docs.map(d => ({ id: d.id, ...d.data() })).filter(p => p.authorID === user.uid && !p.deleted);
                myPolls.sort((a,b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
                list.innerHTML = myPolls.length ? '' : `<p class="text-center py-20 text-slate-700 font-black text-xs">No Data</p>`;
                myPolls.forEach(p => {
                    const div = document.createElement('div');
                    div.className = "glass rounded-3xl p-8 border border-white/5 flex flex-col md:flex-row justify-between items-center gap-6 animate-fade";
                    div.innerHTML = `<div class="flex-1"><h3 class="text-xl font-bold text-white mb-2 cursor-pointer hover:text-cyan-400" onclick="goDetail('${p.id}')">${p.title}</h3></div><div class="flex gap-2"><button onclick="openEdit('${p.id}')" class="px-5 py-2.5 rounded-xl bg-white/5 text-white text-[10px] font-black uppercase">${t('btn_modify')}</button></div>`;
                    list.appendChild(div);
                });
            } catch (e) { console.error(e); }
        }

        function maskName(name) { return name ? (name.length > 5 ? name.substring(0, 3) + '...' : name) : 'User'; }

        // --- Window Globals ---
        window.goHome = () => { history.pushState(null, '', '#'); handleRoute(); };
        window.goDetail = (id) => { history.pushState(null, '', `#poll/${id}`); handleRoute(); };
        window.goMyPage = () => { if (user && !user.isAnonymous) { history.pushState(null, '', '#mypage'); handleRoute(); } };
        window.switchLang = (lang) => { appState.lang = lang; updateUILanguage(); setupCategoryNav(); handleRoute(); };
        window.switchSort = (mode) => { sortMode = mode; updateSortUI(); loadAllPolls(); };
        window.updateChartType = (type) => { chartType = type; if (currentPollData) renderDetail(currentPollId, currentPollData); };
        window.toggleSelection = (idx) => { const i = multiSelections.indexOf(idx); if (i > -1) multiSelections.splice(i, 1); else multiSelections.push(idx); };
        window.downloadChart = () => { const canvas = document.getElementById('pollChart'); if(!canvas) return; const link = document.createElement('a'); link.download = `Result.png`; link.href = canvas.toDataURL(); link.click(); };
        window.copyShareLink = (url) => { const el = document.createElement('textarea'); el.value = url; document.body.appendChild(el); el.select(); document.execCommand('copy'); document.body.removeChild(el); showMessage(t('copied'), t('share_label')); };

        window.submitMultiVote = async () => {
            if (multiSelections.length === 0 || !user) return;
            const ref = doc(db, 'artifacts', appIdStr, 'public', 'data', 'polls', currentPollId);
            await runTransaction(db, async (t) => {
                const snap = await t.get(ref);
                const d = snap.data();
                if (d.votedUsers?.includes(user.uid)) return;
                const v = [...d.votes]; multiSelections.forEach(idx => v[idx]++);
                t.update(ref, { votes: v, votedUsers: arrayUnion(user.uid) });
            });
            multiSelections = [];
        };

        window.castVote = async (idx) => {
            if (!user) return;
            const ref = doc(db, 'artifacts', appIdStr, 'public', 'data', 'polls', currentPollId);
            await runTransaction(db, async (t) => {
                const snap = await t.get(ref);
                const d = snap.data();
                if (d.votedUsers?.includes(user.uid)) return;
                const v = [...d.votes]; v[idx]++;
                t.update(ref, { votes: v, votedUsers: arrayUnion(user.uid) });
            });
        };

        window.handleAction = async (type, id) => {
            if (!user || user.isAnonymous) return;
            const ref = doc(db, 'artifacts', appIdStr, 'public', 'data', 'polls', id);
            const snap = await getDoc(ref);
            const data = snap.data();
            if (type === 'like') {
                const likes = data.likes || [];
                const idx = likes.indexOf(user.uid);
                if (idx > -1) likes.splice(idx, 1); else likes.push(user.uid);
                await updateDoc(ref, { likes });
            }
        };

        window.openEdit = async (id) => {
            editMode = true; editId = id;
            const snap = await getDoc(doc(db, 'artifacts', appIdStr, 'public', 'data', 'polls', id));
            const p = snap.data();
            document.getElementById('pollTitleInput').value = p.title;
            document.getElementById('pollOptionsInput').value = p.options.join('\n');
            document.getElementById('pollCategoryInput').value = p.category;
            document.getElementById('createModal').classList.remove('hidden');
        };

        // --- Entry Point Logic ---
        async function startApp() {
            // Environment checks for __firebase_config
            const getFirebaseConfig = () => {
                if (typeof __firebase_config !== 'undefined' && __firebase_config) {
                    try { return JSON.parse(__firebase_config); } catch(e) { return null; }
                }
                return null;
            };

            const config = getFirebaseConfig();
            if (!config || !config.apiKey) {
                // If config is not yet available, wait
                setTimeout(startApp, 250);
                return;
            }

            try {
                app = initializeApp(config);
                auth = getAuth(app);
                db = getFirestore(app);
                POLLS_COLL = collection(db, 'artifacts', appIdStr, 'public', 'data', 'polls');

                onAuthStateChanged(auth, (u) => {
                    user = u;
                    const loadingLayer = document.getElementById('loadingLayer');
                    if (loadingLayer) loadingLayer.classList.add('hidden');
                    
                    updateAuthUI();
                    updateUILanguage();
                    applyTheme();
                    setupCategoryNav();

                    if (appState.tosAccepted) {
                        const appUI = document.getElementById('appUI');
                        if (appUI) appUI.classList.remove('hidden');
                        handleRoute();
                    } else {
                        const tosM = document.getElementById('tosModal');
                        if (tosM) tosM.classList.remove('hidden');
                    }
                });

                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }

            } catch (e) {
                console.error("Critical Startup Error:", e);
                const loadingLayer = document.getElementById('loadingLayer');
                if (loadingLayer) loadingLayer.innerHTML = `<p class="text-red-500">Startup Failed. Please check console.</p>`;
            }
        }

        // --- Listeners ---
        document.getElementById('themeAccentInput').oninput = (e) => { appState.theme.accent = e.target.value; applyTheme(); };
        document.getElementById('themeBgInput').oninput = (e) => { appState.theme.bg = e.target.value; applyTheme(); };
        document.getElementById('themeTextInput').oninput = (e) => { appState.theme.text = e.target.value; applyTheme(); };
        document.getElementById('resetThemeBtn').onclick = () => { appState.theme = { ...themeDefaults }; applyTheme(); };
        document.getElementById('globalSearch').oninput = (e) => { searchTerm = e.target.value; loadAllPolls(); };
        document.getElementById('agreeTosBtn').onclick = () => { 
            appState.tosAccepted = true; 
            document.getElementById('tosModal').classList.add('hidden'); 
            document.getElementById('appUI').classList.remove('hidden'); 
            handleRoute(); 
        };
        document.getElementById('loginBtn').onclick = () => signInWithPopup(auth, new GoogleAuthProvider());
        document.getElementById('logoutBtn').onclick = () => auth.signOut();
        document.getElementById('openCreateBtn').onclick = () => { editMode = false; editId = null; document.getElementById('createModal').classList.remove('hidden'); };
        document.getElementById('cancelCreateBtn').onclick = () => document.getElementById('createModal').classList.add('hidden');
        document.getElementById('msgCloseBtn').onclick = () => document.getElementById('msgModal').classList.add('hidden');
        document.getElementById('savePollBtn').onclick = async () => {
            const title = document.getElementById('pollTitleInput').value.trim();
            const options = document.getElementById('pollOptionsInput').value.split('\n').filter(x => x.trim());
            if (!title || options.length < 2) return;
            const data = {
                title, category: document.getElementById('pollCategoryInput').value,
                is_multiple: document.getElementById('pollMultipleChoiceInput').checked,
                options, createdAt: serverTimestamp(), updatedAt: serverTimestamp(),
                author: user.displayName || 'Creator', authorID: user.uid,
                votes: new Array(options.length).fill(0), votedUsers: [], likes: [], deleted: false
            };
            if (editMode && editId) await updateDoc(doc(db, 'artifacts', appIdStr, 'public', 'data', 'polls', editId), { title: data.title, category: data.category, options: data.options, is_multiple: data.is_multiple, updatedAt: serverTimestamp() });
            else await addDoc(POLLS_COLL, data);
            document.getElementById('createModal').classList.add('hidden');
        };

        window.onpopstate = handleRoute;
        startApp();
    </script>
</body>
</html>