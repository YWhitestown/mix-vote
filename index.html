<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mix Vote - 次世代投票プラットフォーム</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&family=Noto+Sans+JP:wght@400;700&display=swap');
        
        :root {
            --accent: #06b6d4;
            --accent-rgb: 6, 182, 212;
            --accent-glow: rgba(6, 182, 212, 0.4);
            --bg-dark: #020617;
            --text-main: #f1f5f9;
        }

        body {
            font-family: 'Plus Jakarta Sans', 'Noto Sans JP', sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-main);
            overflow-x: hidden;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .dynamic-text { color: var(--text-main); }
        h1, h2, h3, h4, label { color: var(--text-main); }

        .bg-blob {
            position: fixed;
            width: 600px; height: 600px;
            background: radial-gradient(circle, var(--accent-glow) 0%, rgba(2, 6, 23, 0) 70%);
            border-radius: 50%; z-index: -1; filter: blur(80px);
            animation: floatBlob 25s infinite alternate ease-in-out;
            opacity: 0.6;
        }
        .blob-1 { top: -150px; right: -150px; }
        .blob-2 { bottom: -200px; left: -200px; background: radial-gradient(circle, rgba(168, 85, 247, 0.3) 0%, rgba(2, 6, 23, 0) 70%); animation-delay: -5s; }

        @keyframes floatBlob {
            0% { transform: translate(0, 0) scale(1); }
            100% { transform: translate(50px, 50px) scale(1.1); }
        }

        .glass {
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
        }

        .glass-panel {
            background: linear-gradient(145deg, rgba(30, 41, 59, 0.4), rgba(15, 23, 42, 0.6));
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .poll-card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        .poll-card:hover {
            transform: translateY(-4px);
            border-color: var(--accent);
            box-shadow: 0 10px 30px -10px var(--accent-glow);
            background: rgba(30, 41, 59, 0.8);
        }

        .btn-glow {
            position: relative;
            overflow: hidden;
            background-color: var(--accent);
            transition: filter 0.2s;
        }
        .btn-glow:hover { filter: brightness(1.1); }
        .btn-glow::after {
            content: '';
            position: absolute;
            top: -50%; left: -50%; width: 200%; height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255,255,255,0.1), transparent);
            transform: rotate(45deg);
            transition: 0.6s;
        }
        .btn-glow:hover::after { left: 120%; }

        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
        
        .nav-link.active {
            background: linear-gradient(90deg, var(--accent), #3b82f6);
            color: #020617 !important;
            box-shadow: 0 0 20px var(--accent-glow);
            border: none;
        }

        @media (max-width: 1024px) {
            #categoryNav .nav-link {
                writing-mode: vertical-rl;
                text-orientation: mixed;
                min-height: 100px;
                padding: 15px 10px;
                white-space: nowrap;
                display: flex;
                align-items: center;
                justify-content: center;
            }
        }

        .spinner { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        input[type="color"] {
            appearance: none; -webkit-appearance: none; border: none;
            width: 24px; height: 24px; border-radius: 6px; cursor: pointer; background: none;
        }

        .browser-tip {
            font-size: 14px;
            background: rgba(var(--accent-rgb), 0.05);
            padding: 18px 24px;
            border-radius: 24px;
            border: 1px solid rgba(var(--accent-rgb), 0.2);
            color: var(--text-main);
            display: flex;
            align-items: center;
            gap: 18px;
            margin-bottom: 24px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 10px 30px -10px rgba(0, 0, 0, 0.4);
        }
        .browser-tip:hover {
            background: rgba(var(--accent-rgb), 0.1);
            border-color: var(--accent);
            transform: translateY(-2px) scale(1.01);
            box-shadow: 0 20px 40px -15px var(--accent-glow);
        }

        .info-banner {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 15px 20px;
            border-radius: 24px;
            margin-bottom: 24px;
        }

        .vote-bar-bg {
            background: rgba(255, 255, 255, 0.05);
            height: 48px;
            border-radius: 12px;
            position: relative;
            overflow: hidden;
            cursor: pointer;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: border-color 0.2s;
        }
        .vote-bar-bg:hover {
            border-color: var(--accent);
        }
        .vote-bar-fill {
            height: 100%;
            background: rgba(var(--accent-rgb), 0.2);
            transition: width 1s cubic-bezier(0.4, 0, 0.2, 1);
            width: 0;
        }
        .vote-bar-content {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 16px;
            font-weight: 700;
            font-size: 0.875rem;
            z-index: 10;
        }
    </style>
</head>
<body class="min-h-screen selection:bg-cyan-500 selection:text-slate-900">

    <div class="bg-blob blob-1"></div>
    <div class="bg-blob blob-2"></div>

    <!-- 翻訳ガイド用モーダル -->
    <div id="translateModal" class="fixed inset-0 z-[300] hidden flex items-center justify-center bg-black/80 backdrop-blur-md p-4 pointer-events-auto">
        <div class="glass max-w-md w-full rounded-[32px] p-8 border border-white/10 shadow-2xl pointer-events-auto relative z-10">
            <div class="flex items-center gap-3 mb-6">
                <div class="w-12 h-12 bg-[rgba(var(--accent-rgb),0.2)] rounded-full flex items-center justify-center text-[color:var(--accent)]">
                    <i class="fas fa-language text-2xl"></i>
                </div>
                <h3 class="text-xl font-black italic uppercase tracking-widest i18n" data-key="translate_help">Translation Help</h3>
            </div>
            <div id="translateGuideContent" class="space-y-6 text-sm opacity-90 i18n-html" data-key="translate_guide_content">
            </div>
            <button onclick="window.closeTranslateModal()" class="btn-glow w-full text-slate-950 font-black py-4 rounded-xl mt-8 uppercase tracking-widest text-xs i18n pointer-events-auto" data-key="close">
                Close
            </button>
        </div>
    </div>

    <!-- 同意モーダル -->
    <div id="tosModal" class="fixed inset-0 z-[100] hidden flex items-center justify-center bg-black/90 backdrop-blur-md p-4 pointer-events-auto">
        <div class="glass max-w-2xl w-full rounded-3xl p-8 shadow-2xl border border-white/10 text-center pointer-events-auto relative z-10">
            <h2 class="text-2xl font-black text-[color:var(--accent)] uppercase italic mb-6 i18n" data-key="welcome_title">Welcome to Mix Vote</h2>
            <div id="tosContent" class="space-y-4 text-sm mb-8 text-left max-h-[40vh] overflow-y-auto custom-scrollbar pr-2 leading-relaxed opacity-80 i18n-html" data-key="tos_content">
            </div>
            <button id="agreeTosBtn" class="btn-glow i18n w-full text-slate-950 font-black py-4 rounded-xl transition-all active:scale-95 uppercase tracking-widest text-xs pointer-events-auto" data-key="agree_btn">
                I Agree & Enter
            </button>
        </div>
    </div>

    <!-- 通知モーダル -->
    <div id="msgModal" class="fixed inset-0 z-[400] hidden flex items-center justify-center bg-black/80 backdrop-blur-sm p-4 pointer-events-auto">
        <div class="glass max-w-xs w-full rounded-[24px] p-6 text-center border border-white/10 shadow-2xl pointer-events-auto relative z-10">
            <h3 id="msgTitle" class="text-lg font-black mb-3 uppercase italic text-[color:var(--accent)] i18n" data-key="notice">Notice</h3>
            <p id="msgBody" class="opacity-70 text-xs mb-6 leading-relaxed whitespace-pre-wrap"></p>
            <div id="msgActions" class="flex gap-3 mt-4">
                <button id="msgCloseBtn" onclick="window.closeMsgModal()" class="flex-1 bg-white/5 text-white font-bold py-3 rounded-xl uppercase text-[10px] tracking-widest hover:bg-white/10 transition-colors i18n pointer-events-auto" data-key="close">Close</button>
                <button id="msgConfirmBtn" class="flex-1 bg-[color:var(--accent)] text-slate-950 font-black py-3 rounded-xl uppercase text-[10px] tracking-widest hidden hover:brightness-110 transition-colors i18n pointer-events-auto" data-key="confirm">Confirm</button>
            </div>
        </div>
    </div>

    <!-- 削除モーダル -->
    <div id="deleteOptionsModal" class="fixed inset-0 z-[250] hidden flex items-center justify-center bg-black/90 backdrop-blur-xl p-4 pointer-events-auto">
        <div class="glass max-w-sm w-full rounded-[32px] p-8 text-center border border-red-500/20 shadow-2xl pointer-events-auto relative z-10">
            <div class="w-16 h-16 bg-red-500/10 rounded-full flex items-center justify-center mx-auto mb-6">
                <i class="fas fa-trash-alt text-red-500 text-2xl"></i>
            </div>
            <h3 class="text-xl font-black italic uppercase tracking-tighter mb-2 i18n" data-key="delete_poll">Delete Poll</h3>
            <p class="opacity-60 text-xs mb-8 leading-relaxed i18n" data-key="delete_confirm_text">How would you like to process this poll?</p>
            <div class="space-y-3">
                <button id="archiveBtn" class="w-full bg-white/5 hover:bg-white/10 text-white font-bold py-4 rounded-xl text-xs transition-all border border-white/5 i18n pointer-events-auto" data-key="archive_btn">Archive (Hide)</button>
                <button id="permanentDeleteBtn" class="w-full bg-red-500 hover:bg-red-600 text-white font-black py-4 rounded-xl text-xs transition-all shadow-lg shadow-red-500/20 hidden i18n pointer-events-auto" data-key="permanent_delete_btn">Permanently Delete</button>
                <button onclick="window.closeDeleteModal()" class="w-full bg-transparent opacity-50 hover:opacity-100 font-bold py-3 text-xs uppercase tracking-widest mt-2 i18n pointer-events-auto" data-key="cancel">Cancel</button>
            </div>
        </div>
    </div>

    <!-- コメント編集モーダル -->
    <div id="editCommentModal" class="fixed inset-0 z-[300] hidden flex items-center justify-center bg-black/80 backdrop-blur-sm p-4 pointer-events-auto">
        <div class="glass max-w-sm w-full rounded-[24px] p-6 border border-white/10 shadow-2xl pointer-events-auto relative z-10">
            <h3 class="text-lg font-black mb-4 uppercase italic tracking-widest i18n" data-key="edit_comment">Edit Comment</h3>
            <textarea id="editCommentInput" class="w-full bg-slate-900 border border-white/10 rounded-xl p-4 text-sm text-white outline-none mb-4 focus:border-[color:var(--accent)] transition-colors" rows="3" maxlength="100"></textarea>
            <div class="flex gap-3">
                <button onclick="window.closeEditCommentModal()" class="flex-1 bg-white/5 text-white font-bold py-3 rounded-xl uppercase text-[10px] tracking-widest hover:bg-white/10 i18n pointer-events-auto" data-key="cancel">Cancel</button>
                <button id="saveCommentBtn" class="flex-1 bg-[color:var(--accent)] text-slate-950 font-black py-3 rounded-xl uppercase text-[10px] tracking-widest hover:brightness-110 i18n pointer-events-auto" data-key="save">Save</button>
            </div>
        </div>
    </div>

    <!-- メインUI -->
    <div id="appUI" class="hidden flex flex-col min-h-screen">
        <header class="sticky top-0 z-50 glass border-b border-white/5 px-6 py-4 backdrop-blur-xl">
            <div class="max-w-7xl mx-auto flex items-center justify-between gap-4">
                <div class="flex items-center gap-3 cursor-pointer group shrink-0" onclick="window.goHome()">
                    <div class="w-10 h-10 bg-[color:var(--accent)] rounded-xl flex items-center justify-center shadow-lg group-hover:rotate-12 transition-transform text-slate-900">
                        <i class="fas fa-bolt text-xl"></i>
                    </div>
                    <div class="hidden md:block">
                        <h1 class="text-xl font-black tracking-tighter uppercase italic leading-none">Mix Vote</h1>
                        <p class="text-[8px] opacity-50 font-bold uppercase tracking-[0.2em] i18n" data-key="edition_tag">Global Edition</p>
                    </div>
                </div>

                <div class="flex-1 max-w-lg relative group flex items-center gap-3">
                    <div class="relative flex-1">
                        <input type="text" id="globalSearch" class="w-full bg-slate-900/50 border border-white/10 rounded-2xl py-2.5 pl-10 pr-4 text-xs text-white outline-none focus:border-[color:var(--accent)] transition-all placeholder:opacity-30" placeholder="Search polls...">
                        <i class="fas fa-search absolute left-3.5 top-1/2 -translate-y-1/2 opacity-30 group-focus-within:text-[color:var(--accent)] group-focus-within:opacity-100 transition-all text-xs"></i>
                    </div>
                    <button onclick="window.openTranslateModal()" class="w-10 h-10 rounded-2xl glass hover:bg-white/10 flex items-center justify-center text-[color:var(--accent)] transition-all shrink-0" title="Translation Help">
                        <i class="fas fa-language text-xl"></i>
                    </button>
                </div>

                <div id="authArea" class="shrink-0 flex items-center gap-4">
                    <button id="loginBtn" class="glass hover:bg-white/10 px-5 py-2.5 rounded-xl font-bold flex items-center gap-2 border border-white/10 transition-all uppercase text-[10px] tracking-widest shadow-lg">
                        <i class="fab fa-google text-[color:var(--accent)]"></i> <span class="hidden sm:inline i18n" data-key="login">Sign In</span>
                    </button>
                    <div id="userInfo" class="hidden flex items-center gap-4">
                        <div class="flex md:hidden items-center gap-4 mr-2 border-r border-white/10 pr-4">
                            <button onclick="window.goHome()" class="text-white/40 hover:text-white transition-colors"><i class="fas fa-home"></i></button>
                            <button onclick="window.openCreateModal()" class="w-8 h-8 rounded-lg bg-[color:var(--accent)] flex items-center justify-center text-slate-900 shadow-lg"><i class="fas fa-plus"></i></button>
                        </div>
                        <div class="text-right hidden sm:block">
                            <p class="text-[9px] opacity-50 font-bold uppercase tracking-wider i18n" data-key="welcome_user">Welcome</p>
                            <p id="userName" class="text-xs font-black"></p>
                        </div>
                        <div id="userAvatar" class="w-8 h-8 rounded-full bg-[color:var(--accent)] flex items-center justify-center text-slate-900 font-bold text-xs shadow-lg cursor-pointer hover:scale-105 transition-transform overflow-hidden" onclick="window.goCreatedPolls()"><i class="fas fa-user"></i></div>
                        <button id="logoutBtn" class="opacity-50 hover:opacity-100 transition-colors"><i class="fas fa-sign-out-alt"></i></button>
                    </div>
                </div>
            </div>
        </header>

        <div class="max-w-7xl mx-auto w-full px-6 grid grid-cols-1 lg:grid-cols-12 gap-8 mt-8 flex-grow">
            <aside class="lg:col-span-3 space-y-6">
                <div class="space-y-2">
                    <button onclick="window.goHome()" id="navHomeBtn" class="w-full text-left px-4 py-3 rounded-xl hover:bg-white/5 transition-all flex items-center gap-3 text-sm font-bold group">
                        <i class="fas fa-home opacity-40 group-hover:text-[color:var(--accent)] group-hover:opacity-100 transition-all w-5 text-center"></i> <span class="i18n" data-key="home">Home</span>
                    </button>
                    <div id="userNavGroup" class="hidden space-y-2">
                        <button onclick="window.goCreatedPolls()" id="navCreatedBtn" class="w-full text-left px-4 py-3 rounded-xl hover:bg-white/5 flex items-center gap-3 text-sm font-bold group">
                            <i class="fas fa-edit opacity-40 group-hover:text-[color:var(--accent)] group-hover:opacity-100 transition-all w-5 text-center"></i> <span class="i18n" data-key="created_polls">Created Polls</span>
                        </button>
                        <button onclick="window.goVotedPolls()" id="navVotedBtn" class="w-full text-left px-4 py-3 rounded-xl hover:bg-white/5 flex items-center gap-3 text-sm font-bold group">
                            <i class="fas fa-check-double opacity-40 group-hover:text-[color:var(--accent)] group-hover:opacity-100 transition-all w-5 text-center"></i> <span class="i18n" data-key="voted_polls">Voted Polls</span>
                        </button>
                    </div>
                </div>

                <button onclick="window.openCreateModal()" id="openCreateBtn" class="btn-glow w-full text-slate-950 font-black py-4 rounded-2xl flex items-center justify-center gap-3 shadow-xl active:scale-95 uppercase tracking-widest text-xs group">
                    <i class="fas fa-plus group-hover:rotate-90 transition-transform"></i> <span class="i18n" data-key="new_poll">New Poll</span>
                </button>

                <div class="glass rounded-3xl p-5 border border-white/5">
                    <h3 class="text-xs font-black uppercase tracking-[0.2em] opacity-50 mb-4 pl-2 i18n" data-key="language">Language</h3>
                    <div class="flex gap-2 p-1 bg-black/20 rounded-xl">
                        <button onclick="window.changeLang('ja')" id="langJaBtn" class="flex-1 py-2.5 text-xs font-black rounded-lg transition-all">日本語</button>
                        <button onclick="window.changeLang('en')" id="langEnBtn" class="flex-1 py-2.5 text-xs font-black rounded-lg transition-all">English</button>
                    </div>
                </div>

                <div class="glass rounded-3xl p-5 border border-white/5 overflow-hidden">
                    <h3 class="text-xs font-black uppercase tracking-[0.2em] opacity-50 mb-4 pl-2 i18n" data-key="categories">Categories</h3>
                    <div class="relative group/cat-nav">
                        <nav id="categoryNav" class="flex lg:flex-col gap-1 overflow-x-auto lg:overflow-y-auto pb-2 lg:pb-0 custom-scrollbar lg:max-h-[50vh] pr-1"></nav>
                    </div>
                </div>

                <div class="text-[9px] opacity-40 font-medium px-2 leading-relaxed">
                    <p>&copy; 2025 Mix Vote Project.</p>
                </div>
            </aside>

            <main class="lg:col-span-9 pb-20">
                <div id="view-home" class="view-content space-y-8">
                    <div id="homeTranslateGuide" class="browser-tip" onclick="window.openTranslateModal()">
                        <div class="w-14 h-14 bg-[rgba(var(--accent-rgb),0.2)] rounded-2xl flex items-center justify-center text-[color:var(--accent)] shrink-0 shadow-lg">
                            <i class="fas fa-language text-3xl"></i>
                        </div>
                        <div class="flex-1">
                            <p class="font-black text-lg tracking-tight mb-0.5 i18n" data-key="home_translate_title">Translate Content</p>
                            <p class="text-sm opacity-70 leading-snug i18n" data-key="home_translate_desc">Browser translation is supported.</p>
                        </div>
                    </div>

                    <div id="loginNoticeBanner" class="info-banner flex flex-col md:flex-row gap-4 items-start md:items-center">
                        <div class="flex gap-3 items-center text-amber-400">
                            <i class="fas fa-user-lock text-xl"></i>
                            <div>
                                <p class="font-black text-sm i18n" data-key="home_login_notice_title">Login Required</p>
                                <p class="text-xs opacity-50 i18n" data-key="home_login_notice_desc">Google sign-in is required to create new polls or comments.</p>
                            </div>
                        </div>
                    </div>

                    <section class="space-y-10">
                        <div class="space-y-6">
                            <div class="flex items-end border-l-4 border-[color:var(--accent)] pl-4">
                                <h2 id="homeSectionTitle" class="text-xl md:text-2xl font-black italic uppercase tracking-tighter">Latest Polls</h2>
                            </div>
                            <div id="latestPollsFeatured" class="grid grid-cols-1 gap-6"></div>
                        </div>
                        <div class="space-y-4">
                            <div class="flex items-end justify-between mb-4 border-b border-white/5 pb-2">
                                <h2 class="text-base font-black opacity-60 italic uppercase tracking-tighter i18n" data-key="recent_activity">Recent Activity</h2>
                            </div>
                            <div id="latestPollsMore" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
                        </div>
                    </section>
                </div>

                <div id="view-created" class="view-content hidden space-y-8">
                    <div class="flex items-end border-l-4 border-[color:var(--accent)] pl-4">
                        <h2 class="text-xl md:text-2xl font-black italic uppercase tracking-tighter i18n" data-key="created_polls">Created Polls</h2>
                    </div>
                    <div id="createdPollsList" class="grid grid-cols-1 md:grid-cols-2 gap-5"></div>
                </div>

                <div id="view-voted" class="view-content hidden space-y-8">
                    <div class="flex items-end border-l-4 border-[color:var(--accent)] pl-4">
                        <h2 class="text-xl md:text-2xl font-black italic uppercase tracking-tighter i18n" data-key="voted_polls">Voted Polls</h2>
                    </div>
                    <div id="votedPollsList" class="grid grid-cols-1 md:grid-cols-2 gap-5"></div>
                </div>

                <div id="view-detail" class="view-content hidden space-y-8">
                    <div class="flex items-center justify-between">
                        <button onclick="window.goHome()" class="opacity-50 hover:opacity-100 uppercase text-[10px] tracking-widest font-bold transition-all"><i class="fas fa-arrow-left"></i> <span class="i18n" data-key="back">Back</span></button>
                        <div id="adminControls" class="flex gap-2"></div>
                    </div>
                    
                    <article id="pollDetailContent" class="glass rounded-[32px] p-8 md:p-10 border border-white/10 shadow-2xl relative overflow-hidden"></article>
                    
                    <section class="glass rounded-[32px] p-8 border border-white/10 space-y-6">
                        <h3 class="text-lg font-black flex items-center gap-3 uppercase tracking-widest"><span class="w-1.5 h-6 bg-[color:var(--accent)] rounded-full"></span> <span class="i18n" data-key="discussion">Discussion</span></h3>
                        <div id="commentInputArea" class="hidden relative">
                            <textarea id="commentText" maxlength="100" class="w-full bg-slate-950/50 border border-white/10 rounded-2xl p-5 text-sm text-white outline-none focus:ring-1 focus:ring-[rgba(var(--accent-rgb),0.6)] transition-all min-h-[100px]" placeholder="Share your thoughts..."></textarea>
                            <button id="postCommentBtn" onclick="window.postComment()" class="absolute bottom-4 right-4 bg-[color:var(--accent)] hover:brightness-110 text-slate-950 px-6 py-2 rounded-xl font-bold text-xs transition-all shadow-lg i18n" data-key="post">Post</button>
                        </div>
                        <div id="commentsList" class="space-y-4"></div>
                    </section>
                </div>
            </main>
        </div>
    </div>

    <!-- 作成モーダル -->
    <div id="createModal" class="fixed inset-0 z-[100] hidden flex items-center justify-center bg-black/90 backdrop-blur-xl p-4 pointer-events-auto">
        <div onclick="event.stopPropagation()" class="glass max-w-lg w-full rounded-[32px] p-8 shadow-2xl border border-white/10 max-h-[90vh] overflow-y-auto custom-scrollbar pointer-events-auto relative z-10">
            <h2 id="modalTitle" class="text-2xl font-black mb-6 uppercase italic tracking-tighter i18n" data-key="create_poll">Create Poll</h2>
            <div class="space-y-5">
                <div><label class="text-[9px] font-black opacity-50 uppercase tracking-widest block mb-2 i18n" data-key="label_title">Title</label><input type="text" id="pollTitleInput" class="w-full bg-slate-950 border border-white/10 rounded-xl p-4 text-white text-sm outline-none focus:border-[color:var(--accent)] transition-colors" placeholder="Your Question?"></div>
                <div><label id="labelPollDesc" class="text-[9px] font-black opacity-50 uppercase tracking-widest block mb-2 i18n" data-key="label_desc">Description</label><textarea id="pollDescInput" class="w-full bg-slate-950 border border-white/10 rounded-xl p-4 text-white text-sm outline-none focus:border-[color:var(--accent)] transition-colors" rows="2" placeholder="Add some context..."></textarea></div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="text-[9px] font-black opacity-50 uppercase tracking-widest block mb-2 i18n" data-key="label_category">Category</label><select id="pollCategoryInput" class="w-full bg-slate-950 border border-white/10 rounded-xl p-4 text-white text-sm outline-none appearance-none focus:border-[color:var(--accent)]"></select></div>
                    <div><label class="text-[9px] font-black opacity-50 uppercase tracking-widest block mb-2 i18n" data-key="label_deadline">Deadline</label><div class="bg-slate-950 border border-white/10 rounded-xl p-4 flex justify-between items-center cursor-pointer relative hover:border-[color:var(--accent)] transition-colors"><input type="datetime-local" id="pollDeadlineInput" class="absolute inset-0 opacity-0 cursor-pointer z-10"><span id="deadlineDisplay" class="text-xs font-bold i18n" data-key="select">Select</span><i class="far fa-clock text-[color:var(--accent)]"></i></div></div>
                </div>
                <div><label class="text-[9px] font-black opacity-50 uppercase tracking-widest block mb-2 i18n" data-key="label_options">Options (one per line, max 50)</label><textarea id="pollOptionsInput" class="w-full bg-slate-950 border border-white/10 rounded-xl p-4 text-white text-sm font-mono outline-none focus:border-[color:var(--accent)] transition-colors" rows="4" placeholder="Option 1&#10;Option 2"></textarea></div>
            </div>
            <div class="flex gap-3 mt-8"><button onclick="window.closeCreateModal()" class="flex-1 i18n bg-white/5 text-white font-bold py-4 rounded-xl text-xs hover:bg-white/10 transition-colors pointer-events-auto" data-key="cancel">Cancel</button><button id="savePollBtn" class="flex-1 bg-[color:var(--accent)] text-slate-950 font-black py-4 rounded-xl text-xs shadow-lg transition-transform flex items-center justify-center gap-2 pointer-events-auto" onclick="window.savePoll()"><i id="saveBtnSpinner" class="fas fa-circle-notch spinner hidden"></i><span id="saveBtnText" class="i18n" data-key="save_poll">Save Poll</span></button></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js';
        import { 
            getAuth, 
            signInWithPopup,
            onAuthStateChanged, 
            GoogleAuthProvider, 
            getIdTokenResult,
            signOut
        } from 'https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js';
        import { 
            initializeFirestore, 
            collection, 
            doc, 
            getDoc, 
            addDoc, 
            updateDoc, 
            deleteDoc, 
            onSnapshot, 
            query, 
            orderBy, 
            where, 
            serverTimestamp, 
            arrayUnion, 
            runTransaction, 
            Timestamp 
        } from 'https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyAwyi5j8EvqHL8wkyAJ48rwR8QCfS9voUE",
            authDomain: "mixvotesurvey.firebaseapp.com",
            projectId: "mixvotesurvey",
            storageBucket: "mixvotesurvey.firebasestorage.app",
            messagingSenderId: "352307389497",
            appId: "1:352307389497:web:0939fd29452d6c6afc59e8",
            measurementId: "G-ZWR5GHHL54"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = initializeFirestore(app, { experimentalAutoDetectLongPolling: true });
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'mixvote-web';
        const POLLS_PATH = ['artifacts', appId, 'public', 'data', 'polls'];

        let currentLang = 'ja', currentUser = null, isAdmin = false;
        let selectedCategory = "__ALL__", allPollsCache = [], currentPollId = null, currentPollData = null;
        let unsubscribePollsRealtime = null, unsubscribeComments = null;

        const CATEGORIES_JA = ["ニュース", "エンタメ", "テクノロジー", "生活", "スポーツ", "旅行", "グルメ", "教育", "政治", "趣味", "クイズ", "あるある"];
        const CATEGORIES_EN = ["News", "Entertainment", "Tech", "Lifestyle", "Sports", "Travel", "Gourmet", "Education", "Politics", "Hobbies", "Quiz", "Relatable"];

        const translations = {
            ja: {
                welcome_title: "Welcome to Mix Vote", 
                tos_content: `<p>安全なコミュニティ維持のため、ガイドラインに同意してください。</p><ul class="list-disc list-inside space-y-2"><li>他者の意見を尊重し、誹謗中傷は行わないでください。</li><li>二重投票や不正操作は禁止されています。</li><li>アンケート作成やコメントにはGoogleログインが必要です。</li></ul>`, 
                agree_btn: "同意して入室", login: "ログイン", logout: "ログアウト", welcome_user: "ようこそ", home: "ホーム", created_polls: "作成したアンケート", voted_polls: "投票済みアンケート", new_poll: "新規作成", language: "言語設定", categories: "カテゴリー", back: "戻る", discussion: "ディスカッション", post: "投稿する", create_poll: "アンケート作成", edit_poll: "アンケート編集", label_title: "タイトル", label_desc: "説明文", label_category: "カテゴリー", label_deadline: "投票期限", label_options: "選択肢 (最大50個)", save_poll: "保存する", cancel: "キャンセル", save: "保存", confirm: "確定", close: "閉じる", delete_poll: "アンケートを削除", archive_btn: "アーカイブ", permanent_delete_btn: "永久削除", votes: "票", latest_polls: "最新のアンケート", popular_polls: "人気のアンケート", all: "全て", notice: "お知らせ", select: "選択", delete_confirm_text: "このアンケートをどう処理しますか？", permission_denied: "権限がありません。", vote_success: "投票しました！", already_voted: "既に投票済みです。", deadline_passed: "投票期限が切れています。"
            },
            en: {
                welcome_title: "Welcome to Mix Vote", tos_content: `<p>Agree to guidelines to join.</p><ul class="list-disc list-inside space-y-2"><li>Respect others.</li><li>No double voting.</li><li>Sign in to create/comment.</li></ul>`, agree_btn: "Agree & Enter", login: "Sign In", logout: "Log Out", welcome_user: "Welcome", home: "Home", created_polls: "Created Polls", voted_polls: "Voted Polls", new_poll: "New Poll", language: "Language", categories: "Categories", back: "Back", discussion: "Discussion", post: "Post", create_poll: "Create Poll", edit_poll: "Edit Poll", label_title: "Title", label_desc: "Description", label_category: "Category", label_deadline: "Deadline", label_options: "Options (Max 50)", save_poll: "Save Poll", cancel: "Cancel", save: "Save", confirm: "Confirm", close: "Close", delete_poll: "Delete Poll", archive_btn: "Archive", permanent_delete_btn: "Permanent Delete", votes: "Votes", latest_polls: "Latest Polls", popular_polls: "Popular Polls", all: "All", notice: "Notice", select: "Select", delete_confirm_text: "How to process this poll?", permission_denied: "Permission denied.", vote_success: "Voted!", already_voted: "Already voted.", deadline_passed: "Deadline passed."
            }
        };

        const escapeHTML = (s = '') => typeof s !== 'string' ? '' : s.replace(/[&<>"']/g, m => ({'&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'}[m]));
        function i18n(key) { return (translations[currentLang] && translations[currentLang][key]) || key; }

        function showMsg(titleKey, body, showConfirm = false, onConfirm = null) {
            const modal = document.getElementById('msgModal');
            document.getElementById('msgTitle').textContent = i18n(titleKey);
            document.getElementById('msgBody').textContent = body;
            const confirmBtn = document.getElementById('msgConfirmBtn');
            if (showConfirm) {
                confirmBtn.classList.remove('hidden');
                confirmBtn.onclick = () => { onConfirm?.(); window.closeMsgModal(); };
            } else {
                confirmBtn.classList.add('hidden');
            }
            modal.classList.remove('hidden');
        }

        window.closeMsgModal = () => document.getElementById('msgModal').classList.add('hidden');

        function updateUIStrings() {
            document.querySelectorAll('.i18n').forEach(el => { el.textContent = i18n(el.getAttribute('data-key')); });
            document.querySelectorAll('.i18n-html').forEach(el => { el.innerHTML = i18n(el.getAttribute('data-key')); });
            setupCategoryMenu();
        }

        function setupCategoryMenu() {
            const nav = document.getElementById('categoryNav'), select = document.getElementById('pollCategoryInput');
            if (!nav || !select) return; nav.innerHTML = ''; select.innerHTML = '';
            const items = [{ id: "__ALL__", label: i18n('all') }];
            items.forEach(item => {
                const btn = document.createElement('button');
                btn.className = `nav-link px-4 py-3 rounded-xl text-xs font-bold uppercase transition-all text-left ${selectedCategory === item.id ? 'active' : 'opacity-40 hover:opacity-100'}`;
                btn.textContent = item.label; btn.onclick = () => { selectedCategory = item.id; setupCategoryMenu(); goHome(); };
                nav.appendChild(btn);
            });
            (currentLang === 'ja' ? CATEGORIES_JA : CATEGORIES_EN).forEach((catLabel, idx) => {
                const internalName = CATEGORIES_JA[idx];
                const btn = document.createElement('button');
                btn.className = `nav-link px-4 py-3 rounded-xl text-xs font-bold uppercase transition-all text-left ${selectedCategory === internalName ? 'active' : 'opacity-40 hover:opacity-100'}`;
                btn.textContent = catLabel; btn.onclick = () => { selectedCategory = internalName; setupCategoryMenu(); goHome(); };
                nav.appendChild(btn);
                const opt = document.createElement('option'); opt.value = internalName; opt.textContent = catLabel; select.appendChild(opt);
            });
        }

        function goHome() { 
            window.location.hash = ''; 
            document.querySelectorAll('.view-content').forEach(v => v.classList.add('hidden')); 
            document.getElementById('view-home').classList.remove('hidden'); 
            applyFilters(); 
        }

        function applyFilters() {
            let polls = allPollsCache.filter(p => !p.deleted);
            if (selectedCategory !== "__ALL__") polls = polls.filter(p => p.category === selectedCategory);
            polls.sort((a,b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
            renderPolls(polls);
        }

        function renderPolls(polls) {
            const fC = document.getElementById('latestPollsFeatured'), mC = document.getElementById('latestPollsMore');
            fC.innerHTML = ''; mC.innerHTML = '';
            polls.forEach((p, i) => {
                const div = document.createElement('div');
                div.className = "poll-card glass-panel rounded-[24px] p-6 cursor-pointer flex flex-col group";
                div.onclick = () => window.loadPollDetail(p.id);
                div.innerHTML = `<span class="text-[9px] font-black mb-3 text-[color:var(--accent)] uppercase">${escapeHTML(p.category)}</span><h3 class="text-lg font-black leading-tight">${escapeHTML(p.title)}</h3>`;
                if (i < 3) fC.appendChild(div); else mC.appendChild(div);
            });
        }

        // 期日入力の表示更新用イベントリスナー
        document.getElementById('pollDeadlineInput').addEventListener('input', function() {
            const display = document.getElementById('deadlineDisplay');
            if (this.value) {
                const date = new Date(this.value);
                display.textContent = date.toLocaleString(currentLang === 'ja' ? 'ja-JP' : 'en-US', {
                    year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'
                });
            } else {
                display.textContent = i18n('select');
            }
        });

        window.openCreateModal = () => {
            if (!currentUser || currentUser.isAnonymous) return showMsg('notice', 'ログインが必要です。');
            // リセット処理
            document.getElementById('pollTitleInput').value = '';
            document.getElementById('pollDescInput').value = '';
            document.getElementById('pollOptionsInput').value = '';
            document.getElementById('pollDeadlineInput').value = '';
            document.getElementById('deadlineDisplay').textContent = i18n('select');
            
            document.getElementById('createModal').classList.remove('hidden');
        };
        
        window.closeCreateModal = () => document.getElementById('createModal').classList.add('hidden');

        window.savePoll = async () => {
            const title = document.getElementById('pollTitleInput').value.trim();
            const options = document.getElementById('pollOptionsInput').value.trim().split('\n').filter(o => o.trim());
            if (!title || options.length < 2) return showMsg('notice', 'タイトルと2つ以上の選択肢が必要です。');

            document.getElementById('saveBtnSpinner').classList.remove('hidden');
            try {
                const dl = document.getElementById('pollDeadlineInput').value;
                await addDoc(collection(db, ...POLLS_PATH), {
                    title,
                    question: document.getElementById('pollDescInput').value.trim(),
                    options,
                    votes: new Array(options.length).fill(0),
                    votedUsers: [],
                    category: document.getElementById('pollCategoryInput').value,
                    authorID: currentUser.uid,
                    authorName: currentUser.displayName,
                    createdAt: serverTimestamp(),
                    deadline: dl ? Timestamp.fromDate(new Date(dl)) : null,
                    deleted: false
                });
                window.closeCreateModal();
                showMsg('notice', i18n('vote_success'));
            } catch (e) {
                showMsg('notice', i18n('permission_denied'));
            }
            document.getElementById('saveBtnSpinner').classList.add('hidden');
        };

        window.loadPollDetail = async (id) => {
            currentPollId = id;
            const docRef = doc(db, ...POLLS_PATH, id);
            const snap = await getDoc(docRef);
            if (!snap.exists()) return goHome();
            const p = snap.data();
            currentPollData = p;

            window.location.hash = `poll/${id}`;
            document.querySelectorAll('.view-content').forEach(v => v.classList.add('hidden'));
            document.getElementById('view-detail').classList.remove('hidden');

            const totalVotes = p.votes.reduce((a, b) => a + b, 0);
            const detail = document.getElementById('pollDetailContent');
            detail.innerHTML = `
                <div class="mb-8">
                    <span class="bg-[color:var(--accent)]/10 text-[color:var(--accent)] text-[10px] font-black px-3 py-1 rounded-full uppercase mb-4 inline-block">${escapeHTML(p.category)}</span>
                    <h2 class="text-2xl font-black mb-4">${escapeHTML(p.title)}</h2>
                    <p class="opacity-60 text-sm leading-relaxed">${escapeHTML(p.question || "")}</p>
                </div>
                <div id="voteOptions" class="space-y-3"></div>
            `;

            const opts = document.getElementById('voteOptions');
            p.options.forEach((opt, idx) => {
                const count = p.votes[idx] || 0;
                const percent = totalVotes > 0 ? Math.round((count / totalVotes) * 100) : 0;
                const div = document.createElement('div');
                div.className = "vote-bar-bg";
                div.onclick = () => window.vote(idx);
                div.innerHTML = `
                    <div class="vote-bar-fill" style="width: ${percent}%"></div>
                    <div class="vote-bar-content">
                        <span>${escapeHTML(opt)}</span>
                        <span>${percent}% (${count}${i18n('votes')})</span>
                    </div>
                `;
                opts.appendChild(div);
            });

            const ctrl = document.getElementById('adminControls');
            ctrl.innerHTML = '';
            if (isAdmin || (currentUser && currentUser.uid === p.authorID)) {
                const delBtn = document.createElement('button');
                delBtn.className = "bg-red-500/20 text-red-500 px-4 py-2 rounded-xl text-[10px] font-black uppercase";
                delBtn.textContent = i18n('delete_poll');
                delBtn.onclick = () => window.openDeleteModal();
                ctrl.appendChild(delBtn);
            }

            loadComments(id);
        };

        window.vote = async (idx) => {
            if (!currentUser) return showMsg('notice', '投票にはログインが必要です。');
            if (currentPollData.votedUsers.includes(currentUser.uid)) return showMsg('notice', i18n('already_voted'));
            if (currentPollData.deadline && currentPollData.deadline.toDate() < new Date()) return showMsg('notice', i18n('deadline_passed'));

            const docRef = doc(db, ...POLLS_PATH, currentPollId);
            try {
                await runTransaction(db, async (transaction) => {
                    const snap = await transaction.get(docRef);
                    const data = snap.data();
                    const newVotes = [...data.votes];
                    newVotes[idx] += 1;
                    transaction.update(docRef, {
                        votes: newVotes,
                        votedUsers: arrayUnion(currentUser.uid)
                    });
                });
                window.loadPollDetail(currentPollId);
            } catch (e) {
                showMsg('notice', i18n('permission_denied'));
            }
        };

        async function loadComments(pollId) {
            const list = document.getElementById('commentsList');
            list.innerHTML = '<div class="spinner w-5 h-5 border-2 border-[color:var(--accent)] border-t-transparent rounded-full mx-auto"></div>';
            
            if (unsubscribeComments) unsubscribeComments();
            const q = query(collection(db, ...POLLS_PATH, pollId, 'comments'), orderBy('createdAt', 'desc'));
            unsubscribeComments = onSnapshot(q, (snap) => {
                list.innerHTML = '';
                if (snap.empty) {
                    list.innerHTML = '<p class="text-center opacity-30 text-xs py-10">No comments yet.</p>';
                }
                snap.forEach(d => {
                    const c = d.data();
                    const div = document.createElement('div');
                    div.className = "bg-white/5 p-4 rounded-2xl border border-white/5";
                    div.innerHTML = `
                        <div class="flex justify-between items-start mb-2">
                            <span class="text-[10px] font-black text-[color:var(--accent)] uppercase">${escapeHTML(c.userName)}</span>
                            <span class="text-[9px] opacity-40">${c.createdAt?.toDate().toLocaleString() || ""}</span>
                        </div>
                        <p class="text-sm opacity-80">${escapeHTML(c.text)}</p>
                    `;
                    list.appendChild(div);
                });
            });
        }

        window.postComment = async () => {
            const text = document.getElementById('commentText').value.trim();
            if (!text || !currentUser) return;
            const btn = document.getElementById('postCommentBtn');
            btn.disabled = true;
            try {
                await addDoc(collection(db, ...POLLS_PATH, currentPollId, 'comments'), {
                    userId: currentUser.uid,
                    userName: currentUser.displayName || "Anonymous",
                    text: text,
                    createdAt: serverTimestamp()
                });
                document.getElementById('commentText').value = '';
            } catch (e) {
                showMsg('notice', i18n('permission_denied'));
            }
            btn.disabled = false;
        };

        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            const authArea = document.getElementById('authArea');
            const loginBtn = document.getElementById('loginBtn');
            const userInfo = document.getElementById('userInfo');
            const commentInput = document.getElementById('commentInputArea');

            if (user && !user.isAnonymous) {
                loginBtn.classList.add('hidden');
                userInfo.classList.remove('hidden');
                document.getElementById('userName').textContent = user.displayName;
                if (user.photoURL) {
                    document.getElementById('userAvatar').innerHTML = `<img src="${user.photoURL}" class="w-full h-full object-cover">`;
                }
                document.getElementById('userNavGroup').classList.remove('hidden');
                commentInput.classList.remove('hidden');
                
                getIdTokenResult(user).then(res => {
                    isAdmin = !!res.claims.admin;
                });
            } else {
                loginBtn.classList.remove('hidden');
                userInfo.classList.add('hidden');
                document.getElementById('userNavGroup').classList.add('hidden');
                commentInput.classList.add('hidden');
            }
            document.getElementById('appUI').classList.remove('hidden');
        });

        document.getElementById('loginBtn').onclick = () => signInWithPopup(auth, new GoogleAuthProvider());
        document.getElementById('logoutBtn').onclick = () => signOut(auth);
        document.getElementById('agreeTosBtn').onclick = () => {
            localStorage.setItem('mixvote_agreed', 'true');
            document.getElementById('tosModal').classList.add('hidden');
            goHome();
        };

        window.changeLang = (lang) => {
            currentLang = lang;
            updateUIStrings();
            if (currentPollId) window.loadPollDetail(currentPollId);
            applyFilters();
        };

        if (localStorage.getItem('mixvote_agreed') !== 'true') {
            document.getElementById('tosModal').classList.remove('hidden');
        }

        onSnapshot(collection(db, ...POLLS_PATH), (snap) => {
            allPollsCache = snap.docs.map(d => ({ id: d.id, ...d.data() }));
            applyFilters();
        });

        updateUIStrings();

    </script>
</body>
</html>