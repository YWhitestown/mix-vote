<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mix Vote - Next Gen Voting</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&family=Noto+Sans+JP:wght@400;700&display=swap');
        
        :root {
            --accent: #06b6d4;
            --accent-glow: rgba(6, 182, 212, 0.4);
            --bg-dark: #020617;
        }

        body { 
            font-family: 'Plus Jakarta Sans', 'Noto Sans JP', sans-serif; 
            background-color: var(--bg-dark); 
            color: #f1f5f9;
            overflow-x: hidden;
        }

        .glass { 
            background: rgba(15, 23, 42, 0.6); 
            backdrop-filter: blur(12px); 
            border: 1px solid rgba(255, 255, 255, 0.08); 
        }

        .glass-panel {
            background: linear-gradient(145deg, rgba(30, 41, 59, 0.4), rgba(15, 23, 42, 0.6));
            backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .poll-card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .poll-card:hover {
            transform: translateY(-4px);
            border-color: var(--accent);
            box-shadow: 0 10px 30px -10px var(--accent-glow);
        }

        .btn-glow {
            position: relative;
            overflow: hidden;
            transition: transform 0.2s;
        }
        .btn-glow:active { transform: scale(0.96); }
        .btn-glow::after {
            content: '';
            position: absolute;
            top: -50%; left: -50%;
            width: 200%; height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255,255,255,0.1), transparent);
            transform: rotate(45deg);
            transition: 0.6s;
        }
        .btn-glow:hover::after { left: 120%; }

        .custom-scrollbar::-webkit-scrollbar { width: 4px; height: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: rgba(255,255,255,0.02); }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
        
        .nav-link.active {
            background: linear-gradient(90deg, var(--accent), #3b82f6);
            color: #020617;
            box-shadow: 0 0 15px var(--accent-glow);
        }

        input[type="datetime-local"]::-webkit-calendar-picker-indicator {
            filter: invert(1) brightness(2);
            cursor: pointer;
        }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade { animation: fadeIn 0.4s ease-out forwards; }
    </style>
</head>
<body class="min-h-screen selection:bg-cyan-500 selection:text-slate-900">

    <!-- Auth & Global UI -->
    <div id="tosModal" class="fixed inset-0 z-[100] hidden flex items-center justify-center bg-black/90 backdrop-blur-md p-4">
        <div class="glass max-w-xl w-full rounded-3xl p-8 shadow-2xl border border-cyan-500/20">
            <div class="flex items-center gap-4 mb-6">
                <div class="w-12 h-12 bg-cyan-500 rounded-xl flex items-center justify-center text-slate-950">
                    <i data-lucide="shield-check"></i>
                </div>
                <div>
                    <h2 class="text-2xl font-black text-white italic uppercase">Mix Vote <span class="text-cyan-400">Policy</span></h2>
                    <p class="text-xs text-slate-400 font-bold uppercase tracking-widest">Community Rules</p>
                </div>
            </div>
            <div class="space-y-4 text-sm text-slate-300 leading-relaxed mb-8 max-h-[40vh] overflow-y-auto custom-scrollbar pr-2">
                <div class="p-4 rounded-xl bg-white/5 border border-white/5">
                    <h4 class="font-bold text-cyan-400 mb-1">Respect & Integrity</h4>
                    <p class="text-xs">Ë™πË¨ó‰∏≠ÂÇ∑„ÄÅÂ∑ÆÂà•„ÄÅÂ´å„Åå„Çâ„ÅõÁõÆÁöÑ„ÅÆÊäïÁ®ø„ÅØÁ¶ÅÊ≠¢„Åß„Åô„ÄÇÂ∏∏„Å´Âª∫Ë®≠ÁöÑ„Å™ÂØæË©±„ÇíÂøÉ„Åå„Åë„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ</p>
                </div>
                <div class="p-4 rounded-xl bg-white/5 border border-white/5">
                    <h4 class="font-bold text-cyan-400 mb-1">Fair Voting</h4>
                    <p class="text-xs">‰∏çÊ≠£„Å™Â§öÈáçÊäïÁ•®„ÇÑ„Ç∑„Çπ„ÉÜ„É†„ÅÆËÑÜÂº±ÊÄß„ÇíÁ™Å„ÅèË°åÁÇ∫„ÅØÂé≥Á¶Å„Åß„Åô„ÄÇÂÖ¨Âπ≥„Å™„Éó„É©„ÉÉ„Éà„Éï„Ç©„Éº„É†Á∂≠ÊåÅ„Å´„ÅîÂçîÂäõ„Åè„Å†„Åï„ÅÑ„ÄÇ</p>
                </div>
            </div>
            <button id="agreeTosBtn" class="btn-glow w-full bg-cyan-500 text-slate-950 font-black py-4 rounded-xl uppercase tracking-widest text-xs">
                I Agree & Proceed
            </button>
        </div>
    </div>

    <!-- Message Modal -->
    <div id="msgModal" class="fixed inset-0 z-[200] hidden flex items-center justify-center bg-black/80 backdrop-blur-sm p-4">
        <div class="glass max-w-sm w-full rounded-3xl p-6 text-center border border-white/10 shadow-2xl">
            <h3 id="msgTitle" class="text-lg font-black mb-2 uppercase italic text-white">Message</h3>
            <p id="msgBody" class="text-slate-400 text-xs mb-6"></p>
            <div class="flex gap-3">
                <button id="msgCloseBtn" class="flex-1 bg-white/5 text-white font-bold py-3 rounded-xl uppercase text-[10px] tracking-widest">Close</button>
                <button id="msgConfirmBtn" class="flex-1 bg-cyan-500 text-slate-950 font-black py-3 rounded-xl uppercase text-[10px] tracking-widest hidden">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Main Layout -->
    <div id="appContainer" class="hidden flex flex-col min-h-screen">
        <!-- Header -->
        <header class="sticky top-0 z-50 glass border-b border-white/5 px-4 md:px-8 py-4 backdrop-blur-xl">
            <div class="max-w-7xl mx-auto flex items-center justify-between gap-4">
                <div class="flex items-center gap-3 cursor-pointer group" onclick="navigate('home')">
                    <div class="w-10 h-10 bg-gradient-to-br from-cyan-400 to-blue-600 rounded-xl flex items-center justify-center shadow-lg shadow-cyan-500/20 group-hover:rotate-12 transition-transform text-slate-950">
                        <i data-lucide="zap"></i>
                    </div>
                    <div class="hidden sm:block">
                        <h1 class="text-xl font-black tracking-tighter text-white uppercase italic leading-none">Mix <span class="text-cyan-400">Vote</span></h1>
                        <p class="text-[8px] text-slate-500 font-bold uppercase tracking-[0.2em]">Open Society</p>
                    </div>
                </div>

                <div class="flex-1 max-w-md relative group">
                    <input type="text" id="globalSearch" class="w-full bg-slate-900/80 border border-white/10 rounded-2xl py-2 pl-10 pr-4 text-xs text-white outline-none focus:border-cyan-500 transition-all" placeholder="Search polls...">
                    <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-500"></i>
                </div>

                <div id="authSlot" class="flex items-center gap-3">
                    <button id="loginBtn" class="glass px-4 py-2 rounded-xl text-white font-black text-[10px] uppercase tracking-widest hover:bg-white/10 transition-all border border-white/10 flex items-center gap-2">
                        <i class="fab fa-google text-cyan-400"></i> <span>Sign In</span>
                    </button>
                    <div id="userProfile" class="hidden flex items-center gap-3">
                        <div class="text-right hidden md:block leading-tight">
                            <p class="text-[8px] text-slate-500 font-bold uppercase">Member</p>
                            <p id="displayUserName" class="text-[11px] font-black text-white"></p>
                        </div>
                        <button onclick="navigate('mypage')" class="w-9 h-9 rounded-full bg-slate-800 border border-white/10 flex items-center justify-center text-cyan-400 hover:scale-105 transition-all">
                            <i data-lucide="user" class="w-5 h-5"></i>
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <div class="max-w-7xl mx-auto w-full px-4 md:px-8 py-8 grid grid-cols-1 lg:grid-cols-12 gap-8 flex-grow">
            <!-- Sidebar -->
            <aside class="lg:col-span-3 space-y-6">
                <nav class="space-y-1">
                    <button onclick="navigate('home')" class="nav-btn w-full flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-bold text-slate-400 hover:text-white hover:bg-white/5 transition-all">
                        <i data-lucide="home" class="w-4 h-4"></i> Home
                    </button>
                    <button id="myPollsBtn" onclick="navigate('mypage')" class="nav-btn hidden w-full flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-bold text-slate-400 hover:text-white hover:bg-white/5 transition-all">
                        <i data-lucide="layout-grid" class="w-4 h-4"></i> My Activity
                    </button>
                </nav>

                <button id="createPollBtn" class="btn-glow hidden w-full bg-cyan-500 text-slate-950 font-black py-4 rounded-2xl flex items-center justify-center gap-3 shadow-lg shadow-cyan-500/20 uppercase tracking-widest text-xs">
                    <i data-lucide="plus-circle" class="w-4 h-4"></i> New Poll
                </button>

                <div class="glass rounded-3xl p-5">
                    <p class="text-[10px] font-black uppercase text-slate-500 tracking-[0.2em] mb-4 pl-1">Categories</p>
                    <div id="categoryList" class="flex flex-wrap lg:flex-col gap-1"></div>
                </div>
                
                <div class="p-4 text-[10px] text-slate-600 font-medium">
                    <p>&copy; 2025 Mix Vote Engine.</p>
                </div>
            </aside>

            <!-- Main Content Area -->
            <main class="lg:col-span-9">
                <!-- View: Home -->
                <div id="view-home" class="view space-y-10 animate-fade">
                    <div class="glass-panel p-6 rounded-3xl border-l-4 border-cyan-500">
                        <div class="flex items-start gap-4">
                            <div class="w-10 h-10 rounded-xl bg-cyan-500/10 flex items-center justify-center text-cyan-400 shrink-0">
                                <i data-lucide="sparkles"></i>
                            </div>
                            <div>
                                <h3 class="text-white font-bold text-sm mb-1">Decide Together.</h3>
                                <p class="text-slate-400 text-xs leading-relaxed">
                                    ÂåøÂêç„Åß„ÅÆÊäïÁ•®„ÅåÂèØËÉΩ„Åß„Åô„ÄÇ‰ΩúÊàê„ÇÑ„Ç≥„É°„É≥„Éà„Å´„ÅØ„É≠„Ç∞„Ç§„É≥„ÅåÂøÖË¶Å„Åß„Åô„ÄÇ‰∏çÈÅ©Âàá„Å™ÊäïÁ®ø„ÇíÁô∫Ë¶ã„Åó„ÅüÂ†¥Âêà„ÅØÈÄöÂ†±„Éú„Çø„É≥„Çí„ÅîÊ¥ªÁî®„Åè„Å†„Åï„ÅÑ„ÄÇ
                                </p>
                            </div>
                        </div>
                    </div>

                    <section>
                        <div class="flex items-center justify-between mb-6">
                            <h2 class="text-2xl font-black text-white italic uppercase tracking-tighter">Featured <span class="text-slate-600 not-italic font-normal">Polls</span></h2>
                            <div class="flex items-center gap-2 px-3 py-1 bg-cyan-500/10 border border-cyan-500/20 rounded-full">
                                <span class="w-1.5 h-1.5 bg-cyan-400 rounded-full animate-pulse"></span>
                                <span class="text-[9px] font-bold text-cyan-400 uppercase tracking-widest">Live Now</span>
                            </div>
                        </div>
                        <div id="trendingGrid" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
                    </section>

                    <section>
                        <h2 class="text-2xl font-black text-white italic uppercase tracking-tighter mb-6">Latest <span class="text-slate-600 not-italic font-normal">Topics</span></h2>
                        <div id="latestGrid" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
                    </section>
                </div>

                <!-- View: Detail -->
                <div id="view-detail" class="view hidden space-y-8 animate-fade">
                    <button onclick="navigate('home')" class="flex items-center gap-2 text-slate-500 hover:text-white text-[10px] font-black uppercase tracking-widest transition-all">
                        <i data-lucide="arrow-left" class="w-4 h-4"></i> Back to Explore
                    </button>

                    <div id="pollDetailContent" class="glass-panel rounded-[2rem] p-6 md:p-10 shadow-2xl relative"></div>

                    <div class="glass rounded-[2rem] p-8 border border-white/5">
                        <div class="flex items-center justify-between mb-6">
                            <h3 class="text-lg font-black text-white uppercase tracking-widest flex items-center gap-3">
                                <span class="w-1.5 h-6 bg-cyan-500 rounded-full"></span> Comments
                            </h3>
                        </div>
                        <div id="commentSection" class="space-y-6">
                            <div id="commentAuthGuard" class="p-6 bg-white/5 border border-dashed border-white/10 rounded-2xl text-center">
                                <p class="text-slate-400 text-xs">„É≠„Ç∞„Ç§„É≥„Åó„Å¶„Ç≥„É°„É≥„Éà„Å´ÂèÇÂä†„Åó„Åæ„Åó„Çá„ÅÜ„ÄÇ</p>
                            </div>
                            <div id="commentInputArea" class="hidden space-y-3">
                                <textarea id="commentInput" maxlength="200" class="w-full bg-slate-900 border border-white/10 rounded-2xl p-4 text-sm text-white focus:border-cyan-500 outline-none h-24" placeholder="Share your thoughts..."></textarea>
                                <div class="flex justify-end">
                                    <button id="postCommentBtn" class="bg-cyan-500 text-slate-950 px-6 py-2 rounded-xl text-xs font-black uppercase tracking-widest hover:bg-cyan-400 transition-all">Post</button>
                                </div>
                            </div>
                            <div id="commentsList" class="space-y-4"></div>
                        </div>
                    </div>
                </div>

                <!-- View: MyPage -->
                <div id="view-mypage" class="view hidden space-y-8 animate-fade">
                    <div class="flex items-center justify-between mb-8">
                        <div>
                            <h2 class="text-3xl font-black text-white italic uppercase tracking-tighter">My Dashboard</h2>
                            <p class="text-slate-400 text-xs">Manage your posts and interactions.</p>
                        </div>
                        <button onclick="logout()" class="text-slate-500 hover:text-red-400 transition-all"><i data-lucide="log-out"></i></button>
                    </div>
                    <div id="myPollsList" class="grid grid-cols-1 gap-4"></div>
                </div>
            </main>
        </div>
    </div>

    <!-- Create/Edit Modal -->
    <div id="pollModal" class="fixed inset-0 z-[110] hidden flex items-center justify-center bg-black/95 backdrop-blur-xl p-4">
        <div class="glass max-w-lg w-full rounded-[2.5rem] p-8 max-h-[90vh] overflow-y-auto custom-scrollbar border border-white/10">
            <h2 id="modalTitle" class="text-2xl font-black text-white italic uppercase mb-6">Create New Poll</h2>
            <div class="space-y-5">
                <div>
                    <label class="text-[9px] font-black text-slate-500 uppercase tracking-widest block mb-2">Title</label>
                    <input type="text" id="pollTitle" class="w-full bg-slate-900 border border-white/10 rounded-xl p-4 text-white text-sm focus:border-cyan-500 outline-none">
                </div>
                <div>
                    <label class="text-[9px] font-black text-slate-500 uppercase tracking-widest block mb-2">Description</label>
                    <textarea id="pollDesc" class="w-full bg-slate-900 border border-white/10 rounded-xl p-4 text-white text-sm focus:border-cyan-500 outline-none h-20"></textarea>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-[9px] font-black text-slate-500 uppercase tracking-widest block mb-2">Category</label>
                        <select id="pollCategory" class="w-full bg-slate-900 border border-white/10 rounded-xl p-4 text-white text-sm outline-none"></select>
                    </div>
                    <div>
                        <label class="text-[9px] font-black text-slate-500 uppercase tracking-widest block mb-2">End Date</label>
                        <input type="datetime-local" id="pollDeadline" class="w-full bg-slate-900 border border-white/10 rounded-xl p-4 text-white text-sm outline-none">
                    </div>
                </div>
                <div>
                    <label class="text-[9px] font-black text-slate-500 uppercase tracking-widest block mb-2">Options (One per line)</label>
                    <textarea id="pollOptions" class="w-full bg-slate-900 border border-white/10 rounded-xl p-4 text-white text-sm focus:border-cyan-500 outline-none h-32" placeholder="Option A&#10;Option B"></textarea>
                </div>
                <!-- Quiz Extra -->
                <div id="quizFields" class="hidden bg-cyan-500/5 p-4 rounded-2xl border border-cyan-500/20 space-y-4">
                    <div>
                        <label class="text-[9px] font-black text-cyan-400 uppercase tracking-widest block mb-2">Correct Answer Index (0, 1...)</label>
                        <input type="number" id="pollCorrectIndex" class="w-full bg-slate-900 border border-white/10 rounded-xl p-3 text-white text-xs outline-none">
                    </div>
                    <div>
                        <label class="text-[9px] font-black text-cyan-400 uppercase tracking-widest block mb-2">Answer Explanation</label>
                        <textarea id="pollExplanation" class="w-full bg-slate-900 border border-white/10 rounded-xl p-3 text-white text-xs outline-none h-16"></textarea>
                    </div>
                </div>
            </div>
            <div class="flex gap-4 mt-8">
                <button onclick="closeModal()" class="flex-1 bg-white/5 text-white font-bold py-4 rounded-2xl text-xs uppercase tracking-widest">Cancel</button>
                <button id="savePollBtn" class="flex-1 bg-cyan-500 text-slate-950 font-black py-4 rounded-2xl text-xs uppercase tracking-widest shadow-lg shadow-cyan-500/20">Publish</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js';
        import { getAuth, onAuthStateChanged, signInAnonymously, signInWithPopup, GoogleAuthProvider, signInWithCustomToken } from 'https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js';
        import { getFirestore, collection, doc, addDoc, updateDoc, deleteDoc, onSnapshot, serverTimestamp, arrayUnion, arrayRemove, increment } from 'https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js';

        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'mixvote-default';

        // Paths
        const POLLS_PATH = `artifacts/${appId}/public/data/polls`;
        const REPORTS_PATH = `artifacts/${appId}/public/data/reports`;

        const CATEGORIES = ["„Éã„É•„Éº„Çπ", "„Ç®„É≥„Çø„É°", "„ÉÜ„ÇØ„Éé„É≠„Ç∏„Éº", "ÁîüÊ¥ª", "„ÇØ„Ç§„Ç∫", "Ë∂£Âë≥", "ÊïôËÇ≤", "ÊîøÊ≤ª", "„Ç∞„É´„É°"];

        // State
        let currentUser = null;
        let activeView = 'home';
        let polls = [];
        let chartInstance = null;
        let selectedPollId = null;
        let editPollId = null;

        // --- Core Functions ---

        async function initAuth() {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                await signInWithCustomToken(auth, __initial_auth_token);
            } else {
                await signInAnonymously(auth);
            }
        }

        function maskName(name) {
            if (!name) return 'User-' + Math.random().toString(36).substr(2, 4);
            return name.length > 5 ? name.substring(0, 3) + '***' : name;
        }

        function showMessage(title, body, confirmFn = null) {
            const modal = document.getElementById('msgModal');
            document.getElementById('msgTitle').innerText = title;
            document.getElementById('msgBody').innerText = body;
            const cf = document.getElementById('msgConfirmBtn');
            if (confirmFn) {
                cf.classList.remove('hidden');
                cf.onclick = () => { confirmFn(); modal.classList.add('hidden'); };
            } else {
                cf.classList.add('hidden');
            }
            modal.classList.remove('hidden');
        }

        // --- Navigation ---
        window.navigate = (view, id = null) => {
            document.querySelectorAll('.view').forEach(v => v.classList.add('hidden'));
            document.getElementById(`view-${view}`).classList.remove('hidden');
            activeView = view;
            selectedPollId = id;
            if (view === 'detail' && id) renderDetail(id);
            if (view === 'mypage') renderMyPage();
            window.scrollTo(0, 0);
        };

        // --- Data Handling ---
        function syncPolls() {
            onSnapshot(collection(db, POLLS_PATH), (snap) => {
                polls = snap.docs.map(d => ({ id: d.id, ...d.data() })).filter(p => !p.deleted);
                renderLists();
                if (selectedPollId) renderDetail(selectedPollId);
            });
        }

        function renderLists() {
            const search = document.getElementById('globalSearch').value.toLowerCase();
            const filtered = polls.filter(p => p.title.toLowerCase().includes(search));
            
            const trending = [...filtered].sort((a,b) => {
                const scoreA = (a.votes?.reduce((s,v)=>s+v,0)||0) + (a.likes?.length||0)*2;
                const scoreB = (b.votes?.reduce((s,v)=>s+v,0)||0) + (b.likes?.length||0)*2;
                return scoreB - scoreA;
            }).slice(0, 4);

            const latest = [...filtered].sort((a,b) => (b.createdAt?.seconds||0) - (a.createdAt?.seconds||0)).slice(0, 10);

            document.getElementById('trendingGrid').innerHTML = trending.map(p => pollCardHtml(p)).join('');
            document.getElementById('latestGrid').innerHTML = latest.map(p => pollCardHtml(p)).join('');
        }

        function pollCardHtml(p) {
            const total = p.votes?.reduce((s,v)=>s+v,0)||0;
            return `
                <div class="poll-card glass p-6 rounded-3xl cursor-pointer border border-white/5 group" onclick="navigate('detail', '${p.id}')">
                    <div class="flex justify-between items-start mb-4">
                        <span class="text-[8px] font-black px-2 py-1 bg-cyan-500/10 text-cyan-400 rounded-md uppercase tracking-widest">${p.category}</span>
                        <div class="flex items-center gap-2 text-slate-600 text-[10px] font-bold">
                            <i class="far fa-heart"></i> ${p.likes?.length||0}
                        </div>
                    </div>
                    <h3 class="text-lg font-bold text-white mb-2 line-clamp-2 group-hover:text-cyan-400 transition-colors">${p.title}</h3>
                    <div class="flex items-center justify-between mt-6 pt-4 border-t border-white/5">
                        <span class="text-[9px] font-bold text-slate-500 italic">@${maskName(p.author)}</span>
                        <span class="text-xs font-black text-white">${total} <span class="text-[10px] text-slate-600">Votes</span></span>
                    </div>
                </div>
            `;
        }

        async function renderDetail(id) {
            const p = polls.find(x => x.id === id);
            if (!p) return;

            const total = p.votes?.reduce((s,v)=>s+v,0)||0;
            const hasVoted = p.voters?.includes(currentUser.uid);
            const isAuthor = p.authorId === currentUser.uid;
            const isEnded = p.deadline && new Date(p.deadline) < new Date();
            const showRes = hasVoted || isEnded || isAuthor;

            const content = document.getElementById('pollDetailContent');
            content.innerHTML = `
                <div class="flex flex-col md:flex-row justify-between items-start gap-8">
                    <div class="flex-1 space-y-4">
                        <div class="flex items-center gap-3">
                            <span class="text-[10px] font-black px-3 py-1 bg-cyan-500 text-slate-950 rounded-full uppercase tracking-widest">${p.category}</span>
                            ${isEnded ? '<span class="text-[10px] text-red-400 font-bold uppercase"><i class="fas fa-clock"></i> Ended</span>' : '<span class="text-[10px] text-emerald-400 font-bold uppercase"><i class="fas fa-circle text-[6px]"></i> Active</span>'}
                        </div>
                        <h2 class="text-3xl md:text-4xl font-black text-white leading-tight">${p.title}</h2>
                        <p class="text-slate-400 text-sm leading-relaxed">${p.description || ''}</p>
                        
                        <div class="flex items-center gap-4 py-4">
                            <button onclick="toggleLike('${p.id}')" class="flex items-center gap-2 px-4 py-2 glass rounded-xl border border-white/5 hover:border-pink-500/50 transition-all text-pink-400 text-xs font-black">
                                <i class="${p.likes?.includes(currentUser.uid) ? 'fas' : 'far'} fa-heart"></i> ${p.likes?.length||0}
                            </button>
                            <button onclick="copyLink('${p.id}')" class="text-slate-500 hover:text-white text-xs font-bold uppercase tracking-widest flex items-center gap-2"><i class="fas fa-share-alt"></i> Share</button>
                            <button onclick="report('${p.id}', 'poll')" class="text-slate-700 hover:text-red-400 text-[9px] uppercase"><i class="fas fa-flag"></i> Report</button>
                        </div>
                    </div>

                    <div class="w-full md:w-80 space-y-3">
                        ${p.options.map((opt, i) => {
                            const v = p.votes[i]||0;
                            const perc = total > 0 ? Math.round((v/total)*100) : 0;
                            if (showRes) {
                                return `
                                    <div class="relative overflow-hidden bg-white/5 border border-white/5 rounded-2xl p-4 flex justify-between items-center group">
                                        <div class="absolute inset-y-0 left-0 bg-cyan-500/10 transition-all duration-1000" style="width: ${perc}%"></div>
                                        <span class="z-10 text-sm font-bold text-slate-300">${opt}</span>
                                        <div class="z-10 text-right"><div class="text-lg font-black text-white">${perc}%</div></div>
                                    </div>
                                `;
                            }
                            return `
                                <button onclick="vote('${p.id}', ${i})" class="w-full bg-white/5 border border-white/10 p-5 rounded-2xl text-left hover:border-cyan-500 hover:bg-white/10 transition-all group flex items-center justify-between">
                                    <span class="text-sm font-bold text-white">${opt}</span>
                                    <i class="fas fa-chevron-right text-slate-700 group-hover:text-cyan-400"></i>
                                </button>
                            `;
                        }).join('')}
                    </div>
                </div>
                ${showRes ? `<div class="mt-12 h-64"><canvas id="detailChart"></canvas></div>` : ''}
            `;

            if (showRes) renderChart(p);
            loadComments(id);
        }

        function renderChart(p) {
            const ctx = document.getElementById('detailChart').getContext('2d');
            if (chartInstance) chartInstance.destroy();
            chartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: p.options,
                    datasets: [{
                        data: p.votes,
                        backgroundColor: '#06b6d4',
                        borderRadius: 10
                    }]
                },
                options: {
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#64748b' } },
                        x: { grid: { display: false }, ticks: { color: '#64748b', font: { size: 10 } } }
                    }
                }
            });
        }

        // --- Interaction Logic ---

        window.vote = async (pid, index) => {
            if (!currentUser) return;
            const ref = doc(db, POLLS_PATH, pid);
            const p = polls.find(x => x.id === pid);
            if (p.voters?.includes(currentUser.uid)) return showMessage("Notice", "You have already voted.");
            
            const newVotes = [...p.votes];
            newVotes[index] = (newVotes[index] || 0) + 1;
            
            await updateDoc(ref, {
                votes: newVotes,
                voters: arrayUnion(currentUser.uid)
            });
        };

        window.toggleLike = async (pid) => {
            if (currentUser.isAnonymous) return showMessage("Member Feature", "Please sign in to like polls.");
            const ref = doc(db, POLLS_PATH, pid);
            const p = polls.find(x => x.id === pid);
            const liked = p.likes?.includes(currentUser.uid);
            await updateDoc(ref, {
                likes: liked ? arrayRemove(currentUser.uid) : arrayUnion(currentUser.uid)
            });
        };

        window.copyLink = (id) => {
            const url = window.location.origin + window.location.pathname + "#" + id;
            const el = document.createElement('textarea');
            el.value = `üó≥Ô∏è Vote on Mix Vote: ${url}`;
            document.body.appendChild(el);
            el.select();
            document.execCommand('copy');
            document.body.removeChild(el);
            showMessage("Link Copied", "Share it with your community!");
        };

        window.report = async (id, type) => {
            const reason = prompt("Report reason (Harassment, Spam, Incorrect info...):");
            if (!reason) return;
            await addDoc(collection(db, REPORTS_PATH), {
                targetId: id,
                type: type,
                reason,
                reporter: currentUser.uid,
                timestamp: serverTimestamp()
            });
            showMessage("Report Sent", "We will review this content.");
        };

        // --- Comments ---
        function loadComments(pid) {
            const list = document.getElementById('commentsList');
            onSnapshot(collection(db, POLLS_PATH, pid, 'comments'), (snap) => {
                const comms = snap.docs.map(d => ({id: d.id, ...d.data()})).sort((a,b) => (b.createdAt?.seconds||0)-(a.createdAt?.seconds||0));
                list.innerHTML = comms.map(c => `
                    <div class="p-4 bg-white/5 rounded-2xl border border-white/5 flex gap-4">
                        <div class="w-8 h-8 rounded-full bg-slate-800 flex items-center justify-center text-[10px] font-black text-cyan-500">${maskName(c.author).charAt(0)}</div>
                        <div class="flex-1">
                            <div class="flex justify-between items-center mb-1">
                                <span class="text-[10px] font-black text-white">@${maskName(c.author)}</span>
                                <span class="text-[8px] text-slate-600 font-bold">${c.createdAt ? new Date(c.createdAt.seconds*1000).toLocaleDateString() : 'Just now'}</span>
                            </div>
                            <p class="text-xs text-slate-400 leading-relaxed">${c.text}</p>
                        </div>
                    </div>
                `).join('') || '<p class="text-center text-slate-700 text-[9px] uppercase font-bold py-10">No discussion yet</p>';
            });
        }

        document.getElementById('postCommentBtn').onclick = async () => {
            if (!selectedPollId || !currentUser) return;
            const text = document.getElementById('commentInput').value.trim();
            if (!text) return;
            await addDoc(collection(db, POLLS_PATH, selectedPollId, 'comments'), {
                text,
                author: currentUser.displayName || 'Anonymous',
                userId: currentUser.uid,
                createdAt: serverTimestamp()
            });
            document.getElementById('commentInput').value = '';
        };

        // --- User Page ---
        function renderMyPage() {
            const list = document.getElementById('myPollsList');
            const myPolls = polls.filter(p => p.authorId === currentUser.uid);
            list.innerHTML = myPolls.length ? myPolls.map(p => `
                <div class="glass p-5 rounded-2xl border border-white/5 flex items-center justify-between gap-4">
                    <div>
                        <h4 class="font-bold text-white mb-1">${p.title}</h4>
                        <div class="flex gap-4 text-[10px] text-slate-500 font-bold uppercase">
                            <span>${p.votes?.reduce((s,v)=>s+v,0)||0} Votes</span>
                            <span>${p.likes?.length||0} Likes</span>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="editPoll('${p.id}')" class="p-2 text-slate-500 hover:text-white"><i data-lucide="edit-3" class="w-4 h-4"></i></button>
                        <button onclick="deletePoll('${p.id}')" class="p-2 text-slate-500 hover:text-red-400"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                    </div>
                </div>
            `).join('') : '<p class="text-center py-20 text-slate-600 text-xs font-bold">You haven\'t created any polls yet.</p>';
            lucide.createIcons();
        }

        window.deletePoll = (id) => {
            showMessage("Delete Poll", "Are you sure? This cannot be undone.", async () => {
                await updateDoc(doc(db, POLLS_PATH, id), { deleted: true });
                renderMyPage();
            });
        };

        // --- Modal & Create ---
        window.openModal = () => document.getElementById('pollModal').classList.remove('hidden');
        window.closeModal = () => document.getElementById('pollModal').classList.add('hidden');

        document.getElementById('savePollBtn').onclick = async () => {
            const title = document.getElementById('pollTitle').value.trim();
            const description = document.getElementById('pollDesc').value.trim();
            const category = document.getElementById('pollCategory').value;
            const options = document.getElementById('pollOptions').value.split('\n').filter(l => l.trim());
            const deadline = document.getElementById('pollDeadline').value;

            if (!title || options.length < 2) return showMessage("Error", "Title and at least 2 options are required.");

            const data = {
                title,
                description,
                category,
                options,
                deadline,
                authorId: currentUser.uid,
                author: currentUser.displayName || 'Guest',
                votes: new Array(options.length).fill(0),
                likes: [],
                voters: [],
                createdAt: serverTimestamp()
            };

            await addDoc(collection(db, POLLS_PATH), data);
            closeModal();
            navigate('home');
        };

        // --- Initialization ---

        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            const isReg = user && !user.isAnonymous;
            document.getElementById('loginBtn').classList.toggle('hidden', isReg);
            document.getElementById('userProfile').classList.toggle('hidden', !isReg);
            document.getElementById('createPollBtn').classList.toggle('hidden', !isReg);
            document.getElementById('myPollsBtn').classList.toggle('hidden', !isReg);
            document.getElementById('commentAuthGuard').classList.toggle('hidden', isReg);
            document.getElementById('commentInputArea').classList.toggle('hidden', !isReg);

            if (isReg) {
                document.getElementById('displayUserName').innerText = maskName(user.displayName);
            }

            if (localStorage.getItem('mixvote_agreed')) {
                document.getElementById('appContainer').classList.remove('hidden');
                document.getElementById('tosModal').classList.add('hidden');
                syncPolls();
            } else {
                document.getElementById('tosModal').classList.remove('hidden');
            }
            lucide.createIcons();
        });

        document.getElementById('agreeTosBtn').onclick = () => {
            localStorage.setItem('mixvote_agreed', 'true');
            document.getElementById('tosModal').classList.add('hidden');
            document.getElementById('appContainer').classList.remove('hidden');
            syncPolls();
        };

        document.getElementById('loginBtn').onclick = () => signInWithPopup(auth, new GoogleAuthProvider());
        window.logout = () => auth.signOut();
        document.getElementById('msgCloseBtn').onclick = () => document.getElementById('msgModal').classList.add('hidden');
        document.getElementById('globalSearch').oninput = () => renderLists();
        document.getElementById('createPollBtn').onclick = openModal;

        // Init UI
        const catSelect = document.getElementById('pollCategory');
        const catSidebar = document.getElementById('categoryList');
        CATEGORIES.forEach(c => {
            catSelect.innerHTML += `<option value="${c}">${c}</option>`;
            catSidebar.innerHTML += `
                <button onclick="filterCat('${c}')" class="text-left px-4 py-2 rounded-xl text-[10px] font-bold uppercase tracking-widest text-slate-500 hover:text-white hover:bg-white/5 transition-all">
                    ${c}
                </button>`;
        });

        window.filterCat = (c) => {
            document.getElementById('globalSearch').value = c;
            renderLists();
        };

        initAuth();
    </script>
</body>
</html>