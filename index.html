<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mix Vote - 次世代投票プラットフォーム</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&family=Noto+Sans+JP:wght@400;700&display=swap');
        
        :root {
            --accent: #06b6d4;
            --accent-rgb: 6, 182, 212;
            --accent-glow: rgba(6, 182, 212, 0.4);
            --bg-dark: #020617;
            --text-main: #f1f5f9;
        }

        body {
            font-family: 'Plus Jakarta Sans', 'Noto Sans JP', sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-main);
            overflow-x: hidden;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .dynamic-text { color: var(--text-main); }
        h1, h2, h3, h4, label { color: var(--text-main); }

        .bg-blob {
            position: fixed;
            width: 600px; height: 600px;
            background: radial-gradient(circle, var(--accent-glow) 0%, rgba(2, 6, 23, 0) 70%);
            border-radius: 50%; z-index: -1; filter: blur(80px);
            animation: floatBlob 25s infinite alternate ease-in-out;
            opacity: 0.6;
        }
        .blob-1 { top: -150px; right: -150px; }
        .blob-2 { bottom: -200px; left: -200px; background: radial-gradient(circle, rgba(168, 85, 247, 0.3) 0%, rgba(2, 6, 23, 0) 70%); animation-delay: -5s; }

        @keyframes floatBlob {
            0% { transform: translate(0, 0) scale(1); }
            100% { transform: translate(50px, 50px) scale(1.1); }
        }

        .glass {
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
        }

        .glass-panel {
            background: linear-gradient(145deg, rgba(30, 41, 59, 0.4), rgba(15, 23, 42, 0.6));
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .poll-card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        .poll-card:hover {
            transform: translateY(-4px);
            border-color: var(--accent);
            box-shadow: 0 10px 30px -10px var(--accent-glow);
            background: rgba(30, 41, 59, 0.8);
        }

        .btn-glow {
            position: relative;
            overflow: hidden;
            background-color: var(--accent);
            transition: filter 0.2s;
        }
        .btn-glow:hover { filter: brightness(1.1); }
        .btn-glow::after {
            content: '';
            position: absolute;
            top: -50%; left: -50%; width: 200%; height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255,255,255,0.1), transparent);
            transform: rotate(45deg);
            transition: 0.6s;
        }
        .btn-glow:hover::after { left: 120%; }

        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
        
        .nav-link.active {
            background: linear-gradient(90deg, var(--accent), #3b82f6);
            color: #020617 !important;
            box-shadow: 0 0 20px var(--accent-glow);
            border: none;
        }

        .custom-checkbox {
            width: 20px; height: 20px;
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: 6px;
            display: flex; align-items: center; justify-content: center;
            transition: all 0.2s;
        }
        .poll-option-selected .custom-checkbox {
            background: var(--accent);
            border-color: var(--accent);
        }

        .spinner { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        input[type="color"] {
            appearance: none; -webkit-appearance: none; border: none;
            width: 24px; height: 24px; border-radius: 6px; cursor: pointer; background: none;
        }

        .browser-tip {
            font-size: 14px;
            background: rgba(var(--accent-rgb), 0.05);
            padding: 18px 24px;
            border-radius: 24px;
            border: 1px solid rgba(var(--accent-rgb), 0.2);
            color: var(--text-main);
            display: flex;
            align-items: center;
            gap: 18px;
            margin-bottom: 24px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 10px 30px -10px rgba(0, 0, 0, 0.4);
        }
        .browser-tip:hover {
            background: rgba(var(--accent-rgb), 0.1);
            border-color: var(--accent);
            transform: translateY(-2px) scale(1.01);
            box-shadow: 0 20px 40px -15px var(--accent-glow);
        }

        .info-banner {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 15px 20px;
            border-radius: 24px;
            margin-bottom: 24px;
        }
    </style>
</head>
<body class="min-h-screen selection:bg-cyan-500 selection:text-slate-900">

    <div class="bg-blob blob-1"></div>
    <div class="bg-blob blob-2"></div>

    <!-- 翻訳ガイド用モーダル -->
    <div id="translateModal" class="fixed inset-0 z-[300] hidden flex items-center justify-center bg-black/80 backdrop-blur-md p-4">
        <div class="glass max-w-md w-full rounded-[32px] p-8 border border-white/10 shadow-2xl">
            <div class="flex items-center gap-3 mb-6">
                <div class="w-12 h-12 bg-[rgba(var(--accent-rgb),0.2)] rounded-full flex items-center justify-center text-[color:var(--accent)]">
                    <i class="fas fa-language text-2xl"></i>
                </div>
                <h3 class="text-xl font-black italic uppercase tracking-widest i18n" data-key="translate_help">Translation Help</h3>
            </div>
            <div id="translateGuideContent" class="space-y-6 text-sm opacity-90 i18n-html" data-key="translate_guide_content">
            </div>
            <button onclick="window.closeTranslateModal()" class="btn-glow w-full text-slate-950 font-black py-4 rounded-xl mt-8 uppercase tracking-widest text-xs i18n" data-key="close">
                Close
            </button>
        </div>
    </div>

    <!-- 同意モーダル -->
    <div id="tosModal" class="fixed inset-0 z-[100] hidden flex items-center justify-center bg-black/90 backdrop-blur-md p-4">
        <div class="glass max-w-2xl w-full rounded-3xl p-8 shadow-2xl border border-white/10 text-center">
            <h2 class="text-2xl font-black text-[color:var(--accent)] uppercase italic mb-6 i18n" data-key="welcome_title">Welcome to Mix Vote</h2>
            <div id="tosContent" class="space-y-4 text-sm mb-8 text-left max-h-[40vh] overflow-y-auto custom-scrollbar pr-2 leading-relaxed opacity-80 i18n-html" data-key="tos_content">
            </div>
            <button id="agreeTosBtn" class="btn-glow i18n w-full text-slate-950 font-black py-4 rounded-xl transition-all active:scale-95 uppercase tracking-widest text-xs" data-key="agree_btn">
                I Agree & Enter
            </button>
        </div>
    </div>

    <!-- 通知モーダル -->
    <div id="msgModal" class="fixed inset-0 z-[200] hidden flex items-center justify-center bg-black/80 backdrop-blur-sm p-4">
        <div class="glass max-w-xs w-full rounded-[24px] p-6 text-center border border-white/10 shadow-2xl">
            <h3 id="msgTitle" class="text-lg font-black mb-3 uppercase italic text-[color:var(--accent)] i18n" data-key="notice">Notice</h3>
            <p id="msgBody" class="opacity-70 text-xs mb-6 leading-relaxed whitespace-pre-wrap"></p>
            <div id="msgActions" class="flex gap-3 mt-4">
                <button id="msgCloseBtn" class="flex-1 bg-white/5 text-white font-bold py-3 rounded-xl uppercase text-[10px] tracking-widest hover:bg-white/10 transition-colors i18n" data-key="close">Close</button>
                <button id="msgConfirmBtn" class="flex-1 bg-[color:var(--accent)] text-slate-950 font-black py-3 rounded-xl uppercase text-[10px] tracking-widest hidden hover:brightness-110 transition-colors i18n" data-key="confirm">Confirm</button>
            </div>
        </div>
    </div>

    <!-- 削除モーダル -->
    <div id="deleteOptionsModal" class="fixed inset-0 z-[250] hidden flex items-center justify-center bg-black/90 backdrop-blur-md p-4">
        <div class="glass max-sm w-full rounded-[32px] p-8 text-center border border-red-500/20 shadow-2xl">
            <div class="w-16 h-16 bg-red-500/10 rounded-full flex items-center justify-center mx-auto mb-6">
                <i class="fas fa-trash-alt text-red-500 text-2xl"></i>
            </div>
            <h3 class="text-xl font-black italic uppercase tracking-tighter mb-2 i18n" data-key="delete_poll">Delete Poll</h3>
            <p class="opacity-60 text-xs mb-8 leading-relaxed i18n" data-key="delete_confirm_text">How would you like to process this poll?</p>
            <div class="space-y-3">
                <button onclick="window.confirmDeletePoll('archive')" class="w-full bg-white/5 hover:bg-white/10 text-white font-bold py-4 rounded-xl text-xs transition-all border border-white/5 i18n" data-key="archive_btn">Archive (Hide)</button>
                <button id="permanentDeleteBtn" onclick="window.confirmDeletePoll('permanent')" class="w-full bg-red-500 hover:bg-red-600 text-white font-black py-4 rounded-xl text-xs transition-all shadow-lg shadow-red-500/20 hidden i18n" data-key="permanent_delete_btn">Permanently Delete</button>
                <button onclick="window.closeDeleteModal()" class="w-full bg-transparent opacity-50 hover:opacity-100 font-bold py-3 text-xs uppercase tracking-widest mt-2 i18n" data-key="cancel">Cancel</button>
            </div>
        </div>
    </div>

    <!-- コメント編集モーダル -->
    <div id="editCommentModal" class="fixed inset-0 z-[300] hidden flex items-center justify-center bg-black/80 backdrop-blur-sm p-4">
        <div class="glass max-sm w-full rounded-[24px] p-6 border border-white/10 shadow-2xl">
            <h3 class="text-lg font-black mb-4 uppercase italic tracking-widest i18n" data-key="edit_comment">Edit Comment</h3>
            <textarea id="editCommentInput" class="w-full bg-slate-900 border border-white/10 rounded-xl p-4 text-sm text-white outline-none mb-4 focus:border-[color:var(--accent)] transition-colors" rows="3" maxlength="100"></textarea>
            <div class="flex gap-3">
                <button onclick="window.closeEditCommentModal()" class="flex-1 bg-white/5 text-white font-bold py-3 rounded-xl uppercase text-[10px] tracking-widest hover:bg-white/10 i18n" data-key="cancel">Cancel</button>
                <button id="saveCommentBtn" class="flex-1 bg-[color:var(--accent)] text-slate-950 font-black py-3 rounded-xl uppercase text-[10px] tracking-widest hover:brightness-110 i18n" data-key="save">Save</button>
            </div>
        </div>
    </div>

    <!-- メインUI -->
    <div id="appUI" class="hidden flex flex-col min-h-screen">
        <header class="sticky top-0 z-50 glass border-b border-white/5 px-6 py-4 backdrop-blur-xl">
            <div class="max-w-7xl mx-auto flex items-center justify-between gap-4">
                <div class="flex items-center gap-3 cursor-pointer group shrink-0" onclick="window.goHome()">
                    <div class="w-10 h-10 bg-[color:var(--accent)] rounded-xl flex items-center justify-center shadow-lg group-hover:rotate-12 transition-transform text-slate-900">
                        <i class="fas fa-bolt text-xl"></i>
                    </div>
                    <div class="hidden md:block">
                        <h1 class="text-xl font-black tracking-tighter uppercase italic leading-none">Mix Vote</h1>
                        <p class="text-[8px] opacity-50 font-bold uppercase tracking-[0.2em] i18n" data-key="edition_tag">Global Edition</p>
                    </div>
                </div>

                <div class="flex-1 max-w-lg relative group flex items-center gap-3">
                    <div class="relative flex-1">
                        <input type="text" id="globalSearch" class="w-full bg-slate-900/50 border border-white/10 rounded-2xl py-2.5 pl-10 pr-4 text-xs text-white outline-none focus:border-[color:var(--accent)] transition-all placeholder:opacity-30" placeholder="Search polls...">
                        <i class="fas fa-search absolute left-3.5 top-1/2 -translate-y-1/2 opacity-30 group-focus-within:text-[color:var(--accent)] group-focus-within:opacity-100 transition-all text-xs"></i>
                    </div>
                    <button onclick="window.openTranslateModal()" class="w-10 h-10 rounded-2xl glass hover:bg-white/10 flex items-center justify-center text-[color:var(--accent)] transition-all shrink-0" title="Translation Help">
                        <i class="fas fa-language text-xl"></i>
                    </button>
                </div>

                <div id="authArea" class="shrink-0 flex items-center gap-4">
                    <button id="loginBtn" class="glass hover:bg-white/10 px-5 py-2.5 rounded-xl font-bold flex items-center gap-2 border border-white/10 transition-all uppercase text-[10px] tracking-widest shadow-lg">
                        <i class="fab fa-google text-[color:var(--accent)]"></i> <span class="hidden sm:inline i18n" data-key="login">Sign In</span>
                    </button>
                    <div id="userInfo" class="hidden flex items-center gap-4">
                        <div class="text-right hidden sm:block">
                            <p class="text-[9px] opacity-50 font-bold uppercase tracking-wider i18n" data-key="welcome_user">Welcome</p>
                            <p id="userName" class="text-xs font-black"></p>
                        </div>
                        <div class="w-8 h-8 rounded-full bg-[color:var(--accent)] flex items-center justify-center text-slate-900 font-bold text-xs shadow-lg cursor-pointer hover:scale-105 transition-transform" onclick="window.goCreatedPolls()"><i class="fas fa-user"></i></div>
                        <button id="logoutBtn" class="opacity-50 hover:opacity-100 transition-colors" onclick="auth.signOut()"><i class="fas fa-sign-out-alt"></i></button>
                    </div>
                </div>
            </div>
        </header>

        <div class="max-w-7xl mx-auto w-full px-6 grid grid-cols-1 lg:grid-cols-12 gap-8 mt-8 flex-grow">
            <!-- サイドバー -->
            <aside class="lg:col-span-3 space-y-6">
                <div class="space-y-2">
                    <button onclick="window.goHome()" id="navHomeBtn" class="w-full text-left px-4 py-3 rounded-xl hover:bg-white/5 transition-all flex items-center gap-3 text-sm font-bold group">
                        <i class="fas fa-home opacity-40 group-hover:text-[color:var(--accent)] group-hover:opacity-100 transition-all w-5 text-center"></i> <span class="i18n" data-key="home">Home</span>
                    </button>
                    <div id="userNavGroup" class="hidden space-y-2">
                        <button onclick="window.goCreatedPolls()" id="navCreatedBtn" class="w-full text-left px-4 py-3 rounded-xl hover:bg-white/5 flex items-center gap-3 text-sm font-bold group">
                            <i class="fas fa-edit opacity-40 group-hover:text-[color:var(--accent)] group-hover:opacity-100 transition-all w-5 text-center"></i> <span class="i18n" data-key="created_polls">Created Polls</span>
                        </button>
                        <button onclick="window.goVotedPolls()" id="navVotedBtn" class="w-full text-left px-4 py-3 rounded-xl hover:bg-white/5 flex items-center gap-3 text-sm font-bold group">
                            <i class="fas fa-check-double opacity-40 group-hover:text-[color:var(--accent)] group-hover:opacity-100 transition-all w-5 text-center"></i> <span class="i18n" data-key="voted_polls">Voted Polls</span>
                        </button>
                    </div>
                </div>

                <button id="openCreateBtn" class="btn-glow w-full text-slate-950 font-black py-4 rounded-2xl flex items-center justify-center gap-3 shadow-xl active:scale-95 uppercase tracking-widest text-xs group">
                    <i class="fas fa-plus group-hover:rotate-90 transition-transform"></i> <span class="i18n" data-key="new_poll">New Poll</span>
                </button>

                <!-- 言語切り替え -->
                <div class="glass rounded-3xl p-5 border border-white/5">
                    <h3 class="text-xs font-black uppercase tracking-[0.2em] opacity-50 mb-4 pl-2 i18n" data-key="language">Language</h3>
                    <div class="flex gap-2 p-1 bg-black/20 rounded-xl">
                        <button onclick="window.changeLang('ja')" id="langJaBtn" class="flex-1 py-2.5 text-xs font-black rounded-lg transition-all">日本語</button>
                        <button onclick="window.changeLang('en')" id="langEnBtn" class="flex-1 py-2.5 text-xs font-black rounded-lg transition-all">English</button>
                    </div>
                </div>

                <div class="glass rounded-3xl p-5 border border-white/5">
                    <h3 class="text-xs font-black uppercase tracking-[0.2em] opacity-50 mb-4 pl-2 i18n" data-key="categories">Categories</h3>
                    <nav id="categoryNav" class="flex lg:flex-col gap-1 overflow-x-auto lg:overflow-visible pb-2 lg:pb-0 custom-scrollbar"></nav>
                </div>

                <!-- テーマ設定 -->
                <div class="glass rounded-3xl p-5 border border-white/5">
                    <h3 class="text-xs font-black uppercase tracking-[0.2em] opacity-50 mb-4 pl-2 i18n" data-key="theme_custom">Theme Custom</h3>
                    <div class="space-y-4 px-2">
                        <div class="flex items-center justify-between">
                            <span class="text-xs font-bold opacity-60 uppercase i18n" data-key="accent">Accent</span>
                            <input type="color" id="accentPicker" value="#06b6d4">
                        </div>
                        <div class="flex items-center justify-between">
                            <span class="text-xs font-bold opacity-60 uppercase i18n" data-key="background">Background</span>
                            <input type="color" id="bgPicker" value="#020617">
                        </div>
                        <div class="flex items-center justify-between">
                            <span class="text-xs font-bold opacity-60 uppercase i18n" data-key="text_color">Text Color</span>
                            <input type="color" id="textPicker" value="#f1f5f9">
                        </div>
                        <button onclick="window.resetTheme()" class="w-full mt-2 py-2 rounded-lg bg-white/5 hover:bg-white/10 text-xs font-black uppercase tracking-widest opacity-50 hover:opacity-100 transition-all i18n" data-key="default">
                            Default
                        </button>
                    </div>
                </div>

                <div class="text-[9px] opacity-40 font-medium px-2 leading-relaxed">
                    <p>&copy; 2025 Mix Vote Project.</p>
                </div>
            </aside>

            <!-- メイン -->
            <main class="lg:col-span-9 pb-20">
                <div id="view-home" class="view-content space-y-8 animate-in fade-in duration-500">
                    <!-- ホーム画面用 翻訳ガイドバナー -->
                    <div id="homeTranslateGuide" class="browser-tip" onclick="window.openTranslateModal()">
                        <div class="w-14 h-14 bg-[rgba(var(--accent-rgb),0.2)] rounded-2xl flex items-center justify-center text-[color:var(--accent)] shrink-0 shadow-lg">
                            <i class="fas fa-language text-3xl"></i>
                        </div>
                        <div class="flex-1">
                            <p class="font-black text-lg tracking-tight mb-0.5 i18n" data-key="home_translate_title">Translate Content</p>
                            <p class="text-sm opacity-70 leading-snug i18n" data-key="home_translate_desc">Use your browser's "Translate" feature to read polls in any language.</p>
                        </div>
                        <i class="fas fa-chevron-right opacity-30"></i>
                    </div>

                    <!-- ログイン必要性のお知らせバナー -->
                    <div id="loginNoticeBanner" class="info-banner flex flex-col md:flex-row gap-4 items-start md:items-center">
                        <div class="flex gap-3 items-center text-amber-400">
                            <i class="fas fa-user-lock text-xl"></i>
                            <div>
                                <p class="font-black text-sm i18n" data-key="home_login_notice_title">Login Required</p>
                                <p class="text-xs opacity-50 i18n" data-key="home_login_notice_desc">Sign in with Google to create polls or discuss.</p>
                            </div>
                        </div>
                        <div class="md:ml-auto flex gap-4 px-2">
                            <div class="flex items-center gap-2 text-[10px] font-bold text-green-400 uppercase tracking-widest">
                                <i class="fas fa-check-circle"></i> <span class="i18n" data-key="voting">Voting</span>
                            </div>
                            <div class="flex items-center gap-2 text-[10px] font-bold text-amber-400 uppercase tracking-widest opacity-80">
                                <i class="fas fa-key"></i> <span class="i18n" data-key="creation">Creation</span>
                            </div>
                        </div>
                    </div>

                    <section class="space-y-10">
                        <div id="featuredPollsSection" class="space-y-6">
                            <div class="flex items-end border-l-4 border-[color:var(--accent)] pl-4">
                                <h2 id="homeSectionTitle" class="text-xl md:text-2xl font-black italic uppercase tracking-tighter"></h2>
                            </div>
                            <div id="latestPollsFeatured" class="grid grid-cols-1 gap-6"></div>
                        </div>
                        <div id="morePollsSection" class="space-y-4">
                            <div class="flex items-end justify-between mb-4 border-b border-white/5 pb-2">
                                <h2 class="text-base font-black opacity-60 italic uppercase tracking-tighter i18n" data-key="recent_activity">Recent Activity</h2>
                            </div>
                            <div id="latestPollsMore" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
                        </div>
                    </section>
                </div>

                <div id="view-created" class="view-content hidden space-y-8 animate-in fade-in duration-500">
                    <div class="flex items-end border-l-4 border-[color:var(--accent)] pl-4">
                        <h2 class="text-xl md:text-2xl font-black italic uppercase tracking-tighter i18n" data-key="created_polls">Created Polls</h2>
                    </div>
                    <div id="createdPollsList" class="grid grid-cols-1 md:grid-cols-2 gap-5"></div>
                </div>

                <div id="view-voted" class="view-content hidden space-y-8 animate-in fade-in duration-500">
                    <div class="flex items-end border-l-4 border-[color:var(--accent)] pl-4">
                        <h2 class="text-xl md:text-2xl font-black italic uppercase tracking-tighter i18n" data-key="voted_polls">Voted Polls</h2>
                    </div>
                    <div id="votedPollsList" class="grid grid-cols-1 md:grid-cols-2 gap-5"></div>
                </div>

                <div id="view-detail" class="view-content hidden space-y-8 animate-in slide-in-from-bottom-4 duration-500">
                    <div class="flex items-center justify-between">
                        <button onclick="window.goHome()" class="opacity-50 hover:opacity-100 uppercase text-[10px] tracking-widest font-bold transition-all"><i class="fas fa-arrow-left"></i> <span class="i18n" data-key="back">Back</span></button>
                        <div id="adminControls" class="flex gap-2"></div>
                    </div>
                    
                    <div id="translateGuideDetail" class="browser-tip" onclick="window.openTranslateModal()">
                        <i class="fas fa-info-circle text-lg"></i>
                        <span class="i18n font-bold" data-key="browser_translate_hint">To translate, please use your browser's translate feature.</span>
                    </div>

                    <div id="pollDetailContent" class="glass rounded-[32px] p-8 md:p-10 border border-white/10 shadow-2xl relative overflow-hidden"></div>
                    <div class="glass rounded-[32px] p-8 border border-white/10 space-y-6">
                        <h3 class="text-lg font-black flex items-center gap-3 uppercase tracking-widest"><span class="w-1.5 h-6 bg-[color:var(--accent)] rounded-full"></span> <span class="i18n" data-key="discussion">Discussion</span></h3>
                        <div id="commentInputArea" class="hidden relative">
                            <textarea id="commentText" maxlength="100" class="w-full bg-slate-950/50 border border-white/10 rounded-2xl p-5 text-sm text-white outline-none focus:ring-1 focus:ring-[rgba(var(--accent-rgb),0.6)] transition-all min-h-[100px]" placeholder="Share your thoughts..."></textarea>
                            <button id="postCommentBtn" onclick="window.postComment()" class="absolute bottom-4 right-4 bg-[color:var(--accent)] hover:brightness-110 text-slate-950 px-6 py-2 rounded-xl font-bold text-xs transition-all shadow-lg i18n" data-key="post">Post</button>
                        </div>
                        <div id="commentsList" class="space-y-4"></div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- 作成モーダル -->
    <div id="createModal" class="fixed inset-0 z-[100] hidden flex items-center justify-center bg-black/90 backdrop-blur-xl p-4">
        <div class="glass max-w-lg w-full rounded-[32px] p-8 shadow-2xl border border-white/10 max-h-[90vh] overflow-y-auto custom-scrollbar">
            <h2 id="modalTitle" class="text-2xl font-black mb-6 uppercase italic tracking-tighter i18n" data-key="create_poll">Create Poll</h2>
            <div class="space-y-5">
                <div><label class="text-[9px] font-black opacity-50 uppercase tracking-widest block mb-2 i18n" data-key="label_title">Title</label><input type="text" id="pollTitleInput" class="w-full bg-slate-950 border border-white/10 rounded-xl p-4 text-white text-sm outline-none focus:border-[color:var(--accent)] transition-colors" placeholder="Your Question?"></div>
                <div><label class="text-[9px] font-black opacity-50 uppercase tracking-widest block mb-2 i18n" data-key="label_desc">Description</label><textarea id="pollDescInput" class="w-full bg-slate-950 border border-white/10 rounded-xl p-4 text-white text-sm outline-none focus:border-[color:var(--accent)] transition-colors" rows="2" placeholder="Add some context..."></textarea></div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="text-[9px] font-black opacity-50 uppercase tracking-widest block mb-2 i18n" data-key="label_category">Category</label><select id="pollCategoryInput" class="w-full bg-slate-950 border border-white/10 rounded-xl p-4 text-white text-sm outline-none appearance-none focus:border-[color:var(--accent)]"></select></div>
                    <div><label class="text-[9px] font-black opacity-50 uppercase tracking-widest block mb-2 i18n" data-key="label_deadline">Deadline</label><div id="deadlinePickerContainer" class="bg-slate-950 border border-white/10 rounded-xl p-4 flex justify-between items-center cursor-pointer relative hover:border-[color:var(--accent)] transition-colors"><input type="datetime-local" id="pollDeadlineInput" class="absolute inset-0 opacity-0 cursor-pointer z-10"><span id="deadlineDisplay" class="text-xs font-bold i18n" data-key="select">Select</span><i class="far fa-clock text-[color:var(--accent)]"></i></div></div>
                </div>
                <div><label class="text-[9px] font-black opacity-50 uppercase tracking-widest block mb-2 i18n" data-key="label_hashtags">Hashtags</label><input type="text" id="pollHashtagsInput" class="w-full bg-slate-950 border border-white/10 rounded-xl p-4 text-white text-sm outline-none focus:border-[color:var(--accent)] transition-colors" placeholder="e.g. ニュース エンタメ"></div>
                <div class="bg-white/5 p-4 rounded-xl border border-white/5 flex items-center justify-between">
                    <span class="text-xs font-bold i18n" data-key="label_multi">Allow Multiple Choice</span>
                    <label class="relative inline-flex items-center cursor-pointer"><input type="checkbox" id="pollMultiChoiceInput" class="sr-only peer"><div class="w-11 h-6 bg-slate-800 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-[color:var(--accent)]"></div></label>
                </div>
                <div><label class="text-[9px] font-black opacity-50 uppercase tracking-widest block mb-2 i18n" data-key="label_options">Options (Max 50)</label><textarea id="pollOptionsInput" class="w-full bg-slate-950 border border-white/10 rounded-xl p-4 text-white text-sm font-mono outline-none focus:border-[color:var(--accent)] transition-colors" rows="4" placeholder="Option 1&#10;Option 2"></textarea><p id="createOptionsHint" class="hidden text-[8px] text-[color:var(--accent)] mt-2 font-bold uppercase tracking-wider i18n" data-key="options_hint">Option count cannot be changed once created.</p></div>
            </div>
            <div class="flex gap-3 mt-8"><button id="cancelCreateBtn" class="flex-1 i18n bg-white/5 text-white font-bold py-4 rounded-xl text-xs hover:bg-white/10 transition-colors" data-key="cancel">Cancel</button><button id="savePollBtn" class="flex-1 bg-[color:var(--accent)] text-slate-950 font-black py-4 rounded-xl text-xs shadow-lg transition-transform flex items-center justify-center gap-2" onclick="window.savePoll()"><i id="saveBtnSpinner" class="fas fa-circle-notch spinner hidden"></i><span id="saveBtnText" class="i18n" data-key="save_poll">Save Poll</span></button></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js';
        import { getAuth, signInWithPopup, signInWithCustomToken, signInAnonymously, onAuthStateChanged, GoogleAuthProvider, getIdTokenResult } from 'https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js';
        import { getFirestore, collection, doc, getDoc, getDocs, addDoc, updateDoc, deleteDoc, onSnapshot, query, orderBy, where, serverTimestamp, arrayUnion, runTransaction, Timestamp } from 'https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js';
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-analytics.js";

        // --- 1. 定数と多言語辞書 (最優先) ---
        const firebaseConfig = { apiKey: "AIzaSyAwyi5j8EvqHL8wkyAJ48rwR8QCfS9voUE", authDomain: "mixvotesurvey.firebaseapp.com", projectId: "mixvotesurvey", storageBucket: "mixvotesurvey.firebasestorage.app", messagingSenderId: "352307389497", appId: "1:352307389497:web:0939fd29452d6c6afc59e8", measurementId: "G-ZWR5GHHL54" };
        const FILTER_ALL = "__ALL__", FILTER_POPULAR = "__POPULAR__", DEFAULT_THEME = { accent: '#06b6d4', bg: '#020617', text: '#f1f5f9' };
        const CATEGORIES_JA = ["ニュース", "エンタメ", "テクノロジー", "生活", "スポーツ", "旅行", "グルメ", "教育", "政治", "趣味", "クイズ", "あるある"], CATEGORIES_EN = ["News", "Entertainment", "Tech", "Lifestyle", "Sports", "Travel", "Gourmet", "Education", "Politics", "Hobbies", "Quiz", "Commonality"];

        const translations = {
            ja: {
                welcome_title: "Welcome to Mix Vote", tos_content: `<p>安全なコミュニティ維持のため、ガイドラインに同意してください。</p><ul class="list-disc list-inside space-y-2"><li>他者の意見を尊重し、誹謗中傷は行わないでください。</li><li>多重投票や不正なデータ操作は禁止されています。</li><li>アンケートの作成やコメントにはGoogleサインインが必要です。</li><li><strong>投票はどなたでも自由にご参加いただけます。</strong></li></ul>`, agree_btn: "同意して入室", login: "ログイン", logout: "ログアウト", welcome_user: "ようこそ", home: "ホーム", created_polls: "作成したアンケート", voted_polls: "投票済みアンケート", new_poll: "新規作成", language: "言語設定", categories: "カテゴリー", theme_custom: "テーマのカスタマイズ", accent: "アクセントカラー", background: "背景色", text_color: "文字色", default: "デフォルトに戻す", polls: "アンケート", recent_activity: "最近の活動", back: "戻る", discussion: "ディスカッション", post: "投稿する", create_poll: "アンケート作成", edit_poll: "アンケート編集", label_title: "タイトル", label_desc: "説明文", label_category: "カテゴリー", label_deadline: "投票期限", label_hashtags: "ハッシュタグ", label_multi: "複数回答を許可する", label_options: "選択肢 (最大50個)", options_hint: "※作成後は選択肢の数を変更できません", save_poll: "保存する", cancel: "キャンセル", save: "保存", confirm: "確定", close: "閉じる", delete_poll: "アンケートを削除", delete_confirm_text: "このアンケートをアーカイブ（非表示）にしますか？", archive_btn: "アーカイブ", permanent_delete_btn: "永久削除", edit_comment: "コメントを編集", votes: "票", popular_polls: "人気アンケート", latest_polls: "最新アンケート", no_polls: "アンケートが見つかりません", all: "全て", notice: "お知らせ", edition_tag: "Global Edition", select: "選択", translate_help: "翻訳の手順", browser_translate_hint: "翻訳機能を利用するにはブラウザの設定をご確認ください。", home_translate_title: "内容の翻訳について", home_translate_desc: "ブラウザの標準翻訳機能で一瞬で翻訳可能です。クリックして手順を確認。", search_polls: "アンケートを検索...", votes_abbr: "票", no_comments: "コメントはまだありません", already_voted: "既に投票済みです", delete_comment_confirm: "このコメントを削除してもよろしいですか？", comment_posted: "コメントを投稿しました！", comment_updated: "コメントを更新しました！", save_success: "保存しました！", permission_denied: "権限がありません。"
            },
            en: {
                welcome_title: "Welcome to Mix Vote", tos_content: `<p>Please agree to the guidelines to maintain a safe community.</p><ul class="list-disc list-inside space-y-2"><li>Respect others' opinions and avoid harassment.</li><li>Multiple voting and data manipulation are prohibited.</li><li>Google Sign-in is required to create polls or post comments.</li><li><strong>Anyone can participate in voting freely.</strong></li></ul>`, agree_btn: "Agree & Enter", login: "Sign In", logout: "Log Out", welcome_user: "Welcome", home: "Home", created_polls: "Created Polls", voted_polls: "Voted Polls", new_poll: "New Poll", language: "Language", categories: "Categories", theme_custom: "Theme Custom", accent: "Accent", background: "Background", text_color: "Text Color", default: "Default", polls: "Polls", recent_activity: "Recent Activity", back: "Back", discussion: "Discussion", post: "Post", create_poll: "Create Poll", edit_poll: "Edit Poll", label_title: "Title", label_desc: "Description", label_category: "Category", label_deadline: "Deadline", label_hashtags: "Hashtags", label_multi: "Allow Multiple Choice", label_options: "Options (Max 50)", options_hint: "Option count cannot be changed after creation.", save_poll: "Save Poll", cancel: "Cancel", save: "Save", confirm: "Confirm", close: "Close", delete_poll: "Delete Poll", delete_confirm_text: "Do you want to archive this poll?", archive_btn: "Archive", permanent_delete_btn: "Delete", edit_comment: "Edit Comment", votes: "Votes", popular_polls: "Popular Polls", latest_polls: "Latest Polls", no_polls: "No polls found", all: "All", notice: "Notice", edition_tag: "Global Edition", select: "Select", translate_help: "Translation Guide", browser_translate_hint: "Check your browser settings to use translation.", home_translate_title: "How to Translate", home_translate_desc: "Use browser's full-page translation for other languages. Click for details.", search_polls: "Search polls...", votes_abbr: "Votes", no_comments: "No comments yet", already_voted: "Already voted", delete_comment_confirm: "Are you sure you want to delete this comment?", comment_posted: "Comment posted successfully!", comment_updated: "Comment updated!", save_success: "Saved successfully!", permission_denied: "Permission denied."
            }
        };

        // --- 2. 状態管理 ---
        const app = initializeApp(firebaseConfig), auth = getAuth(app), db = getFirestore(app), analytics = getAnalytics(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'mixvote-web', POLLS_PATH = ['artifacts', appId, 'public', 'data', 'polls'];

        let currentLang = 'ja', currentUser = null, isAdmin = false, searchTerm = "", chartInstance = null, currentPollId = null, currentPollData = null, editMode = false, editPollId = null;
        let selectedCategory = FILTER_ALL, unsubscribePollsRealtime = null, unsubscribeCreated = null, unsubscribeVoted = null, unsubscribeComments = null, localSelectedIndices = [], allPollsCache = [], currentCommentsData = {}, commentToEditId = null;
        window.sessionAgreed = false;

        // --- 3. ユーティリティ & 主要関数 (function宣言でホイスティングを確実にする) ---

        function i18n(key) {
            return (translations[currentLang] && translations[currentLang][key]) || key;
        }

        function setActiveNav(id) {
            document.querySelectorAll('aside button').forEach(b => b.classList.remove('active', 'text-white'));
            const btn = document.getElementById(id);
            if (btn) btn.classList.add('active', 'text-white');
        }

        function getDisplayCat(internalCat) {
            const idx = CATEGORIES_JA.indexOf(internalCat);
            return idx > -1 ? (currentLang === 'en' ? CATEGORIES_EN[idx] : CATEGORIES_JA[idx]) : internalCat;
        }

        function hexToRgba(hex, alpha) {
            const r = parseInt(hex.slice(1, 3), 16), g = parseInt(hex.slice(3, 5), 16), b = parseInt(hex.slice(5, 7), 16);
            return `rgba(${r}, ${g}, ${b}, ${alpha})`;
        }

        function generatePalette(count) {
            const accentRGB = getComputedStyle(document.documentElement).getPropertyValue('--accent-rgb').trim() || "6, 182, 212";
            const colors = [accentRGB, '59, 130, 246', '139, 92, 246', '236, 72, 153', '245, 158, 11', '16, 185, 129', '239, 68, 68', '20, 184, 166', '99, 102, 241', '244, 63, 94'];
            return Array.from({length: count}, (_, i) => {
                if (i < colors.length) return `rgba(${colors[i]}, 0.8)`;
                return `hsla(${(i * 137.5) % 360}, 65%, 60%, 0.8)`;
            });
        }

        function applyTheme(accent, bg, text, save = true) {
            const r = parseInt(accent.slice(1, 3), 16), g = parseInt(accent.slice(3, 5), 16), b = parseInt(accent.slice(5, 7), 16);
            document.documentElement.style.setProperty('--accent', accent);
            document.documentElement.style.setProperty('--accent-rgb', `${r}, ${g}, ${b}`);
            document.documentElement.style.setProperty('--accent-glow', hexToRgba(accent, 0.4));
            document.documentElement.style.setProperty('--bg-dark', bg);
            document.documentElement.style.setProperty('--text-main', text);
            const aP = document.getElementById('accentPicker'), bP = document.getElementById('bgPicker'), tP = document.getElementById('textPicker');
            if (aP) aP.value = accent; if (bP) bP.value = bg; if (tP) tP.value = text;
            if (save) { try { localStorage.setItem('mixvote_theme', JSON.stringify({ accent, bg, text })); } catch(e){} }
            if (currentPollData) window.loadPollDetail(currentPollId);
        }

        function loadTheme() {
            let theme = DEFAULT_THEME;
            try { const saved = localStorage.getItem('mixvote_theme'); if (saved) theme = JSON.parse(saved); } catch(e){}
            applyTheme(theme.accent, theme.bg, theme.text, false);
        }

        function setupCategoryMenu() {
            const nav = document.getElementById('categoryNav'), select = document.getElementById('pollCategoryInput');
            if (!nav || !select) return; nav.innerHTML = ''; select.innerHTML = '';
            const specialItems = [{ id: FILTER_ALL, label: i18n('all') }, { id: FILTER_POPULAR, label: i18n('popular_polls') }];
            specialItems.forEach(item => {
                const btn = document.createElement('button');
                btn.className = `nav-link px-4 py-2 rounded-xl text-xs font-bold uppercase tracking-widest transition-all text-left ${selectedCategory === item.id ? 'active opacity-100' : 'opacity-40 hover:opacity-100 hover:text-white'}`;
                btn.textContent = item.label; 
                btn.onclick = () => { selectedCategory = item.id; setupCategoryMenu(); goHome(); };
                nav.appendChild(btn);
            });
            const catsDisplay = currentLang === 'ja' ? CATEGORIES_JA : CATEGORIES_EN;
            catsDisplay.forEach((catLabel, idx) => {
                const internalName = CATEGORIES_JA[idx];
                const btn = document.createElement('button');
                btn.className = `nav-link px-4 py-2 rounded-xl text-xs font-bold uppercase tracking-widest transition-all text-left ${selectedCategory === internalName ? 'active opacity-100' : 'opacity-40 hover:opacity-100 hover:text-white'}`;
                btn.textContent = catLabel;
                btn.onclick = () => { selectedCategory = internalName; setupCategoryMenu(); goHome(); };
                nav.appendChild(btn);
                const opt = document.createElement('option');
                opt.value = internalName; opt.textContent = catLabel; select.appendChild(opt);
            });
        }

        function updateUIStrings() {
            document.querySelectorAll('.i18n').forEach(el => { el.textContent = i18n(el.getAttribute('data-key')); });
            document.querySelectorAll('.i18n-html').forEach(el => { el.innerHTML = i18n(el.getAttribute('data-key')); });
            const sI = document.getElementById('globalSearch');
            if (sI) sI.placeholder = i18n('search_polls');
            setupCategoryMenu();
            const tE = document.getElementById('homeSectionTitle');
            if (tE) {
                const head = selectedCategory === FILTER_POPULAR ? i18n('popular_polls') : i18n('latest_polls');
                if (currentLang === 'en' && head.includes(' ')) {
                    const words = head.split(' ');
                    tE.innerHTML = `${words[0]} <span class="opacity-40 font-normal not-italic">${words.slice(1).join(' ')}</span>`;
                } else {
                    tE.innerHTML = head;
                }
            }
            document.documentElement.lang = currentLang;
        }

        function changeLang(lang) {
            currentLang = lang;
            try { localStorage.setItem('mixvote_lang', lang); } catch(e){}
            updateUIStrings();
            if (currentPollId) window.loadPollDetail(currentPollId);
            window.loadPolls(); 
        }

        function applyFilters() {
            let polls = allPollsCache.filter(p => !p.deleted);
            if (selectedCategory !== FILTER_ALL && selectedCategory !== FILTER_POPULAR) polls = polls.filter(p => p.category === selectedCategory);
            if (searchTerm) {
                const searchLower = searchTerm.toLowerCase();
                polls = polls.filter(p => p.title.toLowerCase().includes(searchLower) || p.hashtags?.some(tag => tag.toLowerCase().includes(searchLower)));
            }
            if (selectedCategory === FILTER_POPULAR) {
                const now = Date.now();
                const getHotScore = (p) => {
                    const total = p.votes?.reduce((s, v) => s + v, 0) || 0;
                    const time = p.updatedAt?.seconds ? p.updatedAt.seconds * 1000 : (p.createdAt?.seconds ? p.createdAt.seconds * 1000 : now);
                    const ageHours = (now - time) / 3600000;
                    return total / Math.pow(ageHours + 24, 1.2);
                };
                polls.sort((a, b) => getHotScore(b) - getHotScore(a));
            } else { polls.sort((a,b) => (b.createdAt?.seconds||0)-(a.createdAt?.seconds||0)); }
            renderHomePolls(polls);
        }

        function renderHomePolls(polls) {
            const fC = document.getElementById('latestPollsFeatured'), mC = document.getElementById('latestPollsMore');
            if (!fC || !mC) return; fC.innerHTML = ''; mC.innerHTML = '';
            const fP = polls.slice(0, 5), mP = polls.slice(5, 55); 
            if (!polls.length) { fC.innerHTML = `<p class="opacity-30 py-10 text-center uppercase text-xs">${i18n('no_polls')}</p>`; return; }
            document.getElementById('morePollsSection').classList.toggle('hidden', !mP.length);
            const dateLoc = currentLang === 'ja' ? 'ja-JP' : 'en-US';
            fP.forEach(p => {
                const total = p.votes?.reduce((s,v)=>s+v,0)||0, div = document.createElement('div'), dC = getDisplayCat(p.category);
                div.className = "poll-card glass-panel rounded-[24px] p-6 md:p-8 cursor-pointer flex flex-col justify-between group";
                div.onclick = () => window.goDetail(p.id);
                div.innerHTML = `<div class="space-y-4"><span class="text-[9px] font-black px-3 py-1 rounded-full bg-[rgba(var(--accent-rgb),0.2)] text-[color:var(--accent)] uppercase border border-[rgba(var(--accent-rgb),0.2)]">${escapeHTML(dC)}</span><h3 class="text-lg md:text-xl font-black leading-tight group-hover:text-[color:var(--accent)] transition-colors">${escapeHTML(p.title)}</h3><div class="flex flex-wrap mt-1">${(p.hashtags || []).map(t => `<span class="text-[10px] text-[color:var(--accent)] opacity-80 mr-2 font-bold">#${escapeHTML(t)}</span>`).join('')}</div></div><div class="mt-6 pt-4 border-t border-white/5 flex justify-between items-center text-[10px] opacity-40 font-bold uppercase"><span>by ${escapeHTML(maskString(p.author))}</span><span>${total} ${i18n('votes')}</span></div>`;
                fC.appendChild(div);
            });
            mP.forEach(p => {
                const total = p.votes?.reduce((s,v)=>s+v,0)||0, div = document.createElement('div'), dC = getDisplayCat(p.category), dStr = p.createdAt?.seconds ? new Date(p.createdAt.seconds*1000).toLocaleDateString(dateLoc) : '';
                div.className = "poll-card glass rounded-[16px] p-4 cursor-pointer flex flex-col justify-between";
                div.onclick = () => window.goDetail(p.id);
                div.innerHTML = `<div class="space-y-2"><span class="text-[8px] font-bold opacity-40 uppercase">${escapeHTML(dC)}</span><h3 class="text-xs font-bold leading-snug line-clamp-2">${escapeHTML(p.title)}</h3></div><div class="mt-3 text-[8px] opacity-30 font-bold border-t border-white/5 pt-2 flex justify-between uppercase"><span>${total} ${i18n('votes_abbr')}</span><span>${dStr}</span></div>`;
                mC.appendChild(div);
            });
        }

        function goHome() { 
            window.location.hash = ''; document.querySelectorAll('.view-content').forEach(v => v.classList.add('hidden')); 
            document.getElementById('view-home').classList.remove('hidden'); 
            setActiveNav('navHomeBtn'); window.loadPolls(); 
        }

        async function initAuth() {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) await signInWithCustomToken(auth, __initial_auth_token).catch(() => signInAnonymously(auth));
                else await signInAnonymously(auth).catch(() => {});
            } catch (err) { await signInAnonymously(auth).catch(()=>{}); }
        }

        function handleNavigation() {
            const h = window.location.hash;
            if (h === '#created') window.goCreatedPolls(); else if (h === '#voted') window.goVotedPolls(); else if (h.startsWith('#poll/')) window.goDetail(h.replace('#poll/', '')); else goHome();
        }

        const maskString = (s = '') => { 
            if (!s || typeof s !== 'string') return s;
            if (s.includes('@')) {
                const [local, domain] = s.split('@');
                if (local.length <= 2) return `*@${domain}`;
                return `${local[0]}${'*'.repeat(Math.min(local.length - 2, 8))}${local[local.length - 1]}@${domain}`;
            }
            if (s.length <= 4) return s[0] + '*'.repeat(s.length - 1);
            return s.substring(0, 2) + '*'.repeat(Math.min(s.length - 4, 8)) + s.substring(s.length - 2);
        };

        const escapeHTML = (s = '') => typeof s !== 'string' ? '' : s.replace(/[&<>"']/g, m => ({'&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'}[m]));

        // --- 4. Window オブジェクトへの割り当て (即座に参照可能にする) ---
        window.i18n = i18n;
        window.setActiveNav = setActiveNav;
        window.changeLang = changeLang;
        window.applyTheme = applyTheme;
        window.loadTheme = loadTheme;
        window.goHome = goHome;
        window.updateUIStrings = updateUIStrings;
        window.setupCategoryMenu = setupCategoryMenu;
        window.applyFilters = applyFilters;
        window.initAuth = initAuth;
        window.handleNavigation = handleNavigation;
        window.maskString = maskString;
        window.escapeHTML = escapeHTML;

        // --- 5. 機能・Firebase 関連を登録 ---
        window.initRealtimePolls = function() {
            if (!currentUser) return;
            if (unsubscribePollsRealtime) unsubscribePollsRealtime();
            unsubscribePollsRealtime = onSnapshot(collection(db, ...POLLS_PATH), (snapshot) => {
                allPollsCache = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                applyFilters();
            }, (err) => { if (err.code === 'permission-denied') console.warn("Firestore access denied."); });
        };

        window.loadPolls = function() { if (allPollsCache.length > 0) applyFilters(); else window.initRealtimePolls(); };

        window.loadPollDetail = async function(id) {
            if (!currentUser) return; localSelectedIndices = []; let localVoted = false; try { localVoted = JSON.parse(localStorage.getItem('mixvote_voted_history') || '[]').includes(id); } catch(e) {}
            const d = await getDoc(doc(db, ...POLLS_PATH, id)); if (!d.exists()) return goHome();
            const p = d.data(); currentPollId = id; currentPollData = p;
            const total = p.votes?.reduce((s,v)=>s+v,0)||0, hasV = (currentUser && p.votedUsers?.includes(currentUser.uid)) || localVoted, isExp = p.deadline && p.deadline.toDate() < new Date(), canV = !hasV && !isExp, isM = p.isMultipleChoice === true, isReg = currentUser && !currentUser.isAnonymous;
            document.getElementById('adminControls').innerHTML = (isAdmin || (currentUser && p.authorID === currentUser.uid)) ? `<button onclick="window.openEditPoll()" class="p-2 rounded-lg glass text-[color:var(--accent)] border border-[rgba(var(--accent-rgb),0.2)]"><i class="fas fa-edit"></i></button><button onclick="window.openDeleteModal()" class="p-2 rounded-lg glass text-red-400 border border-red-500/20"><i class="fas fa-trash"></i></button>` : '';
            document.getElementById('commentInputArea').classList.toggle('hidden', !isReg);
            const content = document.getElementById('pollDetailContent'), dC = getDisplayCat(p.category);
            content.innerHTML = `<div class="space-y-8"><div class="space-y-4"><div class="flex items-center gap-3"><span class="bg-[rgba(var(--accent-rgb),0.1)] text-[color:var(--accent)] font-black text-[9px] px-3 py-1 rounded-md uppercase border border-[rgba(var(--accent-rgb),0.2)]">${escapeHTML(dC)}</span>${isM ? `<span class="bg-purple-500/10 text-purple-400 font-black text-[9px] px-3 py-1 rounded-md uppercase border border-purple-500/20">${i18n('label_multi')}</span>`:''}</div><h2 class="text-xl md:text-2xl font-black leading-tight">${escapeHTML(p.title)}</h2><div class="flex flex-wrap">${(p.hashtags || []).map(t => `<span class="bg-[rgba(var(--accent-rgb),0.1)] text-[color:var(--accent)] text-[10px] px-2 py-0.5 rounded-full mr-2 mb-2 font-bold">#${escapeHTML(t)}</span>`).join('')}</div>${p.question ? `<div class="bg-white/5 p-6 rounded-2xl opacity-80 text-sm border border-white/5 relative leading-relaxed"><p>${escapeHTML(p.question)}</p></div>` : ''}</div><div class="grid grid-cols-1 lg:grid-cols-2 gap-10"><div class="space-y-3">${p.options.map((opt, i) => { const v = p.votes[i]||0, per = total>0?Math.round(v/total*100):0; return `<div ${canV ? (isM ? `onclick="window.toggleLocalSelect(${i})"` : `onclick="window.castVote(${i})"`) : ''} id="opt-container-${i}" class="relative overflow-hidden bg-slate-900/50 border border-white/5 rounded-xl p-4 flex justify-between items-center group ${canV ? 'cursor-pointer hover:border-[rgba(var(--accent-rgb),0.5)]' : ''}"><div class="absolute inset-y-0 left-0 bg-[rgba(var(--accent-rgb),0.05)] transition-all duration-1000" style="width:${per}%"></div><div class="relative z-10 flex items-center gap-3">${canV && isM ? '<div class="custom-checkbox"><i class="fas fa-check text-[10px] text-slate-900"></i></div>':''}<span class="font-bold text-sm">${escapeHTML(opt)}</span></div><div class="relative z-10 text-right shrink-0"><div class="font-black text-base">${per}%</div><div class="text-[8px] opacity-40 uppercase font-bold">${v} ${i18n('votes')}</div></div></div>`; }).join('')}${canV && isM ? `<button onclick="window.submitMultipleVotes()" id="submitMultiVoteBtn" style="display:none;" class="w-full bg-[color:var(--accent)] text-slate-950 font-black py-3 rounded-xl text-xs uppercase mt-4 hover:brightness-110 transition-all">${i18n('confirm')}</button>`:''}</div><div class="flex flex-col items-center justify-center min-h-[300px] gap-6"><div class="w-full h-[250px] flex items-center justify-center"><canvas id="pollChart"></canvas></div><div class="flex flex-wrap items-center justify-center gap-2 mt-4"><button onclick="window.sharePoll('x')" class="w-10 h-10 rounded-full glass hover:bg-white/10 flex items-center justify-center text-slate-400 hover:text-white transition-all"><i class="fab fa-x-twitter"></i></button><button onclick="window.sharePoll('fb')" class="w-10 h-10 rounded-full glass hover:bg-white/10 flex items-center justify-center text-blue-400 hover:text-blue-300 transition-all"><i class="fab fa-facebook-f"></i></button><button onclick="window.sharePoll('ig')" class="w-10 h-10 rounded-full glass hover:bg-white/10 flex items-center justify-center text-pink-400 hover:text-pink-300 transition-all"><i class="fab fa-instagram"></i></button><button onclick="window.downloadPoll()" class="px-4 py-2 rounded-xl glass hover:bg-[rgba(var(--accent-rgb),0.1)] border border-white/5 flex items-center gap-2 text-[10px] font-black uppercase tracking-widest text-[color:var(--accent)] transition-all"><i class="fas fa-download"></i> ${i18n('download_results')}</button></div></div></div></div>`;
            window.renderChart(p, 'doughnut'); window.loadComments(id);
        };

        window.renderChart = function(p, type) {
            const ctx = document.getElementById('pollChart')?.getContext('2d'); if (!ctx) return;
            if (chartInstance) chartInstance.destroy();
            const count = p.options.length, useBar = count > 8, effectiveType = useBar ? 'bar' : type, colors = generatePalette(count);
            const opts = { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: !useBar, position: 'bottom', labels: { color: '#94a3b8', font: { size: 10, weight: 'bold' } } } } };
            if (useBar) { opts.indexAxis = 'y'; opts.scales = { x: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#64748b' } }, y: { grid: { display: false }, ticks: { color: '#f1f5f9', font: { size: 11, weight: 'bold' } } } }; } else { opts.cutout = '70%'; }
            chartInstance = new Chart(ctx, { type: effectiveType, data: { labels: p.options, datasets: [{ data: p.votes, backgroundColor: colors, borderWidth: 0, borderRadius: useBar ? 6 : 0 }] }, options: opts });
        };

        window.confirmDeletePoll = async function(type) { 
            window.closeDeleteModal(); try { const ref = doc(db, ...POLLS_PATH, currentPollId); await updateDoc(ref, { deleted: true, deletedAt: serverTimestamp(), deletedBy: currentUser.uid }); goHome(); } catch (e) { window.showMessage(i18n('notice'), i18n('permission_denied')); } 
        };

        window.castVote = async function(idx) { 
            if (!currentUser) return; try { if (JSON.parse(localStorage.getItem('mixvote_voted_history') || '[]').includes(currentPollId)) { window.showMessage(i18n('notice'), i18n('already_voted')); return; } } catch(e) {} 
            const ref = doc(db, ...POLLS_PATH, currentPollId); try { await runTransaction(db, async (tx) => { const snap = await tx.get(ref); const data = snap.data(); if (data.votedUsers?.includes(currentUser.uid)) throw "Already Voted"; const newVotes = [...data.votes]; newVotes[idx] = (newVotes[idx] || 0) + 1; tx.update(ref, { votes: newVotes, votedUsers: arrayUnion(currentUser.uid), updatedAt: serverTimestamp() }); }); try { const h = JSON.parse(localStorage.getItem('mixvote_voted_history') || '[]'); h.push(currentPollId); localStorage.setItem('mixvote_voted_history', JSON.stringify(h)); } catch(e) {} window.loadPollDetail(currentPollId); } catch (e) { if (e === "Already Voted") window.showMessage(i18n('notice'), i18n('already_voted')); } 
        };

        window.goDetail = function(id) { window.location.hash = `poll/${id}`; document.querySelectorAll('.view-content').forEach(v => v.classList.add('hidden')); document.getElementById('view-detail').classList.remove('hidden'); window.loadPollDetail(id); };

        window.goCreatedPolls = function() { if (!currentUser || currentUser.isAnonymous) return; window.location.hash = 'created'; document.querySelectorAll('.view-content').forEach(v => v.classList.add('hidden')); document.getElementById('view-created').classList.remove('hidden'); setActiveNav('navCreatedBtn'); window.loadFilteredPolls('created'); };
        window.goVotedPolls = function() { if (!currentUser || currentUser.isAnonymous) return; window.location.hash = 'voted'; document.querySelectorAll('.view-content').forEach(v => v.classList.add('hidden')); document.getElementById('view-voted').classList.remove('hidden'); setActiveNav('navVotedBtn'); window.loadFilteredPolls('voted'); };

        window.loadFilteredPolls = function(type) {
            if (!currentUser) return; const listId = type === 'created' ? 'createdPollsList' : 'votedPollsList';
            if (type === 'created' && unsubscribeCreated) unsubscribeCreated(); if (type === 'voted' && unsubscribeVoted) unsubscribeVoted();
            const dateLoc = currentLang === 'ja' ? 'ja-JP' : 'en-US';
            const unsubscribe = onSnapshot(collection(db, ...POLLS_PATH), (snapshot) => {
                let polls = snapshot.docs.map(d => ({id: d.id, ...d.data()})).filter(p => !p.deleted);
                if (type === 'created') polls = polls.filter(p => p.authorID === currentUser.uid); else polls = polls.filter(p => p.votedUsers?.includes(currentUser.uid));
                polls.sort((a,b) => (b.createdAt?.seconds||0)-(a.createdAt?.seconds||0)); window.renderPollList(listId, polls, dateLoc);
            }, (err) => console.error(err));
            if (type === 'created') unsubscribeCreated = unsubscribe; else unsubscribeVoted = unsubscribe;
        };

        window.renderPollList = function(eid, polls, dateLoc) {
            const c = document.getElementById(eid); if (!c) return;
            c.innerHTML = polls.length ? '' : `<div class="col-span-full py-20 text-center opacity-30 font-bold uppercase tracking-widest text-xs">${i18n('no_polls')}</div>`;
            polls.forEach(p => {
                const total = p.votes?.reduce((s,v)=>s+v,0)||0, div = document.createElement('div'), dC = getDisplayCat(p.category), dStr = p.createdAt?.seconds ? new Date(p.createdAt.seconds*1000).toLocaleDateString(dateLoc) : '';
                div.className = "poll-card glass rounded-[24px] p-6 cursor-pointer flex flex-col justify-between group";
                div.onclick = () => window.goDetail(p.id);
                div.innerHTML = `<div class="space-y-4"><span class="text-[9px] font-black px-3 py-1 rounded-full bg-[rgba(var(--accent-rgb),0.2)] text-[color:var(--accent)] uppercase border border-[rgba(var(--accent-rgb),0.2)]">${escapeHTML(dC)}</span><h3 class="text-sm md:text-base font-black leading-tight group-hover:text-[color:var(--accent)] transition-colors">${escapeHTML(p.title)}</h3></div><div class="mt-6 pt-4 border-t border-white/5 flex justify-between items-center text-[10px] opacity-40 font-bold uppercase"><span>${total} ${i18n('votes')}</span><span>${dStr}</span></div>`;
                c.appendChild(div);
            });
        };

        window.toggleLocalSelect = function(idx) { const el = document.getElementById(`opt-container-${idx}`); if (localSelectedIndices.includes(idx)) { localSelectedIndices = localSelectedIndices.filter(i => i !== idx); el?.classList.remove('poll-option-selected'); } else { localSelectedIndices.push(idx); el?.classList.add('poll-option-selected'); } const btn = document.getElementById('submitMultiVoteBtn'); if (btn) btn.style.display = localSelectedIndices.length > 0 ? 'block' : 'none'; };
        
        window.submitMultipleVotes = async function() { 
            if (!currentUser) return; try { if (JSON.parse(localStorage.getItem('mixvote_voted_history') || '[]').includes(currentPollId)) { window.showMessage(i18n('notice'), i18n('already_voted')); return; } } catch(e) {} 
            const ref = doc(db, ...POLLS_PATH, currentPollId); 
            try { await runTransaction(db, async (tx) => { const snap = await tx.get(ref); const data = snap.data(); if (data.votedUsers?.includes(currentUser.uid)) throw "Already Voted"; const newVotes = [...data.votes]; localSelectedIndices.forEach(i => { newVotes[i] = (newVotes[i] || 0) + 1; }); tx.update(ref, { votes: newVotes, votedUsers: arrayUnion(currentUser.uid), updatedAt: serverTimestamp() }); }); try { const h = JSON.parse(localStorage.getItem('mixvote_voted_history') || '[]'); h.push(currentPollId); localStorage.setItem('mixvote_voted_history', JSON.stringify(h)); } catch(e) {} localSelectedIndices = []; window.loadPollDetail(currentPollId); } catch (e) { if (e === "Already Voted") window.showMessage(i18n('notice'), i18n('already_voted')); } 
        };

        window.openEditCommentModal = (cid) => { commentToEditId = cid; document.getElementById('editCommentInput').value = currentCommentsData[cid] || ""; document.getElementById('editCommentModal').classList.remove('hidden'); };
        window.closeDeleteModal = () => document.getElementById('deleteOptionsModal').classList.add('hidden');
        window.openDeleteModal = () => { document.getElementById('permanentDeleteBtn').classList.toggle('hidden', !isAdmin); document.getElementById('deleteOptionsModal').classList.remove('hidden'); };

        window.savePoll = async function() { 
            const saveBtn = document.getElementById('savePollBtn'); 
            try { 
                if (!currentUser || currentUser.isAnonymous) throw new Error("Google login required."); 
                const t = document.getElementById('pollTitleInput').value.trim(), o = document.getElementById('pollOptionsInput').value.split('\n').map(s=>s.trim()).filter(Boolean); 
                if (!t || o.length < 2) throw new Error("Title and 2+ options required."); 
                const deadlineVal = document.getElementById('pollDeadlineInput').value, deadlineTs = deadlineVal ? Timestamp.fromDate(new Date(deadlineVal)) : null;
                const isM = !!document.getElementById('pollMultiChoiceInput').checked;
                saveBtn.disabled = true; const cat = document.getElementById('pollCategoryInput').value; 
                const hashtags = document.getElementById('pollHashtagsInput').value.split(/[,\s]+/).map(s => s.trim().replace(/^#/, '')).filter(Boolean).slice(0, 10);
                const d = { title: t, question: document.getElementById('pollDescInput').value.trim(), category: getInternalCategoryName(cat), options: o, hashtags: hashtags, isMultipleChoice: isM, deadline: deadlineTs, updatedAt: serverTimestamp(), deleted: false }; 
                if (editMode) await updateDoc(doc(db, ...POLLS_PATH, editPollId), d); 
                else { Object.assign(d, { author: currentUser.displayName || 'User', authorID: currentUser.uid, createdAt: serverTimestamp(), votes: new Array(o.length).fill(0), votedUsers: [] }); await addDoc(collection(db, ...POLLS_PATH), d); } 
                document.getElementById('createModal').classList.add('hidden'); 
                window.showMessage(i18n('notice'), i18n('save_success'));
                goHome(); 
            } catch (e) { window.showMessage(i18n('notice'), e.message); } finally { saveBtn.disabled = false; } 
        };

        window.openEditPoll = function() { 
            editMode = true; editPollId = currentPollId; document.getElementById('modalTitle').textContent = i18n('edit_poll'); 
            document.getElementById('pollTitleInput').value = currentPollData.title; 
            document.getElementById('pollDescInput').value = currentPollData.question || ""; 
            document.getElementById('pollCategoryInput').value = currentPollData.category; 
            document.getElementById('pollHashtagsInput').value = (currentPollData.hashtags || []).map(h => `#${h}`).join(' '); 
            document.getElementById('pollOptionsInput').value = currentPollData.options.join('\n'); 
            document.getElementById('pollMultiChoiceInput').checked = !!currentPollData.isMultipleChoice;
            if (currentPollData.deadline) { const date = currentPollData.deadline.toDate(); const localISO = new Date(date.getTime() - (date.getTimezoneOffset() * 60000)).toISOString().slice(0, 16); document.getElementById('pollDeadlineInput').value = localISO; } else { document.getElementById('pollDeadlineInput').value = ""; }
            const dl = document.getElementById('pollDeadlineInput'); if(dl) dl.dispatchEvent(new Event('change'));
            document.getElementById('createModal').classList.remove('hidden'); 
        };

        window.closeEditCommentModal = () => { document.getElementById('editCommentModal').classList.add('hidden'); commentToEditId = null; };
        window.openEditCommentModal = (cid) => { commentToEditId = cid; document.getElementById('editCommentInput').value = currentCommentsData[cid] || ""; document.getElementById('editCommentModal').classList.remove('hidden'); };
        window.closeDeleteModal = () => document.getElementById('deleteOptionsModal').classList.add('hidden');
        window.openDeleteModal = () => { document.getElementById('permanentDeleteBtn').classList.toggle('hidden', !isAdmin); document.getElementById('deleteOptionsModal').classList.remove('hidden'); };

        // --- 6. 認証状態の監視 & イベントリスナー ---
        onAuthStateChanged(auth, async (user) => {
            currentUser = user;
            const initialLang = localStorage.getItem('mixvote_lang') || (Intl.DateTimeFormat().resolvedOptions().timeZone === 'Asia/Tokyo' ? 'ja' : 'en');
            changeLang(initialLang);
            if (user && !user.isAnonymous) { const res = await getIdTokenResult(user).catch(() => ({claims:{}})); isAdmin = !!res.claims.admin; } else { isAdmin = false; }
            const isReg = user && !user.isAnonymous;
            document.getElementById('loginBtn').style.display = isReg ? 'none' : 'flex';
            document.getElementById('userInfo').style.display = isReg ? 'flex' : 'none';
            document.getElementById('openCreateBtn').style.display = isReg ? 'flex' : 'none';
            document.getElementById('userNavGroup').classList.toggle('hidden', !isReg);
            const noticeBanner = document.getElementById('loginNoticeBanner'); if (noticeBanner) noticeBanner.classList.toggle('hidden', isReg);
            if (isReg) document.getElementById('userName').textContent = user.displayName;
            let isAgreed = false; try { isAgreed = localStorage.getItem('mixvote_agreed') === 'true'; } catch(e){}
            if (user && (isAgreed || window.sessionAgreed)) { document.getElementById('appUI').classList.remove('hidden'); document.getElementById('tosModal').classList.add('hidden'); handleNavigation(); } else if (user) { document.getElementById('tosModal').classList.remove('hidden'); document.getElementById('appUI').classList.add('hidden'); }
            window.initRealtimePolls();
        });

        // 検索と期限選択
        const searchInput = document.getElementById('globalSearch');
        if (searchInput) { let t = null; searchInput.addEventListener('input', (e) => { clearTimeout(t); t = setTimeout(() => { searchTerm = (e.target.value || "").trim(); applyFilters(); }, 150); }); }
        const dlInput = document.getElementById('pollDeadlineInput'), dlDisp = document.getElementById('deadlineDisplay');
        if (dlInput && dlDisp) { dlInput.addEventListener('change', () => { if (!dlInput.value) { dlDisp.textContent = i18n('select'); return; } const d = new Date(dlInput.value), loc = currentLang === 'ja' ? 'ja-JP' : 'en-US'; dlDisp.textContent = isNaN(d.getTime()) ? i18n('select') : d.toLocaleString(loc, { year:'numeric', month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit' }); }); }

        document.getElementById('saveCommentBtn').onclick = async () => {
            if (!commentToEditId || !currentUser || currentUser.isAnonymous) return;
            const text = document.getElementById('editCommentInput').value.trim();
            if (!text) return;
            try { await updateDoc(doc(db, ...POLLS_PATH, currentPollId, 'comments', commentToEditId), { text, updatedAt: serverTimestamp() }); window.closeEditCommentModal(); window.showMessage(i18n('notice'), i18n('comment_updated')); } catch (e) { window.showMessage(i18n('notice'), "Failed to update comment."); }
        };

        document.getElementById('agreeTosBtn').onclick = () => { try { localStorage.setItem('mixvote_agreed', 'true'); } catch(e){} window.sessionAgreed = true; document.getElementById('tosModal').classList.add('hidden'); document.getElementById('appUI').classList.remove('hidden'); goHome(); };
        document.getElementById('loginBtn').onclick = () => signInWithPopup(auth, new GoogleAuthProvider());
        document.getElementById('openCreateBtn').onclick = () => { editMode = false; document.getElementById('modalTitle').textContent = i18n('create_poll'); document.getElementById('pollTitleInput').value = ""; document.getElementById('pollDescInput').value = ""; document.getElementById('pollCategoryInput').selectedIndex = 0; document.getElementById('pollHashtagsInput').value = ""; document.getElementById('pollDeadlineInput').value = ""; document.getElementById('pollMultiChoiceInput').checked = false; document.getElementById('pollOptionsInput').value = ""; const dl = document.getElementById('pollDeadlineInput'); if(dl) dl.dispatchEvent(new Event('change')); document.getElementById('createModal').classList.remove('hidden'); };
        document.getElementById('cancelCreateBtn').onclick = () => document.getElementById('createModal').classList.add('hidden');
        document.getElementById('accentPicker').oninput = (e) => applyTheme(e.target.value, document.getElementById('bgPicker').value, document.getElementById('textPicker').value);
        document.getElementById('bgPicker').oninput = (e) => applyTheme(document.getElementById('accentPicker').value, e.target.value, document.getElementById('textPicker').value);
        document.getElementById('textPicker').oninput = (e) => applyTheme(document.getElementById('accentPicker').value, document.getElementById('bgPicker').value, e.target.value);

        window.addEventListener('hashchange', handleNavigation);
        
        // --- 初期起動 ---
        loadTheme();
        initAuth();
    </script>
</body>
</html>