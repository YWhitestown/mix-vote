<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mix Vote - 次世代投票プラットフォーム</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&family=Noto+Sans+JP:wght@400;700&display=swap');
        
        :root {
            --accent: #06b6d4;
            --accent-glow: rgba(6, 182, 212, 0.4);
            --bg-dark: #020617;
        }

        body {
            font-family: 'Plus Jakarta Sans', 'Noto Sans JP', sans-serif;
            background-color: var(--bg-dark);
            color: #f1f5f9;
            overflow-x: hidden;
        }

        /* --- UI Effects --- */
        .bg-blob {
            position: fixed;
            width: 600px;
            height: 600px;
            background: radial-gradient(circle, var(--accent-glow) 0%, rgba(2, 6, 23, 0) 70%);
            border-radius: 50%;
            z-index: -1;
            filter: blur(80px);
            animation: floatBlob 25s infinite alternate ease-in-out;
            opacity: 0.6;
        }
        .blob-1 { top: -150px; right: -150px; }
        .blob-2 { bottom: -200px; left: -200px; background: radial-gradient(circle, rgba(168, 85, 247, 0.3) 0%, rgba(2, 6, 23, 0) 70%); animation-delay: -5s; }

        @keyframes floatBlob {
            0% { transform: translate(0, 0) scale(1); }
            100% { transform: translate(50px, 50px) scale(1.1); }
        }

        .glass {
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
        }

        .glass-panel {
            background: linear-gradient(145deg, rgba(30, 41, 59, 0.4), rgba(15, 23, 42, 0.6));
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .poll-card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .poll-card:hover {
            transform: translateY(-4px);
            border-color: var(--accent);
            box-shadow: 0 10px 30px -10px var(--accent-glow);
            background: rgba(30, 41, 59, 0.8);
        }

        .btn-glow {
            position: relative;
            overflow: hidden;
        }
        .btn-glow:hover::after { left: 120%; }

        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
        
        .nav-link.active {
            background: linear-gradient(90deg, var(--accent), #3b82f6);
            color: #020617;
            box-shadow: 0 0 20px var(--accent-glow);
            border: none;
        }

        .custom-checkbox {
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        .poll-option-selected .custom-checkbox {
            background: var(--accent);
            border-color: var(--accent);
        }

        .spinner {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="min-h-screen selection:bg-cyan-500 selection:text-slate-900">

    <div class="bg-blob blob-1"></div>
    <div class="bg-blob blob-2"></div>

    <!-- 同意モーダル -->
    <div id="tosModal" class="fixed inset-0 z-[100] hidden flex items-center justify-center bg-black/90 backdrop-blur-md p-4">
        <div class="glass max-w-2xl w-full rounded-3xl p-8 shadow-2xl border border-cyan-500/20 text-center">
            <h2 class="text-2xl font-black text-white uppercase italic mb-6">Welcome to <span class="text-cyan-400">Mix Vote</span></h2>
            <div class="space-y-4 text-sm text-slate-300 mb-8 text-left max-h-[40vh] overflow-y-auto custom-scrollbar pr-2 leading-relaxed">
                <p>安全なコミュニティ維持のため、ガイドラインに同意してください。</p>
                <ul class="list-disc list-inside space-y-2">
                    <li>他者の意見を尊重し、誹謗中傷は行わないでください。</li>
                    <li>多重投票や不正なデータ操作は禁止されています。</li>
                    <li>アンケートの作成やコメントにはGoogleサインインが必要です。</li>
                    <li><strong>投票はどなたでも自由にご参加いただけます。</strong></li>
                </ul>
            </div>
            <button id="agreeTosBtn" class="btn-glow w-full bg-gradient-to-r from-cyan-500 to-blue-600 text-slate-950 font-black py-4 rounded-xl transition-all active:scale-95 uppercase tracking-widest text-xs">
                I Agree & Enter
            </button>
        </div>
    </div>

    <!-- 通知モーダル -->
    <div id="msgModal" class="fixed inset-0 z-[200] hidden flex items-center justify-center bg-black/80 backdrop-blur-sm p-4">
        <div class="glass max-w-xs w-full rounded-[24px] p-6 text-center border border-white/10 shadow-2xl">
            <h3 id="msgTitle" class="text-lg font-black mb-3 uppercase italic text-white">Notice</h3>
            <p id="msgBody" class="text-slate-400 text-xs mb-6 leading-relaxed whitespace-pre-wrap"></p>
            <div id="msgActions" class="flex gap-3 mt-4">
                <button id="msgCloseBtn" class="flex-1 bg-white/5 text-white font-bold py-3 rounded-xl uppercase text-[10px] tracking-widest hover:bg-white/10 transition-colors">Close</button>
                <button id="msgConfirmBtn" class="flex-1 bg-cyan-500 text-slate-950 font-black py-3 rounded-xl uppercase text-[10px] tracking-widest hidden hover:bg-cyan-400 transition-colors">Confirm</button>
            </div>
        </div>
    </div>

    <!-- 削除モーダル -->
    <div id="deleteOptionsModal" class="fixed inset-0 z-[250] hidden flex items-center justify-center bg-black/90 backdrop-blur-md p-4">
        <div class="glass max-w-sm w-full rounded-[32px] p-8 text-center border border-red-500/20 shadow-2xl">
            <div class="w-16 h-16 bg-red-500/10 rounded-full flex items-center justify-center mx-auto mb-6">
                <i class="fas fa-trash-alt text-red-500 text-2xl"></i>
            </div>
            <h3 class="text-xl font-black text-white italic uppercase tracking-tighter mb-2">Delete Poll</h3>
            <p class="text-slate-400 text-xs mb-8 leading-relaxed">このアンケートをどのように処理しますか？</p>
            <div class="space-y-3">
                <button onclick="confirmDeletePoll('archive')" class="w-full bg-white/5 hover:bg-white/10 text-white font-bold py-4 rounded-xl text-xs transition-all border border-white/5">アーカイブする (非表示化)</button>
                <button id="permanentDeleteBtn" onclick="confirmDeletePoll('permanent')" class="w-full bg-red-500 hover:bg-red-600 text-white font-black py-4 rounded-xl text-xs transition-all shadow-lg shadow-red-500/20 hidden">完全に削除する (管理者専用)</button>
                <button onclick="closeDeleteModal()" class="w-full bg-transparent text-slate-500 font-bold py-3 text-xs uppercase tracking-widest mt-2">キャンセル</button>
            </div>
        </div>
    </div>

    <!-- コメント編集モーダル -->
    <div id="editCommentModal" class="fixed inset-0 z-[300] hidden flex items-center justify-center bg-black/80 backdrop-blur-sm p-4">
        <div class="glass max-w-sm w-full rounded-[24px] p-6 border border-white/10 shadow-2xl">
            <h3 class="text-lg font-black mb-4 text-white uppercase italic tracking-widest">Edit Comment</h3>
            <textarea id="editCommentInput" class="w-full bg-slate-900 border border-white/10 rounded-xl p-4 text-sm text-white outline-none mb-4 focus:border-cyan-500 transition-colors" rows="3" maxlength="100"></textarea>
            <div class="flex gap-3">
                <button onclick="closeEditCommentModal()" class="flex-1 bg-white/5 text-white font-bold py-3 rounded-xl uppercase text-[10px] tracking-widest hover:bg-white/10">Cancel</button>
                <button id="saveCommentBtn" class="flex-1 bg-cyan-500 text-slate-950 font-black py-3 rounded-xl uppercase text-[10px] tracking-widest hover:bg-cyan-400">Save</button>
            </div>
        </div>
    </div>

    <!-- メインUI -->
    <div id="appUI" class="hidden flex flex-col min-h-screen">
        <header class="sticky top-0 z-50 glass border-b border-white/5 px-6 py-4 backdrop-blur-xl">
            <div class="max-w-7xl mx-auto flex items-center justify-between gap-4">
                <div class="flex items-center gap-3 cursor-pointer group shrink-0" onclick="goHome()">
                    <div class="w-10 h-10 bg-gradient-to-br from-cyan-400 to-blue-600 rounded-xl flex items-center justify-center shadow-lg shadow-cyan-500/20 group-hover:rotate-12 transition-transform text-slate-900">
                        <i class="fas fa-bolt text-xl"></i>
                    </div>
                    <div class="hidden md:block">
                        <h1 class="text-xl font-black tracking-tighter text-white uppercase italic leading-none">Mix Vote</h1>
                        <p class="text-[8px] text-slate-500 font-bold uppercase tracking-[0.2em] leading-none">Growth Edition</p>
                    </div>
                </div>

                <div class="flex-1 max-w-lg relative group">
                    <input type="text" id="globalSearch" class="w-full bg-slate-900/50 border border-white/10 rounded-2xl py-2.5 pl-10 pr-4 text-xs text-white outline-none focus:border-cyan-500/50 transition-all placeholder:text-slate-600" placeholder="Search polls by keyword...">
                    <i class="fas fa-search absolute left-3.5 top-1/2 -translate-y-1/2 text-slate-600 group-focus-within:text-cyan-400 text-xs transition-colors"></i>
                </div>

                <div id="authArea" class="shrink-0 flex items-center gap-4">
                    <button id="loginBtn" class="glass hover:bg-white/10 text-white px-5 py-2.5 rounded-xl font-bold flex items-center gap-2 border border-white/10 transition-all uppercase text-[10px] tracking-widest shadow-lg">
                        <i class="fab fa-google text-cyan-400"></i> <span class="hidden sm:inline">Sign In</span>
                    </button>
                    <div id="userInfo" class="hidden flex items-center gap-4">
                        <div class="text-right hidden sm:block">
                            <p class="text-[9px] text-slate-500 font-bold uppercase tracking-wider">Welcome</p>
                            <p id="userName" class="text-xs font-black text-white"></p>
                        </div>
                        <div class="w-8 h-8 rounded-full bg-gradient-to-r from-cyan-500 to-blue-500 flex items-center justify-center text-slate-900 font-bold text-xs shadow-lg cursor-pointer hover:scale-105 transition-transform" onclick="goCreatedPolls()"><i class="fas fa-user"></i></div>
                        <button id="logoutBtn" class="text-slate-500 hover:text-white transition-colors"><i class="fas fa-sign-out-alt"></i></button>
                    </div>
                </div>
            </div>
        </header>

        <div class="max-w-7xl mx-auto w-full px-6 grid grid-cols-1 lg:grid-cols-12 gap-8 mt-8 flex-grow">
            <!-- サイドバー -->
            <aside class="lg:col-span-3 space-y-6">
                <div class="space-y-2">
                    <button onclick="goHome()" id="navHomeBtn" class="w-full text-left px-4 py-3 rounded-xl hover:bg-white/5 text-slate-400 hover:text-white transition-all flex items-center gap-3 text-sm font-bold group">
                        <i class="fas fa-home text-slate-600 group-hover:text-cyan-400 transition-colors w-5 text-center"></i> Home
                    </button>
                    <div id="userNavGroup" class="hidden space-y-2">
                        <button onclick="goCreatedPolls()" id="navCreatedBtn" class="w-full text-left px-4 py-3 rounded-xl hover:bg-white/5 text-slate-400 hover:text-white flex items-center gap-3 text-sm font-bold group">
                            <i class="fas fa-edit text-slate-600 group-hover:text-cyan-400 w-5 text-center"></i> Created Polls
                        </button>
                        <button onclick="goVotedPolls()" id="navVotedBtn" class="w-full text-left px-4 py-3 rounded-xl hover:bg-white/5 text-slate-400 hover:text-white flex items-center gap-3 text-sm font-bold group">
                            <i class="fas fa-check-double text-slate-600 group-hover:text-cyan-400 w-5 text-center"></i> Voted Polls
                        </button>
                    </div>
                </div>

                <button id="openCreateBtn" class="btn-glow w-full bg-gradient-to-r from-cyan-500 to-blue-600 text-slate-950 font-black py-4 rounded-2xl flex items-center justify-center gap-3 shadow-xl active:scale-95 uppercase tracking-widest text-xs group">
                    <i class="fas fa-plus group-hover:rotate-90 transition-transform"></i> New Poll
                </button>

                <div class="glass rounded-3xl p-5 border border-white/5">
                    <h3 class="text-[10px] font-black uppercase tracking-[0.2em] text-slate-500 mb-4 pl-2">Categories</h3>
                    <nav id="categoryNav" class="flex lg:flex-col gap-1 overflow-x-auto lg:overflow-visible pb-2 lg:pb-0 custom-scrollbar"></nav>
                </div>

                <div class="text-[9px] text-slate-600 font-medium px-2 leading-relaxed">
                    <p>&copy; 2025 Mix Vote Project.</p>
                </div>
            </aside>

            <!-- メイン -->
            <main class="lg:col-span-9 pb-20">
                <div id="view-home" class="view-content space-y-12 animate-in fade-in duration-500">
                    <section class="space-y-10">
                        <div id="featuredPollsSection" class="space-y-6">
                            <div class="flex items-end border-l-4 border-cyan-500 pl-4">
                                <h2 id="homeSectionTitle" class="text-xl md:text-2xl font-black text-white italic uppercase tracking-tighter">Latest <span class="text-slate-600 font-normal not-italic">Polls</span></h2>
                            </div>
                            <div id="latestPollsFeatured" class="grid grid-cols-1 gap-6"></div>
                        </div>

                        <div id="morePollsSection" class="space-y-4">
                            <div class="flex items-end justify-between mb-4 border-b border-white/5 pb-2">
                                <h2 class="text-base font-black text-slate-400 italic uppercase tracking-tighter">Recent <span class="text-slate-700 font-normal not-italic text-sm">Activity</span></h2>
                            </div>
                            <div id="latestPollsMore" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
                        </div>
                    </section>
                </div>

                <div id="view-created" class="view-content hidden space-y-8"><div id="createdPollsList" class="grid grid-cols-1 md:grid-cols-2 gap-5"></div></div>
                <div id="view-voted" class="view-content hidden space-y-8"><div id="votedPollsList" class="grid grid-cols-1 md:grid-cols-2 gap-5"></div></div>

                <div id="view-detail" class="view-content hidden space-y-8 animate-in slide-in-from-bottom-4 duration-500">
                    <div class="flex items-center justify-between">
                        <button onclick="goHome()" class="text-slate-500 hover:text-white uppercase text-[10px] tracking-widest font-bold transition-all"><i class="fas fa-arrow-left"></i> Back</button>
                        <div id="adminControls" class="flex gap-2"></div>
                    </div>
                    <div id="pollDetailContent" class="glass rounded-[32px] p-8 md:p-10 border border-white/10 shadow-2xl relative overflow-hidden"></div>
                    <div class="glass rounded-[32px] p-8 border border-white/10 space-y-6">
                        <h3 class="text-lg font-black text-white flex items-center gap-3 uppercase tracking-widest"><span class="w-1.5 h-6 bg-cyan-500 rounded-full"></span> Discussion</h3>
                        <div id="commentInputArea" class="hidden relative">
                            <textarea id="commentText" maxlength="100" class="w-full bg-slate-950/50 border border-white/10 rounded-2xl p-5 text-sm text-white outline-none focus:ring-1 focus:ring-cyan-500/50 transition-all min-h-[100px]" placeholder="Share your thoughts..."></textarea>
                            <button id="postCommentBtn" class="absolute bottom-4 right-4 bg-slate-800 hover:bg-cyan-500 hover:text-slate-950 text-white px-6 py-2 rounded-xl font-bold text-xs transition-all shadow-lg">Post</button>
                        </div>
                        <div id="commentsList" class="space-y-4"></div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- 作成モーダル -->
    <div id="createModal" class="fixed inset-0 z-[100] hidden flex items-center justify-center bg-black/90 backdrop-blur-xl p-4">
        <div class="glass max-w-lg w-full rounded-[32px] p-8 shadow-2xl border border-white/10 max-h-[90vh] overflow-y-auto custom-scrollbar">
            <h2 id="modalTitle" class="text-2xl font-black mb-6 text-white uppercase italic tracking-tighter">Create Poll</h2>
            <div class="space-y-5">
                <div><label class="text-[9px] font-black text-slate-500 uppercase tracking-widest block mb-2">Title</label><input type="text" id="pollTitleInput" class="w-full bg-slate-950 border border-white/10 rounded-xl p-4 text-white text-sm outline-none transition-colors" placeholder="Your Question?"></div>
                <div><label class="text-[9px] font-black text-slate-500 uppercase tracking-widest block mb-2">Description</label><textarea id="pollDescInput" class="w-full bg-slate-950 border border-white/10 rounded-xl p-4 text-white text-sm outline-none transition-colors" rows="2" placeholder="Add some context..."></textarea></div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="text-[9px] font-black text-slate-500 uppercase tracking-widest block mb-2">Category</label><select id="pollCategoryInput" class="w-full bg-slate-950 border border-white/10 rounded-xl p-4 text-white text-sm outline-none appearance-none"></select></div>
                    <div><label class="text-[9px] font-black text-slate-500 uppercase tracking-widest block mb-2">Deadline</label><div id="deadlinePickerContainer" class="bg-slate-950 border border-white/10 rounded-xl p-4 flex justify-between items-center cursor-pointer relative"><input type="datetime-local" id="pollDeadlineInput" class="absolute inset-0 opacity-0 cursor-pointer z-10"><span id="deadlineDisplay" class="text-xs font-bold text-slate-400">Select</span><i class="far fa-clock text-cyan-500"></i></div></div>
                </div>
                <div class="bg-white/5 p-4 rounded-xl border border-white/5 flex items-center justify-between">
                    <span class="text-xs font-bold text-white">複数回答（複数選択）を許可する</span>
                    <label class="relative inline-flex items-center cursor-pointer"><input type="checkbox" id="pollMultiChoiceInput" class="sr-only peer"><div class="w-11 h-6 bg-slate-800 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-cyan-500"></div></label>
                </div>
                <div><label class="text-[9px] font-black text-slate-500 uppercase tracking-widest block mb-2">Options (One per line)</label><textarea id="pollOptionsInput" class="w-full bg-slate-950 border border-white/10 rounded-xl p-4 text-white text-sm font-mono transition-colors" rows="4" placeholder="Option 1&#10;Option 2"></textarea><p id="createOptionsHint" class="hidden text-[8px] text-cyan-400 mt-2 font-bold uppercase tracking-wider">※ 一度作成すると、後から選択肢の数を変更することはできません。</p><p id="editOptionsHint" class="hidden text-[8px] text-amber-500 mt-2 font-bold uppercase tracking-wider">※ 編集モードでは選択肢の数は変更できません。</p></div>
                <div id="quizFields" class="hidden bg-cyan-500/5 p-5 rounded-2xl border border-cyan-500/20 space-y-4">
                    <div><label class="text-[9px] font-black text-cyan-400 uppercase tracking-widest block mb-2">Correct Answer</label><select id="pollCorrectIndexInput" class="w-full bg-slate-950 border border-white/10 rounded-xl p-3 text-white text-xs"></select></div>
                    <div><label class="text-[9px] font-black text-cyan-400 uppercase tracking-widest block mb-2">Explanation</label><textarea id="pollExplanationInput" class="w-full bg-slate-950 border border-white/10 rounded-xl p-3 text-white text-xs" rows="2" placeholder="Explain why..."></textarea></div>
                </div>
            </div>
            <div class="flex gap-3 mt-8"><button id="cancelCreateBtn" class="flex-1 bg-white/5 text-white font-bold py-4 rounded-xl text-xs hover:bg-white/10 transition-colors">Cancel</button><button id="savePollBtn" class="flex-1 bg-gradient-to-r from-cyan-500 to-blue-600 text-slate-950 font-black py-4 rounded-xl text-xs shadow-lg transition-transform flex items-center justify-center gap-2"><i id="saveBtnSpinner" class="fas fa-circle-notch spinner hidden"></i><span id="saveBtnText">Save Poll</span></button></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js';
        import { getAuth, signInWithPopup, signInWithCustomToken, signInAnonymously, onAuthStateChanged, GoogleAuthProvider, getIdTokenResult } from 'https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js';
        import { getFirestore, collection, doc, getDoc, getDocs, addDoc, updateDoc, deleteDoc, onSnapshot, query, orderBy, where, serverTimestamp, arrayUnion, runTransaction, Timestamp } from 'https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js';

        const ADMIN_EMAILS = ["kurihara1229@gmail.com"];
        const firebaseConfig = { apiKey: "AIzaSyAwyi5j8EvqHL8wkyAJ48rwR8QCfS9voUE", authDomain: "mixvotesurvey.firebaseapp.com", projectId: "mixvotesurvey", storageBucket: "mixvotesurvey.firebasestorage.app", messagingSenderId: "352307389497", appId: "1:352307389497:web:0939fd29452d6c6afc59e8", measurementId: "G-ZWR5GHHL54" };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'mixvote-web';
        const POLLS_PATH = ['artifacts', appId, 'public', 'data', 'polls'];
        const CATEGORIES = ["ニュース", "エンタメ", "テクノロジー", "生活", "スポーツ", "旅行", "グルメ", "教育", "政治", "趣味", "クイズ", "あるある"];

        let currentUser = null, isAdmin = false, selectedCategory = "全て", searchTerm = "", chartInstance = null, currentPollId = null, currentPollData = null, currentChartType = 'doughnut', editMode = false, editPollId = null;
        let unsubscribePolls = null, unsubscribeCreated = null, unsubscribeVoted = null, unsubscribeComments = null, localSelectedIndices = [];
        let currentCommentsData = {}; // コメント本文保持用
        let commentToEditId = null;
        window.sessionAgreed = false;

        const escapeHTML = (s = '') => typeof s !== 'string' ? '' : s.replace(/[&<>"']/g, m => ({'&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'}[m]));
        const maskString = (s = '') => { if (!s || typeof s !== 'string') return s; const indices = [1, 4, 5, 7, 8, 9, 10]; return s.split('').map((char, i) => indices.includes(i) ? '*' : char).join(''); };

        const showMessage = (title, body, onConfirm = null) => {
            const modal = document.getElementById('msgModal');
            document.getElementById('msgTitle').textContent = title;
            document.getElementById('msgBody').textContent = body;
            const confirmBtn = document.getElementById('msgConfirmBtn');
            const closeBtn = document.getElementById('msgCloseBtn');
            if (onConfirm) {
                confirmBtn.classList.remove('hidden');
                confirmBtn.onclick = () => { onConfirm(); modal.classList.add('hidden'); };
                closeBtn.textContent = "Confirm";
            } else {
                confirmBtn.classList.add('hidden');
                closeBtn.textContent = "Close";
            }
            modal.classList.remove('hidden');
        };
        document.getElementById('msgCloseBtn').onclick = () => document.getElementById('msgModal').classList.add('hidden');

        const initAuth = async () => {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) await signInWithCustomToken(auth, __initial_auth_token).catch(() => signInAnonymously(auth));
                else await signInAnonymously(auth).catch(() => {});
            } catch (err) { await signInAnonymously(auth).catch(()=>{}); }
        };

        onAuthStateChanged(auth, async (user) => {
            currentUser = user;
            if (user && !user.isAnonymous) {
                try {
                    const res = await getIdTokenResult(user);
                    isAdmin = !!res.claims.admin || ADMIN_EMAILS.includes(user.email);
                } catch (e) { isAdmin = ADMIN_EMAILS.includes(user.email); }
            } else { isAdmin = false; }
            
            const isReg = user && !user.isAnonymous;
            document.getElementById('loginBtn').style.display = isReg ? 'none' : 'flex';
            document.getElementById('userInfo').style.display = isReg ? 'flex' : 'none';
            document.getElementById('openCreateBtn').style.display = isReg ? 'flex' : 'none';
            document.getElementById('userNavGroup').classList.toggle('hidden', !isReg);
            if (isReg) document.getElementById('userName').textContent = escapeHTML(user.displayName || "User");
            document.getElementById('commentInputArea').classList.toggle('hidden', !isReg);

            if (user && (localStorage.getItem('mixvote_agreed') || window.sessionAgreed)) {
                document.getElementById('appUI').classList.remove('hidden'); document.getElementById('tosModal').classList.add('hidden');
                setupCategoryMenu(); handleNavigation();
            } else if (user) {
                document.getElementById('tosModal').classList.remove('hidden'); document.getElementById('appUI').classList.add('hidden');
            }
        });

        const loadPolls = () => {
            if (!currentUser) return;
            if (unsubscribePolls) unsubscribePolls();
            unsubscribePolls = onSnapshot(collection(db, ...POLLS_PATH), (snapshot) => {
                let polls = snapshot.docs.map(d => ({ id: d.id, ...d.data() })).filter(p => !p.deleted);
                checkAndArchiveExpiredPolls(polls);
                if (selectedCategory !== "全て" && selectedCategory !== "人気アンケート") polls = polls.filter(p => p.category === selectedCategory);
                if (searchTerm) polls = polls.filter(p => p.title.toLowerCase().includes(searchTerm));
                
                if (selectedCategory === "人気アンケート") {
                    polls.sort((a, b) => (b.votes?.reduce((s, v) => s + v, 0) || 0) - (a.votes?.reduce((s, v) => s + v, 0) || 0));
                    document.getElementById('homeSectionTitle').innerHTML = 'Popular <span class="text-slate-600 font-normal not-italic text-lg md:text-xl">Polls</span>';
                } else {
                    polls.sort((a,b) => (b.createdAt?.seconds||0)-(a.createdAt?.seconds||0));
                    document.getElementById('homeSectionTitle').innerHTML = 'Latest <span class="text-slate-600 font-normal not-italic text-lg md:text-xl">Polls</span>';
                }
                renderHomePolls(polls);
            });
        };

        const renderHomePolls = (polls) => {
            const fC = document.getElementById('latestPollsFeatured'), mC = document.getElementById('latestPollsMore');
            fC.innerHTML = ''; mC.innerHTML = '';
            const fP = polls.slice(0, 5), mP = polls.slice(5, 55);
            if (!polls.length) { fC.innerHTML = '<p class="text-slate-700 py-10 text-center uppercase text-xs">No polls found.</p>'; return; }
            document.getElementById('morePollsSection').classList.toggle('hidden', !mP.length);

            fP.forEach(p => {
                const total = p.votes?.reduce((s,v)=>s+v,0)||0, div = document.createElement('div');
                div.className = "poll-card glass-panel rounded-[24px] p-6 md:p-8 cursor-pointer border border-white/10 hover:border-cyan-500/50 text-white flex flex-col justify-between group";
                div.onclick = () => goDetail(p.id);
                div.innerHTML = `<div class="space-y-4">
                    <span class="text-[9px] font-black px-3 py-1 rounded-full bg-cyan-500/20 text-cyan-400 uppercase tracking-widest border border-cyan-500/20">${escapeHTML(p.category)}</span>
                    <h3 class="text-lg md:text-xl font-black leading-tight group-hover:text-cyan-400 transition-colors">${escapeHTML(p.title)}</h3>
                </div>
                <div class="mt-6 pt-4 border-t border-white/5 flex justify-between items-center text-[10px] text-slate-500 font-bold uppercase tracking-widest">
                    <span>by ${escapeHTML(maskString(p.author))}</span><span>${total} Votes</span>
                </div>`;
                fC.appendChild(div);
            });
            mP.forEach(p => {
                const total = p.votes?.reduce((s,v)=>s+v,0)||0, div = document.createElement('div');
                div.className = "poll-card glass rounded-[16px] p-4 cursor-pointer border border-white/5 hover:border-cyan-500/30 text-white flex flex-col justify-between";
                div.onclick = () => goDetail(p.id);
                div.innerHTML = `<div class="space-y-2"><span class="text-[8px] font-bold text-slate-500 uppercase">${escapeHTML(p.category)}</span><h3 class="text-xs font-bold leading-snug line-clamp-2">${escapeHTML(p.title)}</h3></div>
                <div class="mt-3 text-[8px] text-slate-600 font-bold border-t border-white/5 pt-2 flex justify-between uppercase"><span>${total} V</span><span>${p.createdAt?.seconds ? new Date(p.createdAt.seconds*1000).toLocaleDateString() : ''}</span></div>`;
                mC.appendChild(div);
            });
        };

        const checkAndArchiveExpiredPolls = async (polls) => {
            if (!currentUser) return;
            const now = new Date(), oneMonth = 30 * 24 * 60 * 60 * 1000;
            const expired = polls.filter(p => p.deadline && !p.deleted && (now - p.deadline.toDate()) > oneMonth);
            for (const p of expired) {
                if (isAdmin || p.authorID === currentUser.uid) {
                    await updateDoc(doc(db, ...POLLS_PATH, p.id), { deleted: true, deletedAt: serverTimestamp(), deletedBy: "system_auto" }).catch(() => {});
                }
            }
        };

        window.goHome = () => { window.location.hash = ''; document.querySelectorAll('.view-content').forEach(v => v.classList.add('hidden')); document.getElementById('view-home').classList.remove('hidden'); setActiveNav('navHomeBtn'); loadPolls(); };
        window.goCreatedPolls = () => { if (!currentUser || currentUser.isAnonymous) return; window.location.hash = 'created'; document.querySelectorAll('.view-content').forEach(v => v.classList.add('hidden')); document.getElementById('view-created').classList.remove('hidden'); setActiveNav('navCreatedBtn'); loadFilteredPolls('created'); };
        window.goVotedPolls = () => { if (!currentUser || currentUser.isAnonymous) return; window.location.hash = 'voted'; document.querySelectorAll('.view-content').forEach(v => v.classList.add('hidden')); document.getElementById('view-voted').classList.remove('hidden'); setActiveNav('navVotedBtn'); loadFilteredPolls('voted'); };
        const goDetail = (id) => { window.location.hash = `poll/${id}`; document.querySelectorAll('.view-content').forEach(v => v.classList.add('hidden')); document.getElementById('view-detail').classList.remove('hidden'); loadPollDetail(id); };
        const handleNavigation = () => { const h = window.location.hash; if (h === '#created') goCreatedPolls(); else if (h === '#voted') goVotedPolls(); else if (h.startsWith('#poll/')) goDetail(h.replace('#poll/', '')); else goHome(); };
        const setActiveNav = (id) => { document.querySelectorAll('aside button').forEach(b => b.classList.remove('active', 'text-white')); const btn = document.getElementById(id); if (btn) btn.classList.add('active', 'text-white'); };
        window.addEventListener('hashchange', handleNavigation);

        const loadFilteredPolls = (type) => {
            const eid = type === 'created' ? 'createdPollsList' : 'votedPollsList';
            if (type === 'created' && unsubscribeCreated) unsubscribeCreated();
            if (type === 'voted' && unsubscribeVoted) unsubscribeVoted();
            const listener = onSnapshot(collection(db, ...POLLS_PATH), (s) => {
                let polls = s.docs.map(d => ({id: d.id, ...d.data()})).filter(p => !p.deleted);
                if (type === 'created') polls = polls.filter(p => p.authorID === currentUser.uid);
                else polls = polls.filter(p => p.votedUsers?.includes(currentUser.uid));
                polls.sort((a,b) => (b.createdAt?.seconds||0)-(a.createdAt?.seconds||0));
                renderPollList(eid, polls);
            });
            if (type === 'created') unsubscribeCreated = listener; else unsubscribeVoted = listener;
        };

        const renderPollList = (eid, polls) => {
            const c = document.getElementById(eid); if (!c) return;
            c.innerHTML = polls.length ? '' : '<p class="text-slate-700 py-10 text-center col-span-full text-[10px] uppercase font-bold">No polls found.</p>';
            polls.forEach(p => {
                const total = p.votes?.reduce((s,v)=>s+v,0)||0, div = document.createElement('div');
                div.className = "poll-card glass rounded-[20px] p-5 cursor-pointer border border-white/5 text-white flex flex-col justify-between";
                div.onclick = () => goDetail(p.id);
                div.innerHTML = `<div class="space-y-3"><span class="text-[8px] font-bold px-2 py-1 rounded bg-white/5 text-cyan-400 uppercase">${escapeHTML(p.category)}</span><h3 class="text-sm font-bold leading-snug">${escapeHTML(p.title)}</h3></div>
                <div class="mt-4 pt-3 border-t border-white/5 flex justify-between items-center text-[10px] text-slate-500 font-bold uppercase tracking-widest"><span>${total} Votes</span></div>`;
                c.appendChild(div);
            });
        };

        const loadPollDetail = async (id) => {
            const d = await getDoc(doc(db, ...POLLS_PATH, id)); if (!d.exists()) return goHome();
            const p = d.data(); currentPollId = id; currentPollData = p;
            const total = p.votes?.reduce((s,v)=>s+v,0)||0, hasV = p.votedUsers?.includes(currentUser.uid), isExp = p.deadline && p.deadline.toDate() < new Date();
            const canV = !hasV && !isExp, isM = p.isMultipleChoice === true;
            
            document.getElementById('adminControls').innerHTML = (isAdmin || (currentUser && p.authorID === currentUser.uid)) ? `<button onclick="openEditPoll()" class="p-2 rounded-lg glass text-cyan-400 border border-cyan-500/20"><i class="fas fa-edit"></i></button><button onclick="openDeleteModal()" class="p-2 rounded-lg glass text-red-400 border border-red-500/20"><i class="fas fa-trash"></i></button>` : '';
            
            const content = document.getElementById('pollDetailContent');
            content.innerHTML = `<div class="space-y-8">
                <div class="space-y-4">
                    <div class="flex items-center gap-3"><span class="bg-cyan-500/10 text-cyan-400 font-black text-[9px] px-3 py-1 rounded-md uppercase tracking-widest border border-cyan-500/20">${escapeHTML(p.category)}</span>${isM ? '<span class="bg-purple-500/10 text-purple-400 font-black text-[9px] px-3 py-1 rounded-md uppercase border border-purple-500/20">Multi-choice</span>':''}</div>
                    <h2 class="text-xl md:text-2xl font-black text-white leading-tight">${escapeHTML(p.title)}</h2>
                    ${p.question ? `<div class="bg-white/5 p-6 rounded-2xl text-slate-300 text-sm border border-white/5 leading-relaxed">${escapeHTML(p.question)}</div>` : ''}
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-10">
                    <div class="space-y-3">
                        ${p.options.map((opt, i) => {
                            const v = p.votes[i]||0, per = total>0?Math.round(v/total*100):0;
                            return `<div ${canV ? (isM ? `onclick="toggleLocalSelect(${i})"` : `onclick="castVote(${i})"`) : ''} id="opt-container-${i}" class="relative overflow-hidden bg-slate-900/50 border border-white/5 rounded-xl p-4 flex justify-between items-center group ${canV ? 'cursor-pointer hover:border-cyan-500/50' : ''}">
                                <div class="absolute inset-y-0 left-0 bg-cyan-500/5 transition-all duration-1000" style="width:${per}%"></div>
                                <div class="relative z-10 flex items-center gap-3">
                                    ${canV && isM ? '<div class="custom-checkbox"><i class="fas fa-check text-[10px] text-slate-900"></i></div>':''}
                                    <span class="font-bold text-sm text-slate-200">${escapeHTML(opt)}</span>
                                </div>
                                <div class="relative z-10 text-right"><div class="font-black text-white text-base">${per}%</div><div class="text-[8px] text-slate-500 uppercase font-bold">${v} votes</div></div>
                            </div>`;
                        }).join('')}
                        ${canV && isM ? '<button onclick="submitMultipleVotes()" id="submitMultiVoteBtn" style="display:none;" class="w-full bg-cyan-500 text-slate-950 font-black py-3 rounded-xl text-xs uppercase tracking-widest mt-4">Submit Votes</button>':''}
                    </div>
                    <div class="flex items-center justify-center min-h-[250px]"><canvas id="pollChart"></canvas></div>
                </div>
            </div>`;
            renderChart(p, 'doughnut'); loadComments(id);
        };

        window.castVote = async (idx) => {
            if (!currentUser) return showMessage("Auth Error", "認証の準備をしています...");
            const ref = doc(db, ...POLLS_PATH, currentPollId);
            try {
                await runTransaction(db, async (tx) => {
                    const snap = await tx.get(ref); const data = snap.data();
                    if (data.votedUsers?.includes(currentUser.uid)) throw "Already Voted";
                    const newVotes = [...data.votes]; newVotes[idx] = (newVotes[idx] || 0) + 1;
                    tx.update(ref, { votes: newVotes, votedUsers: arrayUnion(currentUser.uid), updatedAt: serverTimestamp() });
                });
                loadPollDetail(currentPollId);
            } catch (e) { if (e === "Already Voted") showMessage("Notice", "すでに投票済みです。"); }
        };

        window.toggleLocalSelect = (idx) => {
            const el = document.getElementById(`opt-container-${idx}`);
            if (localSelectedIndices.includes(idx)) {
                localSelectedIndices = localSelectedIndices.filter(i => i !== idx);
                el?.classList.remove('poll-option-selected');
            } else {
                localSelectedIndices.push(idx);
                el?.classList.add('poll-option-selected');
            }
            const btn = document.getElementById('submitMultiVoteBtn');
            if (btn) btn.style.display = localSelectedIndices.length > 0 ? 'block' : 'none';
        };

        window.submitMultipleVotes = async () => {
            if (!currentUser) return;
            const ref = doc(db, ...POLLS_PATH, currentPollId);
            try {
                await runTransaction(db, async (tx) => {
                    const snap = await tx.get(ref); const data = snap.data();
                    if (data.votedUsers?.includes(currentUser.uid)) throw "Already Voted";
                    const newVotes = [...data.votes];
                    localSelectedIndices.forEach(i => { newVotes[i] = (newVotes[i] || 0) + 1; });
                    tx.update(ref, { votes: newVotes, votedUsers: arrayUnion(currentUser.uid), updatedAt: serverTimestamp() });
                });
                localSelectedIndices = [];
                loadPollDetail(currentPollId);
            } catch (e) { if (e === "Already Voted") showMessage("Notice", "すでに投票済みです。"); }
        };

        const renderChart = (p, type) => {
            const ctx = document.getElementById('pollChart')?.getContext('2d'); if (!ctx) return;
            if (chartInstance) chartInstance.destroy();
            chartInstance = new Chart(ctx, {
                type: type, data: { labels: p.options, datasets: [{ data: p.votes, backgroundColor: ['#06b6d4', '#3b82f6', '#8b5cf6', '#ec4899', '#f59e0b', '#10b981', '#ef4444'], borderWidth: 0 }] },
                options: { responsive: true, maintainAspectRatio: false, cutout: '70%', plugins: { legend: { display: true, position: 'bottom', labels: { color: '#94a3b8', font: { size: 10, weight: 'bold' } } } } }
            });
        };

        // コメント管理
        const loadComments = (pid) => {
            if (unsubscribeComments) unsubscribeComments();
            unsubscribeComments = onSnapshot(collection(db, ...POLLS_PATH, pid, 'comments'), (s) => {
                const list = document.getElementById('commentsList'); if (!list) return;
                list.innerHTML = s.empty ? '<p class="text-center text-[10px] text-slate-700 py-6 uppercase font-bold tracking-widest">No comments yet.</p>' : '';
                currentCommentsData = {};
                s.docs.map(d => ({id: d.id, ...d.data()})).sort((a,b)=>(b.createdAt?.seconds||0)-(a.createdAt?.seconds||0)).forEach(c => {
                    currentCommentsData[c.id] = c.text;
                    const div = document.createElement('div'); div.className = "p-4 rounded-xl bg-white/5 border border-white/5 space-y-1 relative group";
                    div.innerHTML = `
                        <div class="flex justify-between items-center text-[9px] font-bold uppercase tracking-widest">
                            <span class="text-cyan-400">${escapeHTML(maskString(c.author))}</span>
                            <div class="flex items-center gap-3">
                                <span class="text-slate-600">${c.createdAt?.seconds ? new Date(c.createdAt.seconds*1000).toLocaleDateString() : ''}</span>
                                ${(isAdmin || (currentUser && c.userId === currentUser.uid)) ? `
                                    <div class="flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                                        <button onclick="openEditCommentModal('${c.id}')" class="text-slate-500 hover:text-cyan-400 transition-colors"><i class="fas fa-edit"></i></button>
                                        <button onclick="confirmDeleteComment('${c.id}')" class="text-slate-500 hover:text-red-400 transition-colors"><i class="fas fa-trash"></i></button>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                        <p class="text-xs text-slate-300 leading-relaxed pr-8">${escapeHTML(c.text)}</p>
                    `;
                    list.appendChild(div);
                });
            });
        };

        window.confirmDeleteComment = (cid) => {
            showMessage("Delete Comment?", "このコメントを削除してもよろしいですか？", async () => {
                try {
                    await deleteDoc(doc(db, ...POLLS_PATH, currentPollId, 'comments', cid));
                } catch (e) { showMessage("Error", "削除に失敗しました。"); }
            });
        };

        window.openEditCommentModal = (cid) => {
            commentToEditId = cid;
            document.getElementById('editCommentInput').value = currentCommentsData[cid] || "";
            document.getElementById('editCommentModal').classList.remove('hidden');
        };

        window.closeEditCommentModal = () => {
            document.getElementById('editCommentModal').classList.add('hidden');
            commentToEditId = null;
        };

        document.getElementById('saveCommentBtn').onclick = async () => {
            const newText = document.getElementById('editCommentInput').value.trim();
            if (!newText || !commentToEditId) return;
            try {
                await updateDoc(doc(db, ...POLLS_PATH, currentPollId, 'comments', commentToEditId), {
                    text: newText,
                    updatedAt: serverTimestamp()
                });
                closeEditCommentModal();
            } catch (e) { showMessage("Error", "更新に失敗しました。"); }
        };

        document.getElementById('postCommentBtn').onclick = async () => {
            if (!currentUser || currentUser.isAnonymous) return showMessage("Auth Required", "コメント投稿にはGoogleログインが必要です。");
            const txt = document.getElementById('commentText').value.trim();
            if (!txt) return;
            try {
                await addDoc(collection(db, ...POLLS_PATH, currentPollId, 'comments'), {
                    userId: currentUser.uid, author: currentUser.displayName || "User", text: txt, createdAt: serverTimestamp()
                });
                document.getElementById('commentText').value = '';
            } catch (e) { showMessage("Error", "Could not post comment."); }
        };

        const setupCategoryMenu = () => {
            const nav = document.getElementById('categoryNav'), select = document.getElementById('pollCategoryInput');
            if (!nav || !select) return; nav.innerHTML = ''; select.innerHTML = '';
            ["全て", "人気アンケート", ...CATEGORIES].forEach(cat => {
                const btn = document.createElement('button');
                btn.className = `nav-link px-4 py-2 rounded-xl text-[10px] font-bold uppercase tracking-widest transition-all text-left ${selectedCategory === cat ? 'active' : 'text-slate-500 hover:text-white'}`;
                btn.textContent = cat; btn.onclick = () => { selectedCategory = cat; setupCategoryMenu(); goHome(); };
                nav.appendChild(btn);
                if (cat !== "全て" && cat !== "人気アンケート") { const opt = document.createElement('option'); opt.value = cat; opt.textContent = cat; select.appendChild(opt); }
            });
        };

        const syncCorrectAnswerOptions = () => {
            const opts = document.getElementById('pollOptionsInput').value.split('\n').filter(Boolean);
            const sel = document.getElementById('pollCorrectIndexInput');
            if (sel) {
                sel.innerHTML = opts.map((o, i) => `<option value="${i}">${escapeHTML(o)}</option>`).join('');
            }
        };
        document.getElementById('pollOptionsInput').addEventListener('input', syncCorrectAnswerOptions);
        document.getElementById('pollCategoryInput').addEventListener('change', (e) => {
            document.getElementById('quizFields').classList.toggle('hidden', e.target.value !== 'クイズ');
        });

        document.getElementById('savePollBtn').onclick = async () => {
            const saveBtn = document.getElementById('savePollBtn');
            try {
                if (!currentUser || currentUser.isAnonymous) return showMessage("Auth Required", "作成にはGoogleログインが必要です。");
                const t = document.getElementById('pollTitleInput').value.trim(), o = document.getElementById('pollOptionsInput').value.split('\n').map(s=>s.trim()).filter(Boolean);
                if (!t || o.length < 2) throw new Error("タイトルと2つ以上の選択肢が必要です。");
                saveBtn.disabled = true;
                const cat = document.getElementById('pollCategoryInput').value;
                const d = { 
                    title: t, question: document.getElementById('pollDescInput').value, category: cat, options: o, updatedAt: serverTimestamp(), 
                    deadline: document.getElementById('pollDeadlineInput').value ? Timestamp.fromDate(new Date(document.getElementById('pollDeadlineInput').value)) : null,
                    isMultipleChoice: document.getElementById('pollMultiChoiceInput').checked,
                    is_quiz: cat === 'クイズ',
                    correct_index: cat === 'クイズ' ? parseInt(document.getElementById('pollCorrectIndexInput').value) : null,
                    explanation: cat === 'クイズ' ? document.getElementById('pollExplanationInput').value : ""
                };
                if (editMode) {
                    const ref = doc(db, ...POLLS_PATH, editPollId), old = (await getDoc(ref)).data();
                    if (o.length !== old.options.length) throw new Error("選択肢の数は変更できません。");
                    d.votes = o.map(newOpt => { const idx = old.options.indexOf(newOpt); return idx !== -1 ? old.votes[idx] : 0; });
                    await updateDoc(ref, d);
                } else {
                    Object.assign(d, { author: currentUser.displayName || 'User', authorID: currentUser.uid, createdAt: serverTimestamp(), votes: new Array(o.length).fill(0), votedUsers: [], deleted: false });
                    await addDoc(collection(db, ...POLLS_PATH), d);
                }
                document.getElementById('createModal').classList.add('hidden'); goHome();
            } catch (e) { showMessage("Error", e.message); } finally { saveBtn.disabled = false; }
        };

        window.openEditPoll = () => { editMode = true; editPollId = currentPollId; document.getElementById('modalTitle').textContent = "Edit Poll"; document.getElementById('pollTitleInput').value = currentPollData.title; document.getElementById('pollOptionsInput').value = currentPollData.options.join('\n'); syncCorrectAnswerOptions(); document.getElementById('createModal').classList.remove('hidden'); };
        document.getElementById('openCreateBtn').onclick = () => { editMode = false; document.getElementById('createModal').classList.remove('hidden'); };
        document.getElementById('agreeTosBtn').onclick = () => { try { localStorage.setItem('mixvote_agreed', 'true'); } catch (e) {} window.sessionAgreed = true; document.getElementById('tosModal').classList.add('hidden'); document.getElementById('appUI').classList.remove('hidden'); setupCategoryMenu(); goHome(); };
        document.getElementById('loginBtn').onclick = () => signInWithPopup(auth, new GoogleAuthProvider()).catch(() => {});
        document.getElementById('logoutBtn').onclick = () => auth.signOut().then(() => window.location.reload());
        document.getElementById('cancelCreateBtn').onclick = () => document.getElementById('createModal').classList.add('hidden');
        window.openDeleteModal = () => { document.getElementById('permanentDeleteBtn').classList.toggle('hidden', !isAdmin); document.getElementById('deleteOptionsModal').classList.remove('hidden'); };
        window.closeDeleteModal = () => document.getElementById('deleteOptionsModal').classList.add('hidden');

        initAuth();
    </script>
</body>
</html>